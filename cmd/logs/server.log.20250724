2025-07-24 08:17:45.670[33m [warning] [userconfig.go:33] [0mRedis客户端未初始化
2025-07-24 08:17:45.674[36m [info] [base.go:36] [0mRedis用户配置提供者初始化成功
2025-07-24 08:17:45.678[36m [info] [chat.go:78] [0muserconfig: {SystemPrompt: Asr:{Provider:funasr Config:map[auto_end:true chunk_interval:10 chunk_size:[5 10 5] host:192.168.5.1 max_connections:5 mode:offline port:10095 sample_rate:16000 timeout:30]} Tts:{Provider:doubao_ws Config:map[access_token:pTt18L95cTdvgpBjnefFMEXsHaXgsU1k appid:9414688178 cluster:volcano_tts use_stream:true voice:zh_female_wanwanxiaohe_moon_bigtts ws_host:openspeech.bytedance.com]} Llm:{Provider:aliyun_qwen Config:map[api_key:sk-e740417c7bdb4deab05f17439e0c60c5 base_url:https://dashscope.aliyuncs.com/compatible-mode/v1 max_token:500 model_name:qwen2.5-72b-instruct type:openai]} Vad:{Provider:webrtc_vad Config:map[pool_max_idle:100 pool_max_size:1000 pool_min_size:5 vad_mode:2 vad_sample_rate:16000]}}
2025-07-24 08:17:45.679[33m [warning] [chat.go:96] [0mredis client is nil
2025-07-24 08:17:45.680[36m [info] [manager_registry.go:41] [0m注册ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 08:17:45.682[37m [debug] [eino_llm.go:163] [0mopenaiConfig: &{APIKey:sk-e740417c7bdb4deab05f17439e0c60c5 Timeout:0s HTTPClient:<nil> ByAzure:false BaseURL:https://dashscope.aliyuncs.com/compatible-mode/v1 APIVersion: Model:qwen2.5-72b-instruct MaxTokens:<nil> Temperature:<nil> TopP:<nil> Stop:[] PresencePenalty:<nil> ResponseFormat:<nil> Seed:<nil> FrequencyPenalty:<nil> LogitBias:map[] User:<nil>}
2025-07-24 08:17:45.682[36m [info] [eino_llm.go:171] [0m成功创建OpenAI ChatModel，模型: qwen2.5-72b-instruct
2025-07-24 08:17:45.684[37m [debug] [session.go:558] [0mprocessChatText start
2025-07-24 08:17:45.685[36m [info] [session.go:134] [0m收到文本消息: {"type":"hello","version":1,"features":{"mcp":true},"transport":"websocket","audio_params":{"format":"opus","sample_rate":16000,"channels":1,"frame_duration":60}}
2025-07-24 08:17:45.718[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:17:45.764[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:17:45.765[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:17:46.056[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"qazO6HBcO5K4c_oFssjTyu70DnfeidOMOw445k9L8UQ=","type":"listen","state":"detect","text":"你好小智"}
2025-07-24 08:17:46.057[37m [debug] [llm.go:76] [0mAddTextToTTSQueue text: 你好，我是小智，有什么需要帮助的。
2025-07-24 08:17:46.058[37m [debug] [llm.go:93] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:17:46.058[36m [info] [session.go:299] [0m设备  更新音频监听状态: detect
2025-07-24 08:17:46.058[37m [debug] [llm.go:60] [0mprocessLLMResponseQueue item: {ctx:0xc00039e000 requestEinoMessages:[] responseChan:0xc0003f2f50 onStartFunc:0x12cedc0 onEndFunc:0x12ced60}
2025-07-24 08:17:46.059[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:17:46.059[37m [debug] [llm.go:178] [0mLLM 响应: {Text:你好，我是小智，有什么需要帮助的。 IsStart:true IsEnd:true ToolCalls:[]}
2025-07-24 08:17:46.062[33m [warning] [doubao_ws.go:299] [0mWebSocket连接已超时(30秒)，正在关闭并创建新连接
2025-07-24 08:17:46.068[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"qazO6HBcO5K4c_oFssjTyu70DnfeidOMOw445k9L8UQ=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:17:46.069[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:17:46.069[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:17:46.069[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:17:46.075[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 1
2025-07-24 08:17:46.076[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:17:46.076[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:17:46.076[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:17:46.077[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"qazO6HBcO5K4c_oFssjTyu70DnfeidOMOw445k9L8UQ=","type":"mcp","payload":{"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"xiaoxin-esp32s3-154-4G","version":"1.7.6"}}}}
2025-07-24 08:17:46.077[36m [info] [device_manager.go:294] [0m收到MCP服务器通知: notifications/initialized
2025-07-24 08:17:46.143[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"qazO6HBcO5K4c_oFssjTyu70DnfeidOMOw445k9L8UQ=","type":"mcp","payload":{"jsonrpc":"2.0","id":2,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 08:17:46.146[36m [info] [device_manager.go:223] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 获取工具列表成功: map[self.audio_speaker.set_volume:0xc000268e80 self.get_device_status:0xc000268e40 self.screen.set_brightness:0xc000268ec0 self.screen.set_theme:0xc000268f00]
2025-07-24 08:17:46.218[37m [debug] [doubao_ws.go:324] [0m创建新的doubao WebSocket连接，使用全局Dialer配置(读取缓冲区: 16KB，最大消息: 1MB)
2025-07-24 08:17:46.703[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:17:46.704[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:17:46.706[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 647 ms
2025-07-24 08:17:46.708[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 649 ms
2025-07-24 08:17:46.710[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1753316266710 ms
2025-07-24 08:17:46.710[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:17:46.711[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 34
2025-07-24 08:17:46.716[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 57
2025-07-24 08:17:46.717[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 75
2025-07-24 08:17:46.719[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 139
2025-07-24 08:17:47.378[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共17个片段
2025-07-24 08:17:50.560[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 08:17:50.560[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:17:50.748[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"qazO6HBcO5K4c_oFssjTyu70DnfeidOMOw445k9L8UQ=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:17:50.749[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:17:50.749[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:17:50.749[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:17:50.749[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:17:50.751[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 2
2025-07-24 08:17:50.752[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:17:50.753[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:17:50.753[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:17:50.753[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"text":"","wav_name":"stream"}
2025-07-24 08:17:50.754[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:17:50.754[37m [debug] [asr.go:40] [0masr result: , ok: true, isFinal: true
2025-07-24 08:17:50.754[37m [debug] [session.go:490] [0m处理asr结果: , 耗时: 1753316270754 ms
2025-07-24 08:17:50.754[37m [debug] [session.go:519] [0mready Restart Asr, s.clientState.Status: init
2025-07-24 08:17:51.219[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 08:17:51.294[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:17:51.354[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:17:51.386[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:17:51.446[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:17:51.519[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:17:51.584[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:17:51.643[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:17:51.699[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:17:51.771[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:17:51.833[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:17:52.055[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:17:52.204[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":625,"punc":"。","start":30,"text_seg":"你 退 下 吧","ts_list":[[30,110],[110,170],[170,330],[330,625]]}],"text":"你退下吧。","timestamp":"[[30,110],[110,170],[170,330],[330,625]]","wav_name":"stream"}
2025-07-24 08:17:52.204[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:17:52.204[37m [debug] [asr.go:40] [0masr result: 你退下吧。, ok: true, isFinal: true
2025-07-24 08:17:52.204[37m [debug] [session.go:490] [0m处理asr结果: 你退下吧。, 耗时: 149 ms
2025-07-24 08:17:52.204[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 你退下吧。
2025-07-24 08:17:52.204[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 08:17:52.204[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 08:17:52.204[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [exit_chat self.get_device_status self.audio_speaker.set_volume self.screen.set_brightness self.screen.set_theme]
2025-07-24 08:17:52.205[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: qazO6HBcO5K4c_oFssjTyu70DnfeidOMOw445k9L8UQ=, requestEinoMessages: [user: 你退下吧。]
2025-07-24 08:17:52.205[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: qazO6HBcO5K4c_oFssjTyu70DnfeidOMOw445k9L8UQ=, Type: openai
2025-07-24 08:17:52.205[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: qazO6HBcO5K4c_oFssjTyu70DnfeidOMOw445k9L8UQ=
2025-07-24 08:17:52.205[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: qazO6HBcO5K4c_oFssjTyu70DnfeidOMOw445k9L8UQ=, context状态: <nil>
2025-07-24 08:17:52.205[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:17:52.205[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:17:52.223[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: qazO6HBcO5K4c_oFssjTyu70DnfeidOMOw445k9L8UQ=, tools: [0xc00022c7b0 0xc00022c7e0 0xc00022c810 0xc00022c840 0xc00022c870]
2025-07-24 08:17:52.223[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:17:53.104[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc0002ca120 call_6724d71ddbce4b1e800d34 function {exit_chat } map[]}]
finish_reason: 
2025-07-24 08:17:53.232[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc0002ca2d8  function { {}} map[]}]
finish_reason: 
2025-07-24 08:17:53.233[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{427 12 439}
2025-07-24 08:17:53.233[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:17:53.234[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: qazO6HBcO5K4c_oFssjTyu70DnfeidOMOw445k9L8UQ=
2025-07-24 08:17:53.234[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_6724d71ddbce4b1e800d34","type":"function","function":{"name":"exit_chat","arguments":"{}"}}]}
2025-07-24 08:17:53.234[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc0002ca120 ID:call_6724d71ddbce4b1e800d34 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 08:17:53.234[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 
2025-07-24 08:17:53.234[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc0002ca120 ID:call_6724d71ddbce4b1e800d34 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]}
2025-07-24 08:17:53.236[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc0002ca120 ID:call_6724d71ddbce4b1e800d34 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 08:17:53.236[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:17:53.236[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:17:53.236[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 08:17:53.236[36m [info] [mcp_client.go:11] [0m查找工具: exit_chat (设备: 98:a3:16:d1:04:24)
2025-07-24 08:17:53.236[36m [info] [mcp_client.go:24] [0m找到本地工具: local_exit_chat
2025-07-24 08:17:53.236[36m [info] [llm.go:261] [0m进行工具调用请求: exit_chat, 参数: {}
2025-07-24 08:17:53.236[36m [info] [local_tools.go:82] [0m执行退出对话工具，参数: {}
2025-07-24 08:17:53.236[36m [info] [manager_registry.go:95] [0m通过注册表关闭设备 98:a3:16:d1:04:24 的ChatManager
2025-07-24 08:17:53.236[36m [info] [chat.go:145] [0m主动关闭断开连接, 设备 98:a3:16:d1:04:24
2025-07-24 08:17:53.236[31m [error] [websocket_conn.go:56] [0mread message error: read tcp 192.168.6.164:8989->192.168.7.45:62075: use of closed network connection
2025-07-24 08:17:53.236[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 08:17:53.236[36m [info] [manager_registry.go:51] [0m注销ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 08:17:53.236[36m [info] [device_manager.go:44] [0m设备 98:a3:16:d1:04:24 MCP客户端已移除并取消上下文
2025-07-24 08:17:53.236[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 08:17:53.236[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:17:53.237[37m [debug] [doubao_ws.go:222] [0mDoubaoWs TextToSpeechStream context done, exit
2025-07-24 08:17:53.237[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 08:17:53.237[36m [info] [local_tools.go:128] [0m设备 98:a3:16:d1:04:24 对话已退出，原因: 用户请求退出对话
2025-07-24 08:17:53.237[36m [info] [llm.go:274] [0m工具调用结果: {"device_id":"98:a3:16:d1:04:24","message":"对话已成功退出","reason":"用户请求退出对话","success":true}, 耗时: 1ms
2025-07-24 08:17:53.237[36m [info] [llm.go:279] [0m工具 exit_chat 标记为不回传结果给LLM，跳过回传
2025-07-24 08:17:53.237[36m [info] [llm.go:301] [0m所有工具都标记为不回传结果，跳过LLM处理
2025-07-24 08:17:53.237[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:17:53.237[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: qazO6HBcO5K4c_oFssjTyu70DnfeidOMOw445k9L8UQ=
2025-07-24 08:17:53.237[37m [debug] [session.go:565] [0mprocessChatText end
2025-07-24 08:17:53.237[31m [error] [tts.go:120] [0m发送 TTS 文本失败: 查询中, 请稍候, connection is closed
2025-07-24 08:17:53.237[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 08:17:53.237[31m [error] [doubao_ws.go:207] [0mMP3解码器运行失败: 创建MP3解码器失败: mp3: io: read/write on closed pipe
2025-07-24 08:17:53.238[36m [info] [session.go:134] [0m收到文本消息: 
2025-07-24 08:17:53.238[31m [error] [session.go:171] [0m解析消息失败: unexpected end of JSON input
2025-07-24 08:17:53.238[31m [error] [session.go:136] [0m处理文本消息失败: 解析消息失败: unexpected end of JSON input
2025-07-24 08:17:53.238[36m [info] [session.go:126] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 08:17:53.238[37m [debug] [session.go:147] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 08:18:45.685[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 1
2025-07-24 08:18:45.686[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 0
[36mINFO[0m[0000] pprof服务已禁用                                    [36mcaller[0m="main.go:43"
[36mINFO[0m[0000] 已设置退出对话函数                                     [36mcaller[0m="local_tools.go:147"
[36mINFO[0m[0000] UDP服务器启动在 0.0.0.0:8990                        [36mcaller[0m="udp_server.go:61"
[36mINFO[0m[0000] MQTT 服务器启动，监听 0.0.0.0:2883 地址...              [36mcaller[0m="mqtt_server.go:80"
[36mINFO[0m[0000] === MCP配置检查 ===                               [36mcaller[0m="config_checker.go:14"
[36mINFO[0m[0000] 全局MCP启用状态: true                               [36mcaller[0m="config_checker.go:18"
[36mINFO[0m[0000] 重连配置: 间隔=5秒, 最大尝试次数=10                        [36mcaller[0m="config_checker.go:28"
[36mINFO[0m[0000] 共配置了 2 个MCP服务器:                               [36mcaller[0m="config_checker.go:42"
[36mINFO[0m[0000]   [1] ✅ filesystem (URL: http://localhost:3001/sse, 启用: false)  [36mcaller[0m="config_checker.go:82"
[36mINFO[0m[0000]   [2] ✅ memory (URL: http://localhost:3002/sse, 启用: false)  [36mcaller[0m="config_checker.go:82"
[36mINFO[0m[0000] 配置检查完成: 0个服务器已启用, 0个存在问题                      [36mcaller[0m="config_checker.go:87"
[36mINFO[0m[0000] --- 设备MCP配置检查 ---                             [36mcaller[0m="config_checker.go:101"
[36mINFO[0m[0000] 设备MCP启用状态: true                               [36mcaller[0m="config_checker.go:104"
[36mINFO[0m[0000] WebSocket路径: /xiaozhi/mcp/                    [36mcaller[0m="config_checker.go:114"
[36mINFO[0m[0000] 每设备最大连接数: 5                                   [36mcaller[0m="config_checker.go:115"
[36mINFO[0m[0000] === MCP配置检查完成 ===                             [36mcaller[0m="config_checker.go:96"
[36mINFO[0m[0000] 已注册本地工具: local_exit_chat                      [36mcaller[0m="manage.go:352"
[36mINFO[0m[0000] 已注册 1 个本地工具                                   [36mcaller[0m="manage.go:355"
[36mINFO[0m[0000] 从配置中读取到 2 个MCP服务器配置                           [36mcaller[0m="manage.go:103"
[36mINFO[0m[0000] MCP服务器[1]: Name=filesystem, SSEUrl=http://localhost:3001/sse, Enabled=false  [36mcaller[0m="manage.go:107"
[36mINFO[0m[0000] MCP服务器[2]: Name=memory, SSEUrl=http://localhost:3002/sse, Enabled=false  [36mcaller[0m="manage.go:107"
[36mINFO[0m[0000] MCP服务器 filesystem 已禁用，跳过连接                    [36mcaller[0m="manage.go:122"
[36mINFO[0m[0000] MCP服务器 memory 已禁用，跳过连接                        [36mcaller[0m="manage.go:122"
[36mINFO[0m[0000] 成功连接了 0 个MCP服务器                               [36mcaller[0m="manage.go:126"
[36mINFO[0m[0000] 全局MCP管理器已启动                                   [36mcaller[0m="manage.go:131"
[36mINFO[0m[0000] WebSocket 服务器启动在 ws://0.0.0.0:8989/xiaozhi/v1/  [36mcaller[0m="websocket_server.go:100"
[36mINFO[0m[0000] MCP WebSocket 端点: ws://0.0.0.0:8989/xiaozhi/mcp/{deviceId}  [36mcaller[0m="websocket_server.go:101"
[36mINFO[0m[0000] MCP API 端点: http://0.0.0.0:8989/xiaozhi/api/mcp/tools/{deviceId}  [36mcaller[0m="websocket_server.go:102"
[36mINFO[0m[0000] MQTT已连接                                       [36mcaller[0m="mqtt_udp_adapter.go:84"
[36mINFO[0m[0000] === 收到订阅包 ===                                 [36mcaller[0m="device_hook.go:106"
[36mINFO[0m[0000] 客户端ID: xiaozhi_server                         [36mcaller[0m="device_hook.go:107"
[36mINFO[0m[0000] 包类型: 8                                        [36mcaller[0m="device_hook.go:108"
[36mINFO[0m[0000] 包ID: 1                                        [36mcaller[0m="device_hook.go:109"
[36mINFO[0m[0000] 订阅信息:                                         [36mcaller[0m="device_hook.go:112"
[36mINFO[0m[0000]   1. 主题: /p2p/device_public/#, QoS: 0         [36mcaller[0m="device_hook.go:114"
[36mINFO[0m[0000] ==================                            [36mcaller[0m="device_hook.go:118"
2025-07-24 08:21:33.811[33m [warning] [userconfig.go:33] [0mRedis客户端未初始化
2025-07-24 08:21:33.811[36m [info] [base.go:36] [0mRedis用户配置提供者初始化成功
2025-07-24 08:21:33.811[36m [info] [chat.go:78] [0muserconfig: {SystemPrompt: Asr:{Provider:funasr Config:map[auto_end:true chunk_interval:10 chunk_size:[5 10 5] host:192.168.5.1 max_connections:5 mode:offline port:10095 sample_rate:16000 timeout:30]} Tts:{Provider:doubao_ws Config:map[access_token:pTt18L95cTdvgpBjnefFMEXsHaXgsU1k appid:9414688178 cluster:volcano_tts use_stream:true voice:zh_female_wanwanxiaohe_moon_bigtts ws_host:openspeech.bytedance.com]} Llm:{Provider:aliyun_qwen Config:map[api_key:sk-e740417c7bdb4deab05f17439e0c60c5 base_url:https://dashscope.aliyuncs.com/compatible-mode/v1 max_token:500 model_name:qwen2.5-72b-instruct type:openai]} Vad:{Provider:webrtc_vad Config:map[pool_max_idle:100 pool_max_size:1000 pool_min_size:5 vad_mode:2 vad_sample_rate:16000]}}
2025-07-24 08:21:33.811[33m [warning] [llm_memory.go:35] [0mRedis客户端未初始化
2025-07-24 08:21:33.811[33m [warning] [chat.go:96] [0mredis client is nil
2025-07-24 08:21:33.811[36m [info] [manager_registry.go:41] [0m注册ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 08:21:33.811[37m [debug] [eino_llm.go:163] [0mopenaiConfig: &{APIKey:sk-e740417c7bdb4deab05f17439e0c60c5 Timeout:0s HTTPClient:<nil> ByAzure:false BaseURL:https://dashscope.aliyuncs.com/compatible-mode/v1 APIVersion: Model:qwen2.5-72b-instruct MaxTokens:<nil> Temperature:<nil> TopP:<nil> Stop:[] PresencePenalty:<nil> ResponseFormat:<nil> Seed:<nil> FrequencyPenalty:<nil> LogitBias:map[] User:<nil>}
2025-07-24 08:21:33.812[36m [info] [eino_llm.go:171] [0m成功创建OpenAI ChatModel，模型: qwen2.5-72b-instruct
2025-07-24 08:21:33.812[37m [debug] [session.go:558] [0mprocessChatText start
2025-07-24 08:21:33.836[36m [info] [session.go:134] [0m收到文本消息: {"type":"hello","version":1,"features":{"mcp":true},"transport":"websocket","audio_params":{"format":"opus","sample_rate":16000,"channels":1,"frame_duration":60}}
2025-07-24 08:21:33.848[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:33.896[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:33.896[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:21:34.228[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"vWvxl-xkNzyt9C6eeWiLcza0DZ_zHQb3X0pLdqyfPsY=","type":"listen","state":"detect","text":"你好小智"}
2025-07-24 08:21:34.228[37m [debug] [llm.go:76] [0mAddTextToTTSQueue text: 你好，我是小智，今天有啥好玩的。
2025-07-24 08:21:34.228[37m [debug] [llm.go:93] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:21:34.228[36m [info] [session.go:299] [0m设备  更新音频监听状态: detect
2025-07-24 08:21:34.228[37m [debug] [llm.go:60] [0mprocessLLMResponseQueue item: {ctx:0xc0003ffcc0 requestEinoMessages:[] responseChan:0xc00026c5b0 onStartFunc:0x12cedc0 onEndFunc:0x12ced60}
2025-07-24 08:21:34.228[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:21:34.228[37m [debug] [llm.go:178] [0mLLM 响应: {Text:你好，我是小智，今天有啥好玩的。 IsStart:true IsEnd:true ToolCalls:[]}
2025-07-24 08:21:34.238[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"vWvxl-xkNzyt9C6eeWiLcza0DZ_zHQb3X0pLdqyfPsY=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:21:34.238[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:21:34.238[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:21:34.239[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:21:34.243[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 1
2025-07-24 08:21:34.243[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:21:34.243[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:21:34.244[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:21:34.291[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"vWvxl-xkNzyt9C6eeWiLcza0DZ_zHQb3X0pLdqyfPsY=","type":"mcp","payload":{"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"xiaoxin-esp32s3-154-4G","version":"1.7.6"}}}}
2025-07-24 08:21:34.291[36m [info] [device_manager.go:294] [0m收到MCP服务器通知: notifications/initialized
2025-07-24 08:21:34.308[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"vWvxl-xkNzyt9C6eeWiLcza0DZ_zHQb3X0pLdqyfPsY=","type":"mcp","payload":{"jsonrpc":"2.0","id":2,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 08:21:34.309[36m [info] [device_manager.go:223] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 获取工具列表成功: map[self.audio_speaker.set_volume:0xc0002c13c0 self.get_device_status:0xc0002c1380 self.screen.set_brightness:0xc0002c1400 self.screen.set_theme:0xc0002c1440]
2025-07-24 08:21:34.440[37m [debug] [doubao_ws.go:324] [0m创建新的doubao WebSocket连接，使用全局Dialer配置(读取缓冲区: 16KB，最大消息: 1MB)
2025-07-24 08:21:34.818[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:21:34.819[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:21:34.819[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 591 ms
2025-07-24 08:21:34.820[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 592 ms
2025-07-24 08:21:34.820[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1753316494820 ms
2025-07-24 08:21:34.820[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:21:34.821[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 39
2025-07-24 08:21:34.935[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 84
2025-07-24 08:21:34.941[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 92
2025-07-24 08:21:34.947[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 136
2025-07-24 08:21:35.454[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共16个片段
2025-07-24 08:21:38.309[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 08:21:38.309[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:21:38.392[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"vWvxl-xkNzyt9C6eeWiLcza0DZ_zHQb3X0pLdqyfPsY=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:21:38.393[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:21:38.393[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:21:38.393[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:21:38.393[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:21:38.396[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"text":"","wav_name":"stream"}
2025-07-24 08:21:38.396[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:21:38.396[37m [debug] [asr.go:40] [0masr result: , ok: true, isFinal: true
2025-07-24 08:21:38.396[37m [debug] [session.go:490] [0m处理asr结果: , 耗时: 1753316498396 ms
2025-07-24 08:21:38.396[37m [debug] [session.go:519] [0mready Restart Asr, s.clientState.Status: init
2025-07-24 08:21:38.396[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 2
2025-07-24 08:21:38.397[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:21:38.397[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:21:38.397[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:21:38.786[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 08:21:38.843[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:38.920[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:38.982[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.036[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.070[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.144[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.205[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.266[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.326[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.401[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.461[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.492[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.551[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.628[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.685[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.765[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.804[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.880[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.959[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:39.969[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:40.104[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:40.168[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:21:40.423[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:21:40.576[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":970,"punc":"，","start":150,"text_seg":"你 退 下 吧","ts_list":[[150,350],[350,490],[490,650],[650,970]]},{"end":1425,"punc":"。","start":970,"text_seg":"刚 好","ts_list":[[970,1150],[1150,1425]]}],"text":"你退下吧，刚好。","timestamp":"[[150,350],[350,490],[490,650],[650,970],[970,1150],[1150,1425]]","wav_name":"stream"}
2025-07-24 08:21:40.576[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:21:40.577[37m [debug] [asr.go:40] [0masr result: 你退下吧，刚好。, ok: true, isFinal: true
2025-07-24 08:21:40.577[37m [debug] [session.go:490] [0m处理asr结果: 你退下吧，刚好。, 耗时: 153 ms
2025-07-24 08:21:40.577[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 你退下吧，刚好。
2025-07-24 08:21:40.577[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 08:21:40.577[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 08:21:40.577[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [self.audio_speaker.set_volume self.screen.set_brightness exit_chat self.screen.set_theme self.get_device_status]
2025-07-24 08:21:40.577[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: vWvxl-xkNzyt9C6eeWiLcza0DZ_zHQb3X0pLdqyfPsY=, requestEinoMessages: [user: 你退下吧，刚好。]
2025-07-24 08:21:40.577[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: vWvxl-xkNzyt9C6eeWiLcza0DZ_zHQb3X0pLdqyfPsY=, Type: openai
2025-07-24 08:21:40.577[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: vWvxl-xkNzyt9C6eeWiLcza0DZ_zHQb3X0pLdqyfPsY=
2025-07-24 08:21:40.577[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: vWvxl-xkNzyt9C6eeWiLcza0DZ_zHQb3X0pLdqyfPsY=, context状态: <nil>
2025-07-24 08:21:40.577[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:21:40.577[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:21:40.594[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: vWvxl-xkNzyt9C6eeWiLcza0DZ_zHQb3X0pLdqyfPsY=, tools: [0xc000197260 0xc000197290 0xc0001972c0 0xc0001972f0 0xc000197320]
2025-07-24 08:21:40.595[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:21:41.527[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc0000143d8 call_0e315c6e2abd46cc85d3a8 function {exit_chat } map[]}]
finish_reason: 
2025-07-24 08:21:41.653[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc000014478  function { {}} map[]}]
finish_reason: 
2025-07-24 08:21:41.654[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{429 12 441}
2025-07-24 08:21:41.654[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:21:41.654[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: vWvxl-xkNzyt9C6eeWiLcza0DZ_zHQb3X0pLdqyfPsY=
2025-07-24 08:21:41.655[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_0e315c6e2abd46cc85d3a8","type":"function","function":{"name":"exit_chat","arguments":"{}"}}]}
2025-07-24 08:21:41.655[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc0000143d8 ID:call_0e315c6e2abd46cc85d3a8 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 08:21:41.655[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 
2025-07-24 08:21:41.655[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc0000143d8 ID:call_0e315c6e2abd46cc85d3a8 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]}
2025-07-24 08:21:41.656[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc0000143d8 ID:call_0e315c6e2abd46cc85d3a8 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 08:21:41.656[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:21:41.656[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:21:41.656[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 08:21:41.656[36m [info] [mcp_client.go:11] [0m查找工具: exit_chat (设备: 98:a3:16:d1:04:24)
2025-07-24 08:21:41.657[36m [info] [mcp_client.go:24] [0m找到本地工具: local_exit_chat
2025-07-24 08:21:41.657[36m [info] [llm.go:261] [0m进行工具调用请求: exit_chat, 参数: {}
2025-07-24 08:21:41.657[36m [info] [local_tools.go:82] [0m执行退出对话工具，参数: {}
2025-07-24 08:21:41.657[36m [info] [manager_registry.go:95] [0m通过注册表关闭设备 98:a3:16:d1:04:24 的ChatManager
2025-07-24 08:21:41.657[36m [info] [chat.go:145] [0m主动关闭断开连接, 设备 98:a3:16:d1:04:24
2025-07-24 08:21:41.657[31m [error] [websocket_conn.go:56] [0mread message error: read tcp 192.168.6.164:8989->192.168.7.45:62076: use of closed network connection
2025-07-24 08:21:41.658[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 08:21:41.658[36m [info] [manager_registry.go:51] [0m注销ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 08:21:41.658[36m [info] [device_manager.go:44] [0m设备 98:a3:16:d1:04:24 MCP客户端已移除并取消上下文
2025-07-24 08:21:41.658[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 08:21:41.658[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:21:41.660[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 08:21:41.660[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 08:21:41.660[36m [info] [local_tools.go:128] [0m设备 98:a3:16:d1:04:24 对话已退出，原因: 用户请求退出对话
2025-07-24 08:21:41.660[36m [info] [llm.go:274] [0m工具调用结果: {"device_id":"98:a3:16:d1:04:24","message":"对话已成功退出","reason":"用户请求退出对话","success":true}, 耗时: 3ms
2025-07-24 08:21:41.660[36m [info] [llm.go:279] [0m工具 exit_chat 标记为不回传结果给LLM，跳过回传
2025-07-24 08:21:41.660[36m [info] [llm.go:301] [0m所有工具都标记为不回传结果，跳过LLM处理
2025-07-24 08:21:41.660[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:21:41.660[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: vWvxl-xkNzyt9C6eeWiLcza0DZ_zHQb3X0pLdqyfPsY=
2025-07-24 08:21:41.660[37m [debug] [session.go:565] [0mprocessChatText end
2025-07-24 08:21:41.660[31m [error] [tts.go:120] [0m发送 TTS 文本失败: 查询中, 请稍候, connection is closed
2025-07-24 08:21:41.660[36m [info] [session.go:134] [0m收到文本消息: 
2025-07-24 08:21:41.660[31m [error] [session.go:171] [0m解析消息失败: unexpected end of JSON input
2025-07-24 08:21:41.660[31m [error] [session.go:136] [0m处理文本消息失败: 解析消息失败: unexpected end of JSON input
2025-07-24 08:21:41.661[36m [info] [session.go:126] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 08:21:41.661[37m [debug] [session.go:147] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 08:21:41.661[37m [debug] [doubao_ws.go:222] [0mDoubaoWs TextToSpeechStream context done, exit
2025-07-24 08:21:41.661[31m [error] [doubao_ws.go:207] [0mMP3解码器运行失败: 创建MP3解码器失败: mp3: io: read/write on closed pipe
2025-07-24 08:22:33.814[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 1
2025-07-24 08:22:33.814[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 0
[36mINFO[0m[0000] pprof服务已禁用                                    [36mcaller[0m="main.go:43"
[36mINFO[0m[0000] 已设置退出对话函数                                     [36mcaller[0m="local_tools.go:147"
[36mINFO[0m[0000] UDP服务器启动在 0.0.0.0:8990                        [36mcaller[0m="udp_server.go:61"
[36mINFO[0m[0000] MQTT 服务器启动，监听 0.0.0.0:2883 地址...              [36mcaller[0m="mqtt_server.go:80"
[36mINFO[0m[0000] === MCP配置检查 ===                               [36mcaller[0m="config_checker.go:14"
[36mINFO[0m[0000] 全局MCP启用状态: true                               [36mcaller[0m="config_checker.go:18"
[36mINFO[0m[0000] 重连配置: 间隔=5秒, 最大尝试次数=10                        [36mcaller[0m="config_checker.go:28"
[36mINFO[0m[0000] 共配置了 2 个MCP服务器:                               [36mcaller[0m="config_checker.go:42"
[36mINFO[0m[0000]   [1] ✅ filesystem (URL: http://localhost:3001/sse, 启用: false)  [36mcaller[0m="config_checker.go:82"
[36mINFO[0m[0000]   [2] ✅ memory (URL: http://localhost:3002/sse, 启用: false)  [36mcaller[0m="config_checker.go:82"
[36mINFO[0m[0000] 配置检查完成: 0个服务器已启用, 0个存在问题                      [36mcaller[0m="config_checker.go:87"
[36mINFO[0m[0000] --- 设备MCP配置检查 ---                             [36mcaller[0m="config_checker.go:101"
[36mINFO[0m[0000] 设备MCP启用状态: true                               [36mcaller[0m="config_checker.go:104"
[36mINFO[0m[0000] WebSocket路径: /xiaozhi/mcp/                    [36mcaller[0m="config_checker.go:114"
[36mINFO[0m[0000] 每设备最大连接数: 5                                   [36mcaller[0m="config_checker.go:115"
[36mINFO[0m[0000] === MCP配置检查完成 ===                             [36mcaller[0m="config_checker.go:96"
[36mINFO[0m[0000] 已注册本地工具: local_exit_chat                      [36mcaller[0m="manage.go:352"
[36mINFO[0m[0000] 已注册 1 个本地工具                                   [36mcaller[0m="manage.go:355"
[36mINFO[0m[0000] 从配置中读取到 2 个MCP服务器配置                           [36mcaller[0m="manage.go:103"
[36mINFO[0m[0000] MCP服务器[1]: Name=filesystem, SSEUrl=http://localhost:3001/sse, Enabled=false  [36mcaller[0m="manage.go:107"
[36mINFO[0m[0000] MCP服务器[2]: Name=memory, SSEUrl=http://localhost:3002/sse, Enabled=false  [36mcaller[0m="manage.go:107"
[36mINFO[0m[0000] MCP服务器 filesystem 已禁用，跳过连接                    [36mcaller[0m="manage.go:122"
[36mINFO[0m[0000] MCP服务器 memory 已禁用，跳过连接                        [36mcaller[0m="manage.go:122"
[36mINFO[0m[0000] 成功连接了 0 个MCP服务器                               [36mcaller[0m="manage.go:126"
[36mINFO[0m[0000] 全局MCP管理器已启动                                   [36mcaller[0m="manage.go:131"
[36mINFO[0m[0000] WebSocket 服务器启动在 ws://0.0.0.0:8989/xiaozhi/v1/  [36mcaller[0m="websocket_server.go:100"
[36mINFO[0m[0000] MCP WebSocket 端点: ws://0.0.0.0:8989/xiaozhi/mcp/{deviceId}  [36mcaller[0m="websocket_server.go:101"
[36mINFO[0m[0000] MCP API 端点: http://0.0.0.0:8989/xiaozhi/api/mcp/tools/{deviceId}  [36mcaller[0m="websocket_server.go:102"
[36mINFO[0m[0000] MQTT已连接                                       [36mcaller[0m="mqtt_udp_adapter.go:84"
[36mINFO[0m[0000] === 收到订阅包 ===                                 [36mcaller[0m="device_hook.go:106"
[36mINFO[0m[0000] 客户端ID: xiaozhi_server                         [36mcaller[0m="device_hook.go:107"
[36mINFO[0m[0000] 包类型: 8                                        [36mcaller[0m="device_hook.go:108"
[36mINFO[0m[0000] 包ID: 1                                        [36mcaller[0m="device_hook.go:109"
[36mINFO[0m[0000] 订阅信息:                                         [36mcaller[0m="device_hook.go:112"
[36mINFO[0m[0000]   1. 主题: /p2p/device_public/#, QoS: 0         [36mcaller[0m="device_hook.go:114"
[36mINFO[0m[0000] ==================                            [36mcaller[0m="device_hook.go:118"
2025-07-24 08:41:53.884[33m [warning] [userconfig.go:33] [0mRedis客户端未初始化
2025-07-24 08:41:53.885[36m [info] [base.go:36] [0mRedis用户配置提供者初始化成功
2025-07-24 08:41:53.885[36m [info] [chat.go:78] [0muserconfig: {SystemPrompt: Asr:{Provider:funasr Config:map[auto_end:true chunk_interval:10 chunk_size:[5 10 5] host:192.168.5.1 max_connections:5 mode:offline port:10095 sample_rate:16000 timeout:30]} Tts:{Provider:doubao_ws Config:map[access_token:pTt18L95cTdvgpBjnefFMEXsHaXgsU1k appid:9414688178 cluster:volcano_tts use_stream:true voice:zh_female_wanwanxiaohe_moon_bigtts ws_host:openspeech.bytedance.com]} Llm:{Provider:aliyun_qwen Config:map[api_key:sk-e740417c7bdb4deab05f17439e0c60c5 base_url:https://dashscope.aliyuncs.com/compatible-mode/v1 max_token:500 model_name:qwen2.5-72b-instruct type:openai]} Vad:{Provider:webrtc_vad Config:map[pool_max_idle:100 pool_max_size:1000 pool_min_size:5 vad_mode:2 vad_sample_rate:16000]}}
2025-07-24 08:41:53.885[33m [warning] [llm_memory.go:35] [0mRedis客户端未初始化
2025-07-24 08:41:53.885[33m [warning] [chat.go:96] [0mredis client is nil
2025-07-24 08:41:53.885[36m [info] [manager_registry.go:41] [0m注册ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 08:41:53.886[37m [debug] [eino_llm.go:163] [0mopenaiConfig: &{APIKey:sk-e740417c7bdb4deab05f17439e0c60c5 Timeout:0s HTTPClient:<nil> ByAzure:false BaseURL:https://dashscope.aliyuncs.com/compatible-mode/v1 APIVersion: Model:qwen2.5-72b-instruct MaxTokens:<nil> Temperature:<nil> TopP:<nil> Stop:[] PresencePenalty:<nil> ResponseFormat:<nil> Seed:<nil> FrequencyPenalty:<nil> LogitBias:map[] User:<nil>}
2025-07-24 08:41:53.886[36m [info] [eino_llm.go:171] [0m成功创建OpenAI ChatModel，模型: qwen2.5-72b-instruct
2025-07-24 08:41:53.886[37m [debug] [session.go:558] [0mprocessChatText start
2025-07-24 08:41:53.997[36m [info] [session.go:134] [0m收到文本消息: {"type":"hello","version":1,"features":{"mcp":true},"transport":"websocket","audio_params":{"format":"opus","sample_rate":16000,"channels":1,"frame_duration":60}}
2025-07-24 08:41:54.009[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:54.013[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:54.014[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:41:54.151[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"3_D-aBbR5t2RhqrdtvEgpYwqZYikUkgpQ4rE_6YvUkk=","type":"listen","state":"detect","text":"你好小智"}
2025-07-24 08:41:54.151[37m [debug] [llm.go:76] [0mAddTextToTTSQueue text: 你好，我是小智，今天有啥好玩的。
2025-07-24 08:41:54.151[37m [debug] [llm.go:93] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:41:54.152[36m [info] [session.go:299] [0m设备  更新音频监听状态: detect
2025-07-24 08:41:54.152[37m [debug] [llm.go:60] [0mprocessLLMResponseQueue item: {ctx:0xc00037cbe0 requestEinoMessages:[] responseChan:0xc00024e700 onStartFunc:0x12cedc0 onEndFunc:0x12ced60}
2025-07-24 08:41:54.152[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:41:54.152[37m [debug] [llm.go:178] [0mLLM 响应: {Text:你好，我是小智，今天有啥好玩的。 IsStart:true IsEnd:true ToolCalls:[]}
2025-07-24 08:41:54.164[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"3_D-aBbR5t2RhqrdtvEgpYwqZYikUkgpQ4rE_6YvUkk=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:41:54.164[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:41:54.164[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:41:54.164[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:41:54.375[37m [debug] [doubao_ws.go:324] [0m创建新的doubao WebSocket连接，使用全局Dialer配置(读取缓冲区: 16KB，最大消息: 1MB)
2025-07-24 08:41:54.779[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:41:54.780[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:41:54.782[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 630 ms
2025-07-24 08:41:54.782[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 630 ms
2025-07-24 08:41:54.783[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1753317714783 ms
2025-07-24 08:41:54.784[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:41:54.785[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 36
2025-07-24 08:41:54.792[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 63
2025-07-24 08:41:54.794[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 84
2025-07-24 08:41:54.795[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 135
2025-07-24 08:41:55.395[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共18个片段
2025-07-24 08:41:58.155[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 08:41:58.155[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:41:58.831[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 08:41:58.893[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:58.965[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:58.995[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.051[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.115[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.188[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.254[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.314[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.369[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.444[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.476[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.531[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.591[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.668[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.727[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.791[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.850[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.924[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:41:59.951[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:42:00.028[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:42:00.077[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:42:00.147[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:42:00.206[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:42:00.269[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:42:00.326[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:42:00.412[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:42:00.437[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:42:00.493[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:42:00.552[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:42:00.807[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:42:05.174[31m [error] [asr.go:187] [0m重启ASR流式识别失败: 连接到FunASR服务失败: unexpected EOF
2025-07-24 08:42:05.175[31m [error] [session.go:456] [0masr流式识别失败: 重启ASR流式识别失败: 连接到FunASR服务失败: unexpected EOF
2025-07-24 08:42:05.175[31m [error] [websocket_conn.go:56] [0mread message error: read tcp 192.168.6.164:8989->192.168.7.45:62077: use of closed network connection
2025-07-24 08:42:05.175[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 08:42:05.175[36m [info] [manager_registry.go:51] [0m注销ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 08:42:05.175[36m [info] [device_manager.go:44] [0m设备 98:a3:16:d1:04:24 MCP客户端已移除并取消上下文
2025-07-24 08:42:05.175[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 08:42:05.175[37m [debug] [session.go:458] [0mOnListenStart end
2025-07-24 08:42:05.175[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:42:05.175[36m [info] [session.go:126] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 08:42:05.175[37m [debug] [session.go:147] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 08:42:05.175[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 08:42:05.175[37m [debug] [session.go:565] [0mprocessChatText end
2025-07-24 08:42:09.002[31m [error] [device_manager.go:219] [0m获取工具列表失败: client not initialized
2025-07-24 08:42:09.003[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 08:44:11.427[33m [warning] [userconfig.go:33] [0mRedis客户端未初始化
2025-07-24 08:44:11.427[36m [info] [base.go:36] [0mRedis用户配置提供者初始化成功
2025-07-24 08:44:11.427[36m [info] [chat.go:78] [0muserconfig: {SystemPrompt: Asr:{Provider:funasr Config:map[auto_end:true chunk_interval:10 chunk_size:[5 10 5] host:192.168.5.1 max_connections:5 mode:offline port:10095 sample_rate:16000 timeout:30]} Tts:{Provider:doubao_ws Config:map[access_token:pTt18L95cTdvgpBjnefFMEXsHaXgsU1k appid:9414688178 cluster:volcano_tts use_stream:true voice:zh_female_wanwanxiaohe_moon_bigtts ws_host:openspeech.bytedance.com]} Llm:{Provider:aliyun_qwen Config:map[api_key:sk-e740417c7bdb4deab05f17439e0c60c5 base_url:https://dashscope.aliyuncs.com/compatible-mode/v1 max_token:500 model_name:qwen2.5-72b-instruct type:openai]} Vad:{Provider:webrtc_vad Config:map[pool_max_idle:100 pool_max_size:1000 pool_min_size:5 vad_mode:2 vad_sample_rate:16000]}}
2025-07-24 08:44:11.427[33m [warning] [chat.go:96] [0mredis client is nil
2025-07-24 08:44:11.428[36m [info] [manager_registry.go:41] [0m注册ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 08:44:11.428[37m [debug] [eino_llm.go:163] [0mopenaiConfig: &{APIKey:sk-e740417c7bdb4deab05f17439e0c60c5 Timeout:0s HTTPClient:<nil> ByAzure:false BaseURL:https://dashscope.aliyuncs.com/compatible-mode/v1 APIVersion: Model:qwen2.5-72b-instruct MaxTokens:<nil> Temperature:<nil> TopP:<nil> Stop:[] PresencePenalty:<nil> ResponseFormat:<nil> Seed:<nil> FrequencyPenalty:<nil> LogitBias:map[] User:<nil>}
2025-07-24 08:44:11.428[36m [info] [eino_llm.go:171] [0m成功创建OpenAI ChatModel，模型: qwen2.5-72b-instruct
2025-07-24 08:44:11.428[37m [debug] [session.go:558] [0mprocessChatText start
2025-07-24 08:44:11.449[36m [info] [session.go:134] [0m收到文本消息: {"type":"hello","version":1,"features":{"mcp":true},"transport":"websocket","audio_params":{"format":"opus","sample_rate":16000,"channels":1,"frame_duration":60}}
2025-07-24 08:44:11.488[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:11.531[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:11.532[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:44:11.838[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"_2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=","type":"listen","state":"detect","text":"你好小智"}
2025-07-24 08:44:11.838[37m [debug] [llm.go:76] [0mAddTextToTTSQueue text: 你好，我是小智，今天有啥好玩的。
2025-07-24 08:44:11.838[37m [debug] [llm.go:93] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:44:11.838[36m [info] [session.go:299] [0m设备  更新音频监听状态: detect
2025-07-24 08:44:11.838[37m [debug] [llm.go:60] [0mprocessLLMResponseQueue item: {ctx:0xc00037c000 requestEinoMessages:[] responseChan:0xc000280230 onStartFunc:0x12cedc0 onEndFunc:0x12ced60}
2025-07-24 08:44:11.838[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:44:11.839[37m [debug] [llm.go:178] [0mLLM 响应: {Text:你好，我是小智，今天有啥好玩的。 IsStart:true IsEnd:true ToolCalls:[]}
2025-07-24 08:44:11.839[33m [warning] [doubao_ws.go:299] [0mWebSocket连接已超时(30秒)，正在关闭并创建新连接
2025-07-24 08:44:11.844[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"_2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:44:11.845[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:44:11.845[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:44:11.845[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:44:11.852[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 1
2025-07-24 08:44:11.853[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:44:11.853[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:44:11.853[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:44:11.853[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"_2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=","type":"mcp","payload":{"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"xiaoxin-esp32s3-154-4G","version":"1.7.6"}}}}
2025-07-24 08:44:11.854[36m [info] [device_manager.go:294] [0m收到MCP服务器通知: notifications/initialized
2025-07-24 08:44:11.875[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"_2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=","type":"mcp","payload":{"jsonrpc":"2.0","id":2,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 08:44:11.876[36m [info] [device_manager.go:223] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 获取工具列表成功: map[self.audio_speaker.set_volume:0xc0004d5180 self.get_device_status:0xc0004d5140 self.screen.set_brightness:0xc0004d51c0 self.screen.set_theme:0xc0004d5200]
2025-07-24 08:44:11.990[37m [debug] [doubao_ws.go:324] [0m创建新的doubao WebSocket连接，使用全局Dialer配置(读取缓冲区: 16KB，最大消息: 1MB)
2025-07-24 08:44:12.434[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:44:12.434[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:44:12.434[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 595 ms
2025-07-24 08:44:12.435[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 596 ms
2025-07-24 08:44:12.435[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1753317852435 ms
2025-07-24 08:44:12.435[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:44:12.437[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 37
2025-07-24 08:44:12.455[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 63
2025-07-24 08:44:12.456[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 87
2025-07-24 08:44:12.458[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 143
2025-07-24 08:44:13.025[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共16个片段
2025-07-24 08:44:15.820[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 08:44:15.820[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:44:15.978[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"_2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:44:15.979[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:44:15.979[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:44:15.979[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:44:15.979[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:44:15.981[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 2
2025-07-24 08:44:15.982[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:44:15.982[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:44:15.982[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:44:15.982[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"text":"","wav_name":"stream"}
2025-07-24 08:44:15.982[37m [debug] [funasr.go:328] [0mfunasr recvResult 已取消: context canceled
2025-07-24 08:44:15.982[37m [debug] [asr.go:40] [0masr result: , ok: false, isFinal: false
2025-07-24 08:44:15.982[37m [debug] [asr.go:47] [0masr result channel closed
2025-07-24 08:44:15.982[37m [debug] [session.go:490] [0m处理asr结果: , 耗时: 1753317855982 ms
2025-07-24 08:44:15.982[37m [debug] [session.go:519] [0mready Restart Asr, s.clientState.Status: init
2025-07-24 08:44:16.297[36m [info] [asr.go:112] [0m检测到语音, len: 2880
2025-07-24 08:44:16.373[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:16.432[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:16.491[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:16.551[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:16.594[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:16.656[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:16.715[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:16.783[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:16.848[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:16.912[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:16.975[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:17.028[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:17.073[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:17.159[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:17.194[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:17.452[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:44:17.554[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":835,"punc":"。","start":30,"text_seg":"讲 个 故 事 吧","ts_list":[[30,130],[130,250],[250,350],[350,450],[450,835]]}],"text":"讲个故事吧。","timestamp":"[[30,130],[130,250],[250,350],[350,450],[450,835]]","wav_name":"stream"}
2025-07-24 08:44:17.554[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:44:17.554[37m [debug] [asr.go:40] [0masr result: 讲个故事吧。, ok: true, isFinal: true
2025-07-24 08:44:17.554[37m [debug] [session.go:490] [0m处理asr结果: 讲个故事吧。, 耗时: 102 ms
2025-07-24 08:44:17.554[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 讲个故事吧。
2025-07-24 08:44:17.555[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 08:44:17.555[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 08:44:17.555[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [exit_chat self.get_device_status self.audio_speaker.set_volume self.screen.set_brightness self.screen.set_theme]
2025-07-24 08:44:17.555[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=, requestEinoMessages: [user: 讲个故事吧。]
2025-07-24 08:44:17.555[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=, Type: openai
2025-07-24 08:44:17.555[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=
2025-07-24 08:44:17.555[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=, context状态: <nil>
2025-07-24 08:44:17.555[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:44:17.555[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:44:17.565[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=, tools: [0xc000117d40 0xc000117d70 0xc000117e60 0xc000117e90 0xc000117ec0]
2025-07-24 08:44:17.566[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:44:18.034[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 当然
finish_reason: 
2025-07-24 08:44:18.035[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"当然","response_meta":{}}
2025-07-24 08:44:18.054[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 可以
finish_reason: 
2025-07-24 08:44:18.054[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"可以","response_meta":{}}
2025-07-24 08:44:18.074[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，
finish_reason: 
2025-07-24 08:44:18.074[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"，","response_meta":{}}
2025-07-24 08:44:18.075[36m [info] [llm.go:107] [0m耗时统计: llm工具首句: 520 ms
2025-07-24 08:44:18.075[36m [info] [llm.go:109] [0m处理完整句子: 当然可以，
2025-07-24 08:44:18.094[37m [debug] [llm.go:178] [0mLLM 响应: {Text:当然可以， IsStart:true IsEnd:false ToolCalls:[]}
2025-07-24 08:44:18.094[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:44:18.156[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 下面是一个简短
finish_reason: 
2025-07-24 08:44:18.157[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"下面是一个简短","response_meta":{}}
2025-07-24 08:44:18.259[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 的故事：

在遥远
finish_reason: 
2025-07-24 08:44:18.259[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"的故事：\n\n在遥远","response_meta":{}}
2025-07-24 08:44:18.259[36m [info] [llm.go:109] [0m处理完整句子: 下面是一个简短的故事：
2025-07-24 08:44:18.341[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 的地方有一个小村庄
finish_reason: 
2025-07-24 08:44:18.343[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"的地方有一个小村庄","response_meta":{}}
2025-07-24 08:44:18.446[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，那里的人们
finish_reason: 
2025-07-24 08:44:18.447[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"，那里的人们","response_meta":{}}
2025-07-24 08:44:18.488[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 生活得很幸福，
finish_reason: 
2025-07-24 08:44:18.489[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"生活得很幸福，","response_meta":{}}
2025-07-24 08:44:18.532[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:44:18.532[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:44:18.532[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 438 ms
2025-07-24 08:44:18.533[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 439 ms
2025-07-24 08:44:18.533[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 979 ms
2025-07-24 08:44:18.533[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:44:18.550[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 因为他们的村长
finish_reason: 
2025-07-24 08:44:18.552[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 37
2025-07-24 08:44:18.553[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 53
2025-07-24 08:44:18.554[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 71
2025-07-24 08:44:18.555[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 146
2025-07-24 08:44:18.560[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"因为他们的村长","response_meta":{}}
2025-07-24 08:44:18.741[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共8个片段
2025-07-24 08:44:18.791[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 是一位非常聪明和
finish_reason: 
2025-07-24 08:44:18.792[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"是一位非常聪明和","response_meta":{}}
2025-07-24 08:44:18.866[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 善良的人。这位
finish_reason: 
2025-07-24 08:44:18.868[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"善良的人。这位","response_meta":{}}
2025-07-24 08:44:18.868[36m [info] [llm.go:109] [0m处理完整句子: 在遥远的地方有一个小村庄，那里的人们生活得很幸福，因为他们的村长是一位非常聪明和善良的人。
2025-07-24 08:44:18.971[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 村长名叫阿
finish_reason: 
2025-07-24 08:44:18.971[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"村长名叫阿","response_meta":{}}
2025-07-24 08:44:19.024[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 明，他总是
finish_reason: 
2025-07-24 08:44:19.024[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"明，他总是","response_meta":{}}
2025-07-24 08:44:19.089[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 能够找到解决村民
finish_reason: 
2025-07-24 08:44:19.089[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"能够找到解决村民","response_meta":{}}
2025-07-24 08:44:19.163[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 问题的方法，并且
finish_reason: 
2025-07-24 08:44:19.164[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"问题的方法，并且","response_meta":{}}
2025-07-24 08:44:19.215[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 他乐于助
finish_reason: 
2025-07-24 08:44:19.215[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"他乐于助","response_meta":{}}
2025-07-24 08:44:19.290[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 人，深受大家
finish_reason: 
2025-07-24 08:44:19.292[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"人，深受大家","response_meta":{}}
2025-07-24 08:44:19.353[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 的爱戴。
finish_reason: 
2025-07-24 08:44:19.353[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"的爱戴。","response_meta":{}}
2025-07-24 08:44:19.353[36m [info] [llm.go:109] [0m处理完整句子: 这位村长名叫阿明，他总是能够找到解决村民问题的方法，并且他乐于助人，深受大家的爱戴。
2025-07-24 08:44:19.465[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 

有一天，村庄附近
finish_reason: 
2025-07-24 08:44:19.498[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 的一条河突然
finish_reason: 
2025-07-24 08:44:19.571[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 泛滥，河水
finish_reason: 
2025-07-24 08:44:19.577[37m [debug] [llm.go:178] [0mLLM 响应: {Text:下面是一个简短的故事： IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 08:44:19.578[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:44:19.579[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"\n\n有一天，村庄附近","response_meta":{}}
2025-07-24 08:44:19.580[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"的一条河突然","response_meta":{}}
2025-07-24 08:44:19.580[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"泛滥，河水","response_meta":{}}
2025-07-24 08:44:19.689[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 冲毁了农田
finish_reason: 
2025-07-24 08:44:19.690[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"冲毁了农田","response_meta":{}}
2025-07-24 08:44:19.762[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，许多家庭因此
finish_reason: 
2025-07-24 08:44:19.762[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"，许多家庭因此","response_meta":{}}
2025-07-24 08:44:19.877[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 失去了粮食来源。
finish_reason: 
2025-07-24 08:44:19.878[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"失去了粮食来源。","response_meta":{}}
2025-07-24 08:44:19.879[36m [info] [llm.go:109] [0m处理完整句子: 有一天，村庄附近的一条河突然泛滥，河水冲毁了农田，许多家庭因此失去了粮食来源。
2025-07-24 08:44:19.902[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 村民们非常焦急，
finish_reason: 
2025-07-24 08:44:20.006[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:44:20.007[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:44:20.007[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 429 ms
2025-07-24 08:44:20.008[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 430 ms
2025-07-24 08:44:20.009[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:44:20.010[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 40
2025-07-24 08:44:20.011[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 不知道该如何是好
finish_reason: 
2025-07-24 08:44:20.047[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 。阿明了解
finish_reason: 
2025-07-24 08:44:20.120[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 情况后，立刻
finish_reason: 
2025-07-24 08:44:20.133[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 43
2025-07-24 08:44:20.136[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 118
2025-07-24 08:44:20.137[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 127
2025-07-24 08:44:20.226[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 组织了一次会议，
finish_reason: 
2025-07-24 08:44:20.398[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 号召大家齐心
finish_reason: 
2025-07-24 08:44:20.407[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共12个片段
2025-07-24 08:44:20.472[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 协力解决问题。
finish_reason: 
2025-07-24 08:44:20.585[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 

在会议上，阿
finish_reason: 
2025-07-24 08:44:20.620[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 明提出了一个计划
finish_reason: 
2025-07-24 08:44:20.725[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ：修建一条新的
finish_reason: 
2025-07-24 08:44:20.765[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 水渠，将
finish_reason: 
2025-07-24 08:44:20.898[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 多余的河水引导到
finish_reason: 
2025-07-24 08:44:21.005[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 需要灌溉的田
finish_reason: 
2025-07-24 08:44:21.044[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 地，这样不仅可以
finish_reason: 
2025-07-24 08:44:21.168[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 防止洪水再次发生
finish_reason: 
2025-07-24 08:44:21.191[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，还可以利用河水
finish_reason: 
2025-07-24 08:44:21.336[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 增加农作物的产量
finish_reason: 
2025-07-24 08:44:21.576[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 。这个想法得到了
finish_reason: 
2025-07-24 08:44:21.685[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 所有人的支持，
finish_reason: 
2025-07-24 08:44:21.724[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 村民们开始共同努力，
finish_reason: 
2025-07-24 08:44:21.881[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 不分昼夜地工作
finish_reason: 
2025-07-24 08:44:21.886[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 。

几个月后，
finish_reason: 
2025-07-24 08:44:21.949[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 水渠建成了
finish_reason: 
2025-07-24 08:44:22.059[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，效果非常好。
finish_reason: 
2025-07-24 08:44:22.094[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 不仅解决了洪水的问题
finish_reason: 
2025-07-24 08:44:22.200[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，而且由于充足的
finish_reason: 
2025-07-24 08:44:22.238[37m [debug] [llm.go:178] [0mLLM 响应: {Text:在遥远的地方有一个小村庄，那里的人们生活得很幸福，因为他们的村长是一位非常聪明和善良的人。 IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 08:44:22.239[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:44:22.243[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"村民们非常焦急，","response_meta":{}}
2025-07-24 08:44:22.244[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"不知道该如何是好","response_meta":{}}
2025-07-24 08:44:22.244[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"。阿明了解","response_meta":{}}
2025-07-24 08:44:22.245[36m [info] [llm.go:109] [0m处理完整句子: 村民们非常焦急，不知道该如何是好。
2025-07-24 08:44:22.245[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 灌溉，那一年
finish_reason: 
2025-07-24 08:44:22.310[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 的收成比
finish_reason: 
2025-07-24 08:44:22.450[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 往年都要好得多
finish_reason: 
2025-07-24 08:44:22.486[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 。村民们对阿
finish_reason: 
2025-07-24 08:44:22.561[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 明的智慧和
finish_reason: 
2025-07-24 08:44:22.668[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 领导能力更加敬
finish_reason: 
2025-07-24 08:44:22.705[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 佩了。

从此
finish_reason: 
2025-07-24 08:44:22.766[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:44:22.766[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:44:22.767[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 528 ms
2025-07-24 08:44:22.767[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 528 ms
2025-07-24 08:44:22.767[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:44:22.769[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 38
2025-07-24 08:44:22.780[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 49
2025-07-24 08:44:22.782[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 69
2025-07-24 08:44:22.783[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 146
2025-07-24 08:44:22.809[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 以后，小村庄
finish_reason: 
2025-07-24 08:44:22.889[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 变得更加繁荣昌盛
finish_reason: 
2025-07-24 08:44:22.953[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，人们的生活也
finish_reason: 
2025-07-24 08:44:22.999[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 更加美好。而
finish_reason: 
2025-07-24 08:44:23.105[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 阿明的故事，
finish_reason: 
2025-07-24 08:44:23.198[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 也被一代又一代
finish_reason: 
2025-07-24 08:44:23.275[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 地传颂下去
finish_reason: 
2025-07-24 08:44:23.385[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，成为了激励后
finish_reason: 
2025-07-24 08:44:23.425[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 人团结合作、
finish_reason: 
2025-07-24 08:44:23.501[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 勇于创新的典范
finish_reason: 
2025-07-24 08:44:23.626[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 。

希望这个故事
finish_reason: 
2025-07-24 08:44:23.654[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 能给你带来一些
finish_reason: 
2025-07-24 08:44:23.833[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 正能量！如果你有
finish_reason: 
2025-07-24 08:44:23.878[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 喜欢的主题或者想
finish_reason: 
2025-07-24 08:44:23.990[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 听特定类型的故事
finish_reason: 
2025-07-24 08:44:24.027[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，也可以告诉我哦
finish_reason: 
2025-07-24 08:44:24.106[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 。
finish_reason: stop
2025-07-24 08:44:24.107[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: 
usage: &{427 284 711}
2025-07-24 08:44:24.107[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:44:24.107[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=
2025-07-24 08:44:24.279[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共34个片段
2025-07-24 08:44:26.786[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"_2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=","type":"abort","reason":"wake_word_detected"}
2025-07-24 08:44:26.786[36m [info] [session.go:364] [0m设备  abort 会话
2025-07-24 08:44:26.786[36m [info] [tts.go:225] [0mSendTTSAudio context done, exit, totalFrames: 71
2025-07-24 08:44:26.786[37m [debug] [llm.go:189] [0mhandleLLMResponse end
2025-07-24 08:44:26.786[31m [error] [llm.go:338] [0m处理 LLM 响应失败, seesionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=, error: TTS 处理上下文已取消
2025-07-24 08:44:26.786[31m [error] [session.go:657] [0m发送带工具的 LLM 请求失败, seesionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=, error: TTS 处理上下文已取消
2025-07-24 08:44:26.786[31m [error] [session.go:572] [0m处理对话失败: 发送带工具的 LLM 请求失败: TTS 处理上下文已取消
2025-07-24 08:44:26.806[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"_2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:44:26.806[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:44:26.806[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:44:26.806[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:44:26.806[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:44:26.807[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:44:26.807[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:44:27.948[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 08:44:28.013[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:28.075[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:28.152[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:28.210[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:28.268[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:28.311[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:28.372[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:28.432[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:28.492[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:28.548[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:28.622[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:28.847[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:44:28.939[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":685,"punc":"。","start":10,"text_seg":"你 退 一 下 吧","ts_list":[[10,90],[90,210],[210,270],[270,410],[410,685]]}],"text":"你退一下吧。","timestamp":"[[10,90],[90,210],[210,270],[270,410],[410,685]]","wav_name":"stream"}
2025-07-24 08:44:28.940[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:44:28.940[37m [debug] [asr.go:40] [0masr result: 你退一下吧。, ok: true, isFinal: true
2025-07-24 08:44:28.940[37m [debug] [session.go:490] [0m处理asr结果: 你退一下吧。, 耗时: 92 ms
2025-07-24 08:44:28.941[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 你退一下吧。
2025-07-24 08:44:28.941[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 08:44:28.941[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 08:44:28.941[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [self.screen.set_theme self.get_device_status exit_chat self.audio_speaker.set_volume self.screen.set_brightness]
2025-07-24 08:44:28.942[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=, requestEinoMessages: [user: 你退一下吧。]
2025-07-24 08:44:28.942[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=, Type: openai
2025-07-24 08:44:28.942[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=
2025-07-24 08:44:28.942[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=, context状态: <nil>
2025-07-24 08:44:28.942[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:44:28.942[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:44:28.958[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=, tools: [0xc0001f3020 0xc0001f3050 0xc0001f3080 0xc0001f30b0 0xc0001f30e0]
2025-07-24 08:44:28.959[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:44:29.463[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc00032a430 call_cdb62a2414ef488691c7bc function {exit_chat } map[]}]
finish_reason: 
2025-07-24 08:44:29.569[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc00032a538  function { {}} map[]}]
finish_reason: 
2025-07-24 08:44:29.570[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{427 12 439}
2025-07-24 08:44:29.572[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:44:29.572[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=
2025-07-24 08:44:29.573[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_cdb62a2414ef488691c7bc","type":"function","function":{"name":"exit_chat","arguments":"{}"}}]}
2025-07-24 08:44:29.573[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc00032a430 ID:call_cdb62a2414ef488691c7bc Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 08:44:29.574[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 
2025-07-24 08:44:29.574[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc00032a430 ID:call_cdb62a2414ef488691c7bc Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]}
2025-07-24 08:44:29.574[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc00032a430 ID:call_cdb62a2414ef488691c7bc Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 08:44:29.575[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:44:29.575[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:44:29.576[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 08:44:29.576[36m [info] [mcp_client.go:11] [0m查找工具: exit_chat (设备: 98:a3:16:d1:04:24)
2025-07-24 08:44:29.576[36m [info] [mcp_client.go:24] [0m找到本地工具: local_exit_chat
2025-07-24 08:44:29.577[36m [info] [llm.go:261] [0m进行工具调用请求: exit_chat, 参数: {}
2025-07-24 08:44:29.577[36m [info] [local_tools.go:82] [0m执行退出对话工具，参数: {}
2025-07-24 08:44:29.577[36m [info] [manager_registry.go:95] [0m通过注册表关闭设备 98:a3:16:d1:04:24 的ChatManager
2025-07-24 08:44:29.577[36m [info] [chat.go:145] [0m主动关闭断开连接, 设备 98:a3:16:d1:04:24
2025-07-24 08:44:29.577[31m [error] [websocket_conn.go:56] [0mread message error: read tcp 192.168.6.164:8989->192.168.7.45:62078: use of closed network connection
2025-07-24 08:44:29.577[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 08:44:29.577[36m [info] [manager_registry.go:51] [0m注销ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 08:44:29.577[36m [info] [device_manager.go:44] [0m设备 98:a3:16:d1:04:24 MCP客户端已移除并取消上下文
2025-07-24 08:44:29.577[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 08:44:29.577[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 08:44:29.577[36m [info] [local_tools.go:128] [0m设备 98:a3:16:d1:04:24 对话已退出，原因: 用户请求退出对话
2025-07-24 08:44:29.577[36m [info] [llm.go:274] [0m工具调用结果: {"device_id":"98:a3:16:d1:04:24","message":"对话已成功退出","reason":"用户请求退出对话","success":true}, 耗时: 0ms
2025-07-24 08:44:29.577[36m [info] [llm.go:279] [0m工具 exit_chat 标记为不回传结果给LLM，跳过回传
2025-07-24 08:44:29.577[36m [info] [llm.go:301] [0m所有工具都标记为不回传结果，跳过LLM处理
2025-07-24 08:44:29.577[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:44:29.577[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: _2C_osjncsFtODNMGUVJaxDkf0scviiS7rOLepgYD0M=
2025-07-24 08:44:29.578[37m [debug] [session.go:565] [0mprocessChatText end
2025-07-24 08:44:29.578[37m [debug] [session.go:147] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 08:44:29.578[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 08:44:29.578[36m [info] [session.go:134] [0m收到文本消息: 
2025-07-24 08:44:29.578[31m [error] [session.go:171] [0m解析消息失败: unexpected end of JSON input
2025-07-24 08:44:29.578[31m [error] [session.go:136] [0m处理文本消息失败: 解析消息失败: unexpected end of JSON input
2025-07-24 08:44:29.578[36m [info] [session.go:126] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 08:44:38.595[33m [warning] [userconfig.go:33] [0mRedis客户端未初始化
2025-07-24 08:44:38.595[36m [info] [base.go:36] [0mRedis用户配置提供者初始化成功
2025-07-24 08:44:38.596[36m [info] [chat.go:78] [0muserconfig: {SystemPrompt: Asr:{Provider:funasr Config:map[auto_end:true chunk_interval:10 chunk_size:[5 10 5] host:192.168.5.1 max_connections:5 mode:offline port:10095 sample_rate:16000 timeout:30]} Tts:{Provider:doubao_ws Config:map[access_token:pTt18L95cTdvgpBjnefFMEXsHaXgsU1k appid:9414688178 cluster:volcano_tts use_stream:true voice:zh_female_wanwanxiaohe_moon_bigtts ws_host:openspeech.bytedance.com]} Llm:{Provider:aliyun_qwen Config:map[api_key:sk-e740417c7bdb4deab05f17439e0c60c5 base_url:https://dashscope.aliyuncs.com/compatible-mode/v1 max_token:500 model_name:qwen2.5-72b-instruct type:openai]} Vad:{Provider:webrtc_vad Config:map[pool_max_idle:100 pool_max_size:1000 pool_min_size:5 vad_mode:2 vad_sample_rate:16000]}}
2025-07-24 08:44:38.596[33m [warning] [chat.go:96] [0mredis client is nil
2025-07-24 08:44:38.596[36m [info] [manager_registry.go:41] [0m注册ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 08:44:38.596[37m [debug] [eino_llm.go:163] [0mopenaiConfig: &{APIKey:sk-e740417c7bdb4deab05f17439e0c60c5 Timeout:0s HTTPClient:<nil> ByAzure:false BaseURL:https://dashscope.aliyuncs.com/compatible-mode/v1 APIVersion: Model:qwen2.5-72b-instruct MaxTokens:<nil> Temperature:<nil> TopP:<nil> Stop:[] PresencePenalty:<nil> ResponseFormat:<nil> Seed:<nil> FrequencyPenalty:<nil> LogitBias:map[] User:<nil>}
2025-07-24 08:44:38.596[36m [info] [eino_llm.go:171] [0m成功创建OpenAI ChatModel，模型: qwen2.5-72b-instruct
2025-07-24 08:44:38.596[37m [debug] [session.go:558] [0mprocessChatText start
2025-07-24 08:44:38.612[36m [info] [session.go:134] [0m收到文本消息: {"type":"hello","version":1,"features":{"mcp":true},"transport":"websocket","audio_params":{"format":"opus","sample_rate":16000,"channels":1,"frame_duration":60}}
2025-07-24 08:44:38.800[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 08:44:38.814[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:38.836[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:38.849[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:38.864[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:38.879[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:38.888[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:38.902[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:38.916[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:38.938[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:38.952[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:38.952[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:38.996[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=","type":"listen","state":"detect","text":"你好小智"}
2025-07-24 08:44:38.997[37m [debug] [llm.go:76] [0mAddTextToTTSQueue text: 你好，我是小智，今天有啥好玩的。
2025-07-24 08:44:38.997[37m [debug] [llm.go:93] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:44:38.997[36m [info] [session.go:299] [0m设备  更新音频监听状态: detect
2025-07-24 08:44:38.997[37m [debug] [llm.go:60] [0mprocessLLMResponseQueue item: {ctx:0xc00037c050 requestEinoMessages:[] responseChan:0xc00039b570 onStartFunc:0x12cedc0 onEndFunc:0x12ced60}
2025-07-24 08:44:38.997[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:44:38.997[37m [debug] [llm.go:178] [0mLLM 响应: {Text:你好，我是小智，今天有啥好玩的。 IsStart:true IsEnd:true ToolCalls:[]}
2025-07-24 08:44:38.998[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:44:39.007[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:44:39.008[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:44:39.009[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:44:39.009[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:44:39.009[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:44:39.012[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 1
2025-07-24 08:44:39.012[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:44:39.012[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:44:39.012[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:44:39.012[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=","type":"mcp","payload":{"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"xiaoxin-esp32s3-154-4G","version":"1.7.6"}}}}
2025-07-24 08:44:39.012[36m [info] [device_manager.go:294] [0m收到MCP服务器通知: notifications/initialized
2025-07-24 08:44:39.109[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=","type":"mcp","payload":{"jsonrpc":"2.0","id":2,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 08:44:39.109[36m [info] [device_manager.go:223] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 获取工具列表成功: map[self.audio_speaker.set_volume:0xc0004d4480 self.get_device_status:0xc0004d4340 self.screen.set_brightness:0xc0004d44c0 self.screen.set_theme:0xc0004d4500]
2025-07-24 08:44:39.395[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:44:39.396[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:44:39.397[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 400 ms
2025-07-24 08:44:39.399[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 402 ms
2025-07-24 08:44:39.399[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1753317879399 ms
2025-07-24 08:44:39.400[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:44:39.401[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 37
2025-07-24 08:44:39.517[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 43
2025-07-24 08:44:39.519[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 68
2025-07-24 08:44:39.520[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 145
2025-07-24 08:44:39.992[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共16个片段
2025-07-24 08:44:42.762[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 08:44:42.763[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:44:42.849[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:44:42.849[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:44:42.850[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:44:42.850[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:44:42.850[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:44:42.853[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 2
2025-07-24 08:44:42.853[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:44:42.854[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:44:42.854[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:44:42.854[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"text":"","wav_name":"stream"}
2025-07-24 08:44:42.854[37m [debug] [funasr.go:328] [0mfunasr recvResult 已取消: context canceled
2025-07-24 08:44:42.854[37m [debug] [asr.go:40] [0masr result: , ok: false, isFinal: false
2025-07-24 08:44:42.854[37m [debug] [asr.go:47] [0masr result channel closed
2025-07-24 08:44:42.854[37m [debug] [session.go:490] [0m处理asr结果: , 耗时: 1753317882854 ms
2025-07-24 08:44:42.854[37m [debug] [session.go:519] [0mready Restart Asr, s.clientState.Status: init
2025-07-24 08:44:43.701[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 08:44:43.763[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:43.838[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:43.898[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:43.928[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:43.988[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.062[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.124[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.180[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.242[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.319[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.377[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.405[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.467[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.541[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.604[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.666[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.720[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.793[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:44.853[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:45.078[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:44:45.193[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":1135,"punc":"。","start":30,"text_seg":"把 音 量 调 到 最 大","ts_list":[[30,150],[150,250],[250,450],[450,530],[530,670],[670,810],[810,1135]]}],"text":"把音量调到最大。","timestamp":"[[30,150],[150,250],[250,450],[450,530],[530,670],[670,810],[810,1135]]","wav_name":"stream"}
2025-07-24 08:44:45.194[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:44:45.194[37m [debug] [asr.go:40] [0masr result: 把音量调到最大。, ok: true, isFinal: true
2025-07-24 08:44:45.195[37m [debug] [session.go:490] [0m处理asr结果: 把音量调到最大。, 耗时: 116 ms
2025-07-24 08:44:45.195[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 把音量调到最大。
2025-07-24 08:44:45.195[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 08:44:45.196[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 08:44:45.196[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [exit_chat self.get_device_status self.audio_speaker.set_volume self.screen.set_brightness self.screen.set_theme]
2025-07-24 08:44:45.196[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, requestEinoMessages: [user: 把音量调到最大。]
2025-07-24 08:44:45.196[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, Type: openai
2025-07-24 08:44:45.197[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:45.197[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, context状态: <nil>
2025-07-24 08:44:45.197[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:44:45.197[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:44:45.212[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, tools: [0xc000237b90 0xc000237bc0 0xc000237bf0 0xc000237c20 0xc000237c50]
2025-07-24 08:44:45.213[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:44:45.823[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc00032a0f0 call_84e74e3c32fc48a18e630e function {self.get_device_status {}} map[]}]
finish_reason: 
2025-07-24 08:44:45.909[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc00032a1a0  function { } map[]}]
finish_reason: 
2025-07-24 08:44:45.910[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{429 14 443}
2025-07-24 08:44:45.910[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:44:45.910[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:45.910[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_84e74e3c32fc48a18e630e","type":"function","function":{"name":"self.get_device_status","arguments":"{}"}}]}
2025-07-24 08:44:45.911[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc00032a0f0 ID:call_84e74e3c32fc48a18e630e Type:function Function:{Name:self.get_device_status Arguments:{}} Extra:map[]}]
2025-07-24 08:44:45.911[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 
2025-07-24 08:44:45.911[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc00032a0f0 ID:call_84e74e3c32fc48a18e630e Type:function Function:{Name:self.get_device_status Arguments:{}} Extra:map[]}]}
2025-07-24 08:44:45.911[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc00032a0f0 ID:call_84e74e3c32fc48a18e630e Type:function Function:{Name:self.get_device_status Arguments:{}} Extra:map[]}]
2025-07-24 08:44:45.911[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:44:45.911[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:44:45.911[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 08:44:45.911[36m [info] [mcp_client.go:11] [0m查找工具: self.get_device_status (设备: 98:a3:16:d1:04:24)
2025-07-24 08:44:45.911[36m [info] [mcp_client.go:31] [0m从设备工具中找到: self.get_device_status
2025-07-24 08:44:45.911[36m [info] [llm.go:261] [0m进行工具调用请求: self.get_device_status, 参数: {}
2025-07-24 08:44:45.920[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=","type":"mcp","payload":{"jsonrpc":"2.0","id":3,"result":{"content":[{"type":"text","text":"{\"audio_speaker\":{\"volume\":80},\"screen\":{\"brightness\":50,\"theme\":\"light\"},\"network\":{\"type\":\"wifi\",\"ssid\":\"zhang\",\"signal\":\"weak\"}}"}],"isError":false}}}
2025-07-24 08:44:45.920[36m [info] [llm.go:274] [0m工具调用结果: {"audio_speaker":{"volume":80},"screen":{"brightness":50,"theme":"light"},"network":{"type":"wifi","ssid":"zhang","signal":"weak"}}, 耗时: 9ms
2025-07-24 08:44:45.920[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, requestEinoMessages: [user: 把音量调到最大。 assistant: 
tool_calls: [{0xc00032a0f0 call_84e74e3c32fc48a18e630e function {self.get_device_status {}} map[]}] tool: {"audio_speaker":{"volume":80},"screen":{"brightness":50,"theme":"light"},"network":{"type":"wifi","ssid":"zhang","signal":"weak"}}
tool_call_id: call_84e74e3c32fc48a18e630e]
2025-07-24 08:44:45.920[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, Type: openai
2025-07-24 08:44:45.920[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:45.920[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, context状态: <nil>
2025-07-24 08:44:45.920[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: 2
2025-07-24 08:44:45.920[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:44:45.941[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, tools: []
2025-07-24 08:44:45.941[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:44:46.937[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc000480470 call_80db9fa1427142a4b7bc44 function {self.audio_speaker.set_volume {"volume} map[]}]
finish_reason: 
2025-07-24 08:44:47.126[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc000480510  function { ": 10} map[]}]
finish_reason: 
2025-07-24 08:44:47.272[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc0004805b8  function { 0}} map[]}]
finish_reason: 
2025-07-24 08:44:47.273[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_80db9fa1427142a4b7bc44","type":"function","function":{"name":"self.audio_speaker.set_volume","arguments":"{\"volume\": 100}"}}]}
2025-07-24 08:44:47.273[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc000480470 ID:call_80db9fa1427142a4b7bc44 Type:function Function:{Name:self.audio_speaker.set_volume Arguments:{"volume": 100}} Extra:map[]}]
2025-07-24 08:44:47.293[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc000480470 ID:call_80db9fa1427142a4b7bc44 Type:function Function:{Name:self.audio_speaker.set_volume Arguments:{"volume": 100}} Extra:map[]}]}
2025-07-24 08:44:47.293[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc000480470 ID:call_80db9fa1427142a4b7bc44 Type:function Function:{Name:self.audio_speaker.set_volume Arguments:{"volume": 100}} Extra:map[]}]
2025-07-24 08:44:47.314[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc000480688  function { } map[]}]
finish_reason: 
2025-07-24 08:44:47.314[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{486 25 511}
2025-07-24 08:44:47.314[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:44:47.315[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:47.315[37m [debug] [llm.go:59] [0mfull Response with 0 tools, fullText: 
2025-07-24 08:44:47.315[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:44:47.315[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:44:47.315[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 08:44:47.316[36m [info] [mcp_client.go:11] [0m查找工具: self.audio_speaker.set_volume (设备: 98:a3:16:d1:04:24)
2025-07-24 08:44:47.316[36m [info] [mcp_client.go:31] [0m从设备工具中找到: self.audio_speaker.set_volume
2025-07-24 08:44:47.316[36m [info] [llm.go:261] [0m进行工具调用请求: self.audio_speaker.set_volume, 参数: {"volume": 100}
2025-07-24 08:44:47.333[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=","type":"mcp","payload":{"jsonrpc":"2.0","id":4,"result":{"content":[{"type":"text","text":"true"}],"isError":false}}}
2025-07-24 08:44:47.333[36m [info] [llm.go:274] [0m工具调用结果: true, 耗时: 17ms
2025-07-24 08:44:47.333[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, requestEinoMessages: [user: 把音量调到最大。 assistant: 
tool_calls: [{0xc00032a0f0 call_84e74e3c32fc48a18e630e function {self.get_device_status {}} map[]}] tool: {"audio_speaker":{"volume":80},"screen":{"brightness":50,"theme":"light"},"network":{"type":"wifi","ssid":"zhang","signal":"weak"}}
tool_call_id: call_84e74e3c32fc48a18e630e assistant: 
tool_calls: [{0xc000480470 call_80db9fa1427142a4b7bc44 function {self.audio_speaker.set_volume {"volume": 100}} map[]}] tool: true
tool_call_id: call_80db9fa1427142a4b7bc44]
2025-07-24 08:44:47.333[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, Type: openai
2025-07-24 08:44:47.333[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:47.333[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, context状态: <nil>
2025-07-24 08:44:47.333[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: 2
2025-07-24 08:44:47.333[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:44:47.347[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, tools: []
2025-07-24 08:44:47.347[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:44:47.722[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 音
finish_reason: 
2025-07-24 08:44:47.723[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"音","response_meta":{}}
2025-07-24 08:44:47.827[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 量已经调到
finish_reason: 
2025-07-24 08:44:47.831[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"量已经调到","response_meta":{}}
2025-07-24 08:44:47.932[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 最大了。
finish_reason: stop
2025-07-24 08:44:47.933[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: 
usage: &{520 10 530}
2025-07-24 08:44:47.934[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:44:47.934[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:47.935[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"最大了。","response_meta":{"finish_reason":"stop"}}
2025-07-24 08:44:47.935[36m [info] [llm.go:107] [0m耗时统计: llm工具首句: 602 ms
2025-07-24 08:44:47.936[36m [info] [llm.go:109] [0m处理完整句子: 音量已经调到最大了。
2025-07-24 08:44:47.936[37m [debug] [llm.go:59] [0mfull Response with 0 tools, fullText: 音量已经调到最大了。
2025-07-24 08:44:47.937[37m [debug] [llm.go:178] [0mLLM 响应: {Text:音量已经调到最大了。 IsStart:true IsEnd:false ToolCalls:[]}
2025-07-24 08:44:47.937[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:44:48.333[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:44:48.333[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:44:48.334[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 397 ms
2025-07-24 08:44:48.335[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 398 ms
2025-07-24 08:44:48.338[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 3143 ms
2025-07-24 08:44:48.338[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:44:48.338[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 41
2025-07-24 08:44:48.349[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 58
2025-07-24 08:44:48.351[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 82
2025-07-24 08:44:48.351[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 139
2025-07-24 08:44:48.766[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共11个片段
2025-07-24 08:44:50.573[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:44:50.574[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:44:50.575[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 08:44:50.575[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:44:50.575[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:50.575[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:44:50.575[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:50.575[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:44:50.576[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:50.764[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:44:50.764[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:44:50.764[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:44:50.764[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:44:50.765[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:44:50.765[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:44:50.765[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:44:52.959[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 08:44:53.019[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.082[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.140[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.210[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.288[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.304[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.368[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.445[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.499[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.558[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.618[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.696[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.755[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.781[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.841[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.918[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:53.983[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:54.037[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:54.097[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:54.173[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:54.234[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:54.265[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:54.323[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:54.400[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:54.457[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:54.515[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:54.575[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:44:54.814[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:44:54.964[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":1555,"punc":"。","start":50,"text_seg":"把 屏 幕 亮 度 调 到 一","ts_list":[[50,230],[230,370],[370,530],[530,650],[650,850],[850,990],[990,1170],[1170,1555]]}],"text":"把屏幕亮度调到一。","timestamp":"[[50,230],[230,370],[370,530],[530,650],[650,850],[850,990],[990,1170],[1170,1555]]","wav_name":"stream"}
2025-07-24 08:44:54.965[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:44:54.966[37m [debug] [asr.go:40] [0masr result: 把屏幕亮度调到一。, ok: true, isFinal: true
2025-07-24 08:44:54.966[37m [debug] [session.go:490] [0m处理asr结果: 把屏幕亮度调到一。, 耗时: 152 ms
2025-07-24 08:44:54.966[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 把屏幕亮度调到一。
2025-07-24 08:44:54.966[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 08:44:54.966[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 08:44:54.966[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [self.get_device_status self.audio_speaker.set_volume exit_chat self.screen.set_brightness self.screen.set_theme]
2025-07-24 08:44:54.966[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, requestEinoMessages: [user: 把屏幕亮度调到一。]
2025-07-24 08:44:54.966[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, Type: openai
2025-07-24 08:44:54.966[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:54.966[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, context状态: <nil>
2025-07-24 08:44:54.966[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:44:54.966[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:44:54.977[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, tools: [0xc0001f2570 0xc0001f25a0 0xc0001f25d0 0xc0001f2600 0xc0001f2630]
2025-07-24 08:44:54.978[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:44:55.662[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc00029c910 call_19994ffff8664539b82fff function {self.screen.set_brightness {"brightness} map[]}]
finish_reason: 
2025-07-24 08:44:55.747[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc00029cad0  function { ": 1}} map[]}]
finish_reason: 
2025-07-24 08:44:55.747[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_19994ffff8664539b82fff","type":"function","function":{"name":"self.screen.set_brightness","arguments":"{\"brightness\": 1}"}}]}
2025-07-24 08:44:55.748[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc00029c910 ID:call_19994ffff8664539b82fff Type:function Function:{Name:self.screen.set_brightness Arguments:{"brightness": 1}} Extra:map[]}]
2025-07-24 08:44:55.767[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc00029c910 ID:call_19994ffff8664539b82fff Type:function Function:{Name:self.screen.set_brightness Arguments:{"brightness": 1}} Extra:map[]}]}
2025-07-24 08:44:55.767[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc00029c910 ID:call_19994ffff8664539b82fff Type:function Function:{Name:self.screen.set_brightness Arguments:{"brightness": 1}} Extra:map[]}]
2025-07-24 08:44:55.872[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc00029cd90  function { } map[]}]
finish_reason: 
2025-07-24 08:44:55.872[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{429 19 448}
2025-07-24 08:44:55.872[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:44:55.872[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:55.872[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 
2025-07-24 08:44:55.872[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:44:55.872[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:44:55.872[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 08:44:55.872[36m [info] [mcp_client.go:11] [0m查找工具: self.screen.set_brightness (设备: 98:a3:16:d1:04:24)
2025-07-24 08:44:55.872[36m [info] [mcp_client.go:31] [0m从设备工具中找到: self.screen.set_brightness
2025-07-24 08:44:55.872[36m [info] [llm.go:261] [0m进行工具调用请求: self.screen.set_brightness, 参数: {"brightness": 1}
2025-07-24 08:44:55.892[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=","type":"mcp","payload":{"jsonrpc":"2.0","id":5,"result":{"content":[{"type":"text","text":"true"}],"isError":false}}}
2025-07-24 08:44:55.893[36m [info] [llm.go:274] [0m工具调用结果: true, 耗时: 21ms
2025-07-24 08:44:55.893[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, requestEinoMessages: [user: 把屏幕亮度调到一。 assistant: 
tool_calls: [{0xc00029c910 call_19994ffff8664539b82fff function {self.screen.set_brightness {"brightness": 1}} map[]}] tool: true
tool_call_id: call_19994ffff8664539b82fff]
2025-07-24 08:44:55.893[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, Type: openai
2025-07-24 08:44:55.893[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:55.893[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, context状态: <nil>
2025-07-24 08:44:55.893[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: 2
2025-07-24 08:44:55.893[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:44:55.913[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, tools: []
2025-07-24 08:44:55.913[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:44:56.271[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 已
finish_reason: 
2025-07-24 08:44:56.272[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"已","response_meta":{}}
2025-07-24 08:44:56.355[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 经将屏幕亮度
finish_reason: 
2025-07-24 08:44:56.355[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"经将屏幕亮度","response_meta":{}}
2025-07-24 08:44:56.418[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 调整到1。
finish_reason: 
2025-07-24 08:44:56.418[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"调整到1。","response_meta":{}}
2025-07-24 08:44:56.418[36m [info] [llm.go:107] [0m耗时统计: llm工具首句: 525 ms
2025-07-24 08:44:56.418[36m [info] [llm.go:109] [0m处理完整句子: 已经将屏幕亮度调整到1。
2025-07-24 08:44:56.438[37m [debug] [llm.go:178] [0mLLM 响应: {Text:已经将屏幕亮度调整到1。 IsStart:true IsEnd:false ToolCalls:[]}
2025-07-24 08:44:56.439[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:44:56.484[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: stop
usage: &{457 11 468}
2025-07-24 08:44:56.485[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:44:56.485[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:56.485[37m [debug] [llm.go:59] [0mfull Response with 0 tools, fullText: 已经将屏幕亮度调整到1。
2025-07-24 08:44:56.856[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:44:56.856[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:44:56.858[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 419 ms
2025-07-24 08:44:56.859[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 420 ms
2025-07-24 08:44:56.860[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1894 ms
2025-07-24 08:44:56.860[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:44:56.861[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 37
2025-07-24 08:44:56.874[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 42
2025-07-24 08:44:56.875[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 58
2025-07-24 08:44:56.877[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 136
2025-07-24 08:44:57.228[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共12个片段
2025-07-24 08:44:59.278[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:44:59.279[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:44:59.279[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 08:44:59.279[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:44:59.279[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:59.279[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:44:59.279[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:44:59.485[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:44:59.486[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:44:59.486[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:44:59.486[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:44:59.487[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:44:59.487[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:44:59.487[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:45:01.048[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 08:45:01.073[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:01.151[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:01.226[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:01.274[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:01.343[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:01.403[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:01.463[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:01.523[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:01.552[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:01.624[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:01.686[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:01.943[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:45:02.023[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":655,"punc":"。","start":30,"text_seg":"你 退 下 吧","ts_list":[[30,110],[110,170],[170,330],[330,655]]}],"text":"你退下吧。","timestamp":"[[30,110],[110,170],[170,330],[330,655]]","wav_name":"stream"}
2025-07-24 08:45:02.024[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:45:02.025[37m [debug] [asr.go:40] [0masr result: 你退下吧。, ok: true, isFinal: true
2025-07-24 08:45:02.025[37m [debug] [session.go:490] [0m处理asr结果: 你退下吧。, 耗时: 81 ms
2025-07-24 08:45:02.026[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 你退下吧。
2025-07-24 08:45:02.026[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 08:45:02.026[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 08:45:02.026[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [exit_chat self.get_device_status self.audio_speaker.set_volume self.screen.set_brightness self.screen.set_theme]
2025-07-24 08:45:02.026[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, requestEinoMessages: [user: 你退下吧。]
2025-07-24 08:45:02.027[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, Type: openai
2025-07-24 08:45:02.027[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:45:02.027[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, context状态: <nil>
2025-07-24 08:45:02.027[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:45:02.027[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:45:02.042[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=, tools: [0xc00051fc50 0xc00051fc80 0xc00051fcb0 0xc00051fce0 0xc00051fd10]
2025-07-24 08:45:02.043[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:45:02.527[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc00029c4a0 call_ffe950882cb94a12897e55 function {exit_chat } map[]}]
finish_reason: 
2025-07-24 08:45:02.634[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc00029c778  function { {}} map[]}]
finish_reason: 
2025-07-24 08:45:02.634[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{427 12 439}
2025-07-24 08:45:02.634[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:45:02.634[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:45:02.635[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_ffe950882cb94a12897e55","type":"function","function":{"name":"exit_chat","arguments":"{}"}}]}
2025-07-24 08:45:02.635[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc00029c4a0 ID:call_ffe950882cb94a12897e55 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 08:45:02.636[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 
2025-07-24 08:45:02.636[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc00029c4a0 ID:call_ffe950882cb94a12897e55 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]}
2025-07-24 08:45:02.636[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc00029c4a0 ID:call_ffe950882cb94a12897e55 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 08:45:02.637[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:45:02.637[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:45:02.638[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 08:45:02.638[36m [info] [mcp_client.go:11] [0m查找工具: exit_chat (设备: 98:a3:16:d1:04:24)
2025-07-24 08:45:02.638[36m [info] [mcp_client.go:24] [0m找到本地工具: local_exit_chat
2025-07-24 08:45:02.639[36m [info] [llm.go:261] [0m进行工具调用请求: exit_chat, 参数: {}
2025-07-24 08:45:02.639[36m [info] [local_tools.go:82] [0m执行退出对话工具，参数: {}
2025-07-24 08:45:02.639[36m [info] [manager_registry.go:95] [0m通过注册表关闭设备 98:a3:16:d1:04:24 的ChatManager
2025-07-24 08:45:02.639[36m [info] [chat.go:145] [0m主动关闭断开连接, 设备 98:a3:16:d1:04:24
2025-07-24 08:45:02.639[31m [error] [websocket_conn.go:56] [0mread message error: read tcp 192.168.6.164:8989->192.168.7.45:62079: use of closed network connection
2025-07-24 08:45:02.639[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 08:45:02.639[36m [info] [manager_registry.go:51] [0m注销ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 08:45:02.640[36m [info] [device_manager.go:44] [0m设备 98:a3:16:d1:04:24 MCP客户端已移除并取消上下文
2025-07-24 08:45:02.640[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 08:45:02.640[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 08:45:02.640[36m [info] [local_tools.go:128] [0m设备 98:a3:16:d1:04:24 对话已退出，原因: 用户请求退出对话
2025-07-24 08:45:02.640[36m [info] [llm.go:274] [0m工具调用结果: {"device_id":"98:a3:16:d1:04:24","message":"对话已成功退出","reason":"用户请求退出对话","success":true}, 耗时: 1ms
2025-07-24 08:45:02.640[36m [info] [llm.go:279] [0m工具 exit_chat 标记为不回传结果给LLM，跳过回传
2025-07-24 08:45:02.640[36m [info] [llm.go:301] [0m所有工具都标记为不回传结果，跳过LLM处理
2025-07-24 08:45:02.640[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:45:02.640[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: D3oM8a6Fac9GGKiLvrqHxY1joTa3h-bo8yATaLFhvZc=
2025-07-24 08:45:02.640[37m [debug] [session.go:565] [0mprocessChatText end
2025-07-24 08:45:02.640[37m [debug] [session.go:147] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 08:45:02.640[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 08:45:02.640[36m [info] [session.go:134] [0m收到文本消息: 
2025-07-24 08:45:02.640[31m [error] [session.go:171] [0m解析消息失败: unexpected end of JSON input
2025-07-24 08:45:02.640[31m [error] [session.go:136] [0m处理文本消息失败: 解析消息失败: unexpected end of JSON input
2025-07-24 08:45:02.640[36m [info] [session.go:126] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 08:45:11.428[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 1
2025-07-24 08:45:11.428[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 0
2025-07-24 08:45:19.250[33m [warning] [userconfig.go:33] [0mRedis客户端未初始化
2025-07-24 08:45:19.250[36m [info] [base.go:36] [0mRedis用户配置提供者初始化成功
2025-07-24 08:45:19.250[36m [info] [chat.go:78] [0muserconfig: {SystemPrompt: Asr:{Provider:funasr Config:map[auto_end:true chunk_interval:10 chunk_size:[5 10 5] host:192.168.5.1 max_connections:5 mode:offline port:10095 sample_rate:16000 timeout:30]} Tts:{Provider:doubao_ws Config:map[access_token:pTt18L95cTdvgpBjnefFMEXsHaXgsU1k appid:9414688178 cluster:volcano_tts use_stream:true voice:zh_female_wanwanxiaohe_moon_bigtts ws_host:openspeech.bytedance.com]} Llm:{Provider:aliyun_qwen Config:map[api_key:sk-e740417c7bdb4deab05f17439e0c60c5 base_url:https://dashscope.aliyuncs.com/compatible-mode/v1 max_token:500 model_name:qwen2.5-72b-instruct type:openai]} Vad:{Provider:webrtc_vad Config:map[pool_max_idle:100 pool_max_size:1000 pool_min_size:5 vad_mode:2 vad_sample_rate:16000]}}
2025-07-24 08:45:19.250[33m [warning] [chat.go:96] [0mredis client is nil
2025-07-24 08:45:19.250[36m [info] [manager_registry.go:41] [0m注册ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 08:45:19.250[37m [debug] [eino_llm.go:163] [0mopenaiConfig: &{APIKey:sk-e740417c7bdb4deab05f17439e0c60c5 Timeout:0s HTTPClient:<nil> ByAzure:false BaseURL:https://dashscope.aliyuncs.com/compatible-mode/v1 APIVersion: Model:qwen2.5-72b-instruct MaxTokens:<nil> Temperature:<nil> TopP:<nil> Stop:[] PresencePenalty:<nil> ResponseFormat:<nil> Seed:<nil> FrequencyPenalty:<nil> LogitBias:map[] User:<nil>}
2025-07-24 08:45:19.250[36m [info] [eino_llm.go:171] [0m成功创建OpenAI ChatModel，模型: qwen2.5-72b-instruct
2025-07-24 08:45:19.251[37m [debug] [session.go:558] [0mprocessChatText start
2025-07-24 08:45:19.262[36m [info] [session.go:134] [0m收到文本消息: {"type":"hello","version":1,"features":{"mcp":true},"transport":"websocket","audio_params":{"format":"opus","sample_rate":16000,"channels":1,"frame_duration":60}}
2025-07-24 08:45:19.454[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 08:45:19.460[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.483[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.491[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.517[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.521[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.535[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.558[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.563[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.580[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.593[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.604[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.619[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.626[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:19.644[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"listen","state":"detect","text":"你好小智"}
2025-07-24 08:45:19.644[37m [debug] [llm.go:76] [0mAddTextToTTSQueue text: 你好，我是小智，很高兴认识你。
2025-07-24 08:45:19.644[37m [debug] [llm.go:93] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:45:19.644[36m [info] [session.go:299] [0m设备  更新音频监听状态: detect
2025-07-24 08:45:19.645[37m [debug] [llm.go:60] [0mprocessLLMResponseQueue item: {ctx:0xc00037c050 requestEinoMessages:[] responseChan:0xc0006916c0 onStartFunc:0x12cedc0 onEndFunc:0x12ced60}
2025-07-24 08:45:19.645[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:45:19.645[37m [debug] [llm.go:178] [0mLLM 响应: {Text:你好，我是小智，很高兴认识你。 IsStart:true IsEnd:true ToolCalls:[]}
2025-07-24 08:45:19.645[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:45:19.652[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:45:19.652[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:45:19.653[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:45:19.653[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:45:19.653[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:45:19.655[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 1
2025-07-24 08:45:19.656[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:45:19.656[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:45:19.656[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:45:19.695[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"mcp","payload":{"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"xiaoxin-esp32s3-154-4G","version":"1.7.6"}}}}
2025-07-24 08:45:19.696[36m [info] [device_manager.go:294] [0m收到MCP服务器通知: notifications/initialized
2025-07-24 08:45:19.707[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"mcp","payload":{"jsonrpc":"2.0","id":2,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 08:45:19.708[36m [info] [device_manager.go:223] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 获取工具列表成功: map[self.audio_speaker.set_volume:0xc0004d46c0 self.get_device_status:0xc0004d4680 self.screen.set_brightness:0xc0004d4700 self.screen.set_theme:0xc0004d4740]
2025-07-24 08:45:20.071[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:45:20.072[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:45:20.073[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 428 ms
2025-07-24 08:45:20.073[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 428 ms
2025-07-24 08:45:20.073[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1753317920073 ms
2025-07-24 08:45:20.073[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:45:20.074[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 37
2025-07-24 08:45:20.089[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 46
2025-07-24 08:45:20.090[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 63
2025-07-24 08:45:20.091[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 152
2025-07-24 08:45:20.500[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共14个片段
2025-07-24 08:45:22.972[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 08:45:22.972[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:45:23.149[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:45:23.150[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:45:23.150[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:45:23.150[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:45:23.150[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:45:23.153[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"text":"","wav_name":"stream"}
2025-07-24 08:45:23.153[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:45:23.154[37m [debug] [asr.go:40] [0masr result: , ok: true, isFinal: true
2025-07-24 08:45:23.154[37m [debug] [session.go:490] [0m处理asr结果: , 耗时: 1753317923154 ms
2025-07-24 08:45:23.154[37m [debug] [session.go:519] [0mready Restart Asr, s.clientState.Status: init
2025-07-24 08:45:23.154[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 2
2025-07-24 08:45:23.155[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:45:23.155[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:45:23.155[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:45:23.407[36m [info] [asr.go:112] [0m检测到语音, len: 1920
2025-07-24 08:45:23.474[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:23.547[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:23.605[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:23.664[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:23.724[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:23.769[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:23.829[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:23.890[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:23.949[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.024[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.091[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.145[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.206[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.247[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.308[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.372[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.431[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.504[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.566[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.622[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.684[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.738[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.789[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.850[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.909[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:24.987[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:25.042[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:25.100[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:25.325[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:45:25.478[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":1675,"punc":"。","start":30,"text_seg":"把 屏 幕 亮 度 调 到 最 亮","ts_list":[[30,170],[170,310],[310,630],[630,790],[790,910],[910,1070],[1070,1170],[1170,1350],[1350,1675]]}],"text":"把屏幕亮度调到最亮。","timestamp":"[[30,170],[170,310],[310,630],[630,790],[790,910],[910,1070],[1070,1170],[1170,1350],[1350,1675]]","wav_name":"stream"}
2025-07-24 08:45:25.479[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:45:25.479[37m [debug] [asr.go:40] [0masr result: 把屏幕亮度调到最亮。, ok: true, isFinal: true
2025-07-24 08:45:25.479[37m [debug] [session.go:490] [0m处理asr结果: 把屏幕亮度调到最亮。, 耗时: 153 ms
2025-07-24 08:45:25.479[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 把屏幕亮度调到最亮。
2025-07-24 08:45:25.479[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 08:45:25.479[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 08:45:25.479[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [self.screen.set_theme self.get_device_status self.audio_speaker.set_volume self.screen.set_brightness exit_chat]
2025-07-24 08:45:25.479[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, requestEinoMessages: [user: 把屏幕亮度调到最亮。]
2025-07-24 08:45:25.479[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, Type: openai
2025-07-24 08:45:25.479[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:25.479[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, context状态: <nil>
2025-07-24 08:45:25.479[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:45:25.479[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:45:25.497[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, tools: [0xc0000fce10 0xc0000fce40 0xc0000fce70 0xc0000fcea0 0xc0000fced0]
2025-07-24 08:45:25.498[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:45:26.129[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc000014250 call_8c57c55581fe4f1f9b614a function {self.screen.set_brightness {"brightness} map[]}]
finish_reason: 
2025-07-24 08:45:26.212[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc0000142f0  function { ": 10} map[]}]
finish_reason: 
2025-07-24 08:45:26.294[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc0000143d8  function { 0}} map[]}]
finish_reason: 
2025-07-24 08:45:26.295[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_8c57c55581fe4f1f9b614a","type":"function","function":{"name":"self.screen.set_brightness","arguments":"{\"brightness\": 100}"}}]}
2025-07-24 08:45:26.295[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc000014250 ID:call_8c57c55581fe4f1f9b614a Type:function Function:{Name:self.screen.set_brightness Arguments:{"brightness": 100}} Extra:map[]}]
2025-07-24 08:45:26.304[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc000014250 ID:call_8c57c55581fe4f1f9b614a Type:function Function:{Name:self.screen.set_brightness Arguments:{"brightness": 100}} Extra:map[]}]}
2025-07-24 08:45:26.304[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc000014250 ID:call_8c57c55581fe4f1f9b614a Type:function Function:{Name:self.screen.set_brightness Arguments:{"brightness": 100}} Extra:map[]}]
2025-07-24 08:45:26.366[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc00029c388  function { } map[]}]
finish_reason: 
2025-07-24 08:45:26.366[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{430 21 451}
2025-07-24 08:45:26.367[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:45:26.367[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:26.367[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 
2025-07-24 08:45:26.367[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:45:26.367[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:45:26.367[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 08:45:26.367[36m [info] [mcp_client.go:11] [0m查找工具: self.screen.set_brightness (设备: 98:a3:16:d1:04:24)
2025-07-24 08:45:26.367[36m [info] [mcp_client.go:31] [0m从设备工具中找到: self.screen.set_brightness
2025-07-24 08:45:26.367[36m [info] [llm.go:261] [0m进行工具调用请求: self.screen.set_brightness, 参数: {"brightness": 100}
2025-07-24 08:45:26.399[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"mcp","payload":{"jsonrpc":"2.0","id":3,"result":{"content":[{"type":"text","text":"true"}],"isError":false}}}
2025-07-24 08:45:26.399[36m [info] [llm.go:274] [0m工具调用结果: true, 耗时: 32ms
2025-07-24 08:45:26.400[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, requestEinoMessages: [user: 把屏幕亮度调到最亮。 assistant: 
tool_calls: [{0xc000014250 call_8c57c55581fe4f1f9b614a function {self.screen.set_brightness {"brightness": 100}} map[]}] tool: true
tool_call_id: call_8c57c55581fe4f1f9b614a]
2025-07-24 08:45:26.400[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, Type: openai
2025-07-24 08:45:26.401[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:26.401[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, context状态: <nil>
2025-07-24 08:45:26.401[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: 2
2025-07-24 08:45:26.401[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:45:26.417[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, tools: []
2025-07-24 08:45:26.418[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:45:26.841[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 已
finish_reason: 
2025-07-24 08:45:26.841[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"已","response_meta":{}}
2025-07-24 08:45:27.082[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 将屏幕亮度调整
finish_reason: 
2025-07-24 08:45:27.082[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"将屏幕亮度调整","response_meta":{}}
2025-07-24 08:45:27.132[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 到最亮。
finish_reason: 
2025-07-24 08:45:27.133[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"到最亮。","response_meta":{}}
2025-07-24 08:45:27.133[36m [info] [llm.go:107] [0m耗时统计: llm工具首句: 732 ms
2025-07-24 08:45:27.133[36m [info] [llm.go:109] [0m处理完整句子: 已将屏幕亮度调整到最亮。
2025-07-24 08:45:27.145[37m [debug] [llm.go:178] [0mLLM 响应: {Text:已将屏幕亮度调整到最亮。 IsStart:true IsEnd:false ToolCalls:[]}
2025-07-24 08:45:27.145[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:45:27.318[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: :  若要调节至适宜
finish_reason: 
2025-07-24 08:45:27.319[36m [info] [llm.go:96] [0m收到message: {"role":"","content":" 若要调节至适宜","response_meta":{}}
2025-07-24 08:45:27.452[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 的亮度，您可以
finish_reason: 
2025-07-24 08:45:27.453[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"的亮度，您可以","response_meta":{}}
2025-07-24 08:45:27.577[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:45:27.577[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:45:27.578[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 433 ms
2025-07-24 08:45:27.579[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 434 ms
2025-07-24 08:45:27.579[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 2100 ms
2025-07-24 08:45:27.579[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:45:27.598[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 39
2025-07-24 08:45:27.599[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 53
2025-07-24 08:45:27.601[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 68
2025-07-24 08:45:27.609[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 139
2025-07-24 08:45:27.618[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 告诉我具体的需求，
finish_reason: 
2025-07-24 08:45:27.618[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"告诉我具体的需求，","response_meta":{}}
2025-07-24 08:45:27.896[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共12个片段
2025-07-24 08:45:28.043[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 或者自己手动调节
finish_reason: 
2025-07-24 08:45:28.044[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"或者自己手动调节","response_meta":{}}
2025-07-24 08:45:28.209[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 哦。
finish_reason: stop
2025-07-24 08:45:28.210[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: 
usage: &{460 29 489}
2025-07-24 08:45:28.210[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:45:28.210[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:28.211[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"哦。","response_meta":{"finish_reason":"stop"}}
2025-07-24 08:45:28.211[36m [info] [llm.go:109] [0m处理完整句子: 若要调节至适宜的亮度，您可以告诉我具体的需求，或者自己手动调节哦。
2025-07-24 08:45:28.211[37m [debug] [llm.go:59] [0mfull Response with 0 tools, fullText: 已将屏幕亮度调整到最亮。 若要调节至适宜的亮度，您可以告诉我具体的需求，或者自己手动调节哦。
2025-07-24 08:45:30.070[37m [debug] [llm.go:178] [0mLLM 响应: {Text:若要调节至适宜的亮度，您可以告诉我具体的需求，或者自己手动调节哦。 IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 08:45:30.070[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:45:30.496[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:45:30.496[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:45:30.496[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 426 ms
2025-07-24 08:45:30.497[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 427 ms
2025-07-24 08:45:30.497[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:45:30.499[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 37
2025-07-24 08:45:30.622[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 43
2025-07-24 08:45:30.626[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 70
2025-07-24 08:45:30.627[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 135
2025-07-24 08:45:31.746[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共29个片段
2025-07-24 08:45:34.805[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"abort","reason":"wake_word_detected"}
2025-07-24 08:45:34.806[36m [info] [session.go:364] [0m设备  abort 会话
2025-07-24 08:45:34.806[36m [info] [tts.go:225] [0mSendTTSAudio context done, exit, totalFrames: 74
2025-07-24 08:45:34.807[37m [debug] [llm.go:189] [0mhandleLLMResponse end
2025-07-24 08:45:34.807[31m [error] [llm.go:338] [0m处理 LLM 响应失败, seesionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, error: TTS 处理上下文已取消
2025-07-24 08:45:34.807[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:45:34.807[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:34.834[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:45:34.834[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:45:34.834[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:45:34.834[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:45:34.834[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:45:34.834[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:45:34.834[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:45:34.985[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:35.020[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:35.272[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:45:35.275[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"text":"","wav_name":"stream"}
2025-07-24 08:45:35.275[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:45:35.275[37m [debug] [asr.go:40] [0masr result: , ok: true, isFinal: true
2025-07-24 08:45:35.275[37m [debug] [session.go:490] [0m处理asr结果: , 耗时: 3 ms
2025-07-24 08:45:35.275[37m [debug] [session.go:519] [0mready Restart Asr, s.clientState.Status: listenStop
2025-07-24 08:45:35.275[33m [warning] [session.go:524] [0mASR识别结果为空，尝试重启ASR识别, diff ts: %!s(int64=1)
2025-07-24 08:45:35.275[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:45:35.275[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:45:36.309[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 08:45:36.340[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:36.405[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:36.458[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:36.519[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:36.595[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:36.657[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:36.722[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:36.790[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:36.821[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:36.880[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:36.943[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.000[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.074[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.146[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.196[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.270[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.301[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.357[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.423[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.480[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.552[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.612[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.674[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:37.897[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:45:38.026[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":1315,"punc":"。","start":30,"text_seg":"把 声 音 调 到 8 0","ts_list":[[30,170],[170,310],[310,510],[510,650],[650,790],[790,1052],[1052,1315]]}],"text":"把声音调到80 。","timestamp":"[[30,170],[170,310],[310,510],[510,650],[650,790],[790,1052],[1052,1315]]","wav_name":"stream"}
2025-07-24 08:45:38.027[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:45:38.027[37m [debug] [asr.go:40] [0masr result: 把声音调到80 。, ok: true, isFinal: true
2025-07-24 08:45:38.028[37m [debug] [session.go:490] [0m处理asr结果: 把声音调到80 。, 耗时: 130 ms
2025-07-24 08:45:38.028[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 把声音调到80 。
2025-07-24 08:45:38.029[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 08:45:38.029[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 08:45:38.029[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [self.screen.set_brightness self.screen.set_theme self.get_device_status exit_chat self.audio_speaker.set_volume]
2025-07-24 08:45:38.030[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, requestEinoMessages: [user: 把声音调到80 。]
2025-07-24 08:45:38.030[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, Type: openai
2025-07-24 08:45:38.030[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:38.030[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, context状态: <nil>
2025-07-24 08:45:38.031[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:45:38.031[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:45:38.038[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, tools: [0xc0000b7230 0xc0000b7260 0xc0000b7290 0xc0000b72c0 0xc0000b72f0]
2025-07-24 08:45:38.039[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:45:38.606[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 1
2025-07-24 08:45:38.607[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 0
2025-07-24 08:45:38.670[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc0000142c8 call_b1d03753de9b47128440dd function {self.audio_speaker.set_volume } map[]}]
finish_reason: 
2025-07-24 08:45:38.730[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc0000143e0  function { {"volume":} map[]}]
finish_reason: 
2025-07-24 08:45:38.811[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc0000147e0  function {  80}} map[]}]
finish_reason: 
2025-07-24 08:45:38.812[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_b1d03753de9b47128440dd","type":"function","function":{"name":"self.audio_speaker.set_volume","arguments":"{\"volume\": 80}"}}]}
2025-07-24 08:45:38.814[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc0000142c8 ID:call_b1d03753de9b47128440dd Type:function Function:{Name:self.audio_speaker.set_volume Arguments:{"volume": 80}} Extra:map[]}]
2025-07-24 08:45:38.832[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc0000142c8 ID:call_b1d03753de9b47128440dd Type:function Function:{Name:self.audio_speaker.set_volume Arguments:{"volume": 80}} Extra:map[]}]}
2025-07-24 08:45:38.832[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc0000142c8 ID:call_b1d03753de9b47128440dd Type:function Function:{Name:self.audio_speaker.set_volume Arguments:{"volume": 80}} Extra:map[]}]
2025-07-24 08:45:38.895[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc000208220  function { } map[]}]
finish_reason: 
2025-07-24 08:45:38.896[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{429 22 451}
2025-07-24 08:45:38.896[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:45:38.896[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:38.897[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 
2025-07-24 08:45:38.897[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:45:38.897[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:45:38.897[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 08:45:38.897[36m [info] [mcp_client.go:11] [0m查找工具: self.audio_speaker.set_volume (设备: 98:a3:16:d1:04:24)
2025-07-24 08:45:38.897[36m [info] [mcp_client.go:31] [0m从设备工具中找到: self.audio_speaker.set_volume
2025-07-24 08:45:38.897[36m [info] [llm.go:261] [0m进行工具调用请求: self.audio_speaker.set_volume, 参数: {"volume": 80}
2025-07-24 08:45:38.916[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"mcp","payload":{"jsonrpc":"2.0","id":4,"result":{"content":[{"type":"text","text":"true"}],"isError":false}}}
2025-07-24 08:45:38.916[36m [info] [llm.go:274] [0m工具调用结果: true, 耗时: 19ms
2025-07-24 08:45:38.916[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, requestEinoMessages: [user: 把声音调到80 。 assistant: 
tool_calls: [{0xc0000142c8 call_b1d03753de9b47128440dd function {self.audio_speaker.set_volume {"volume": 80}} map[]}] tool: true
tool_call_id: call_b1d03753de9b47128440dd]
2025-07-24 08:45:38.916[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, Type: openai
2025-07-24 08:45:38.916[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:38.916[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, context状态: <nil>
2025-07-24 08:45:38.916[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: 2
2025-07-24 08:45:38.916[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:45:38.939[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, tools: []
2025-07-24 08:45:38.939[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:45:39.304[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 已
finish_reason: 
2025-07-24 08:45:39.305[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"已","response_meta":{}}
2025-07-24 08:45:39.386[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 将音量调整
finish_reason: 
2025-07-24 08:45:39.388[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"将音量调整","response_meta":{}}
2025-07-24 08:45:39.449[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 到80。
finish_reason: 
2025-07-24 08:45:39.450[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"到80。","response_meta":{}}
2025-07-24 08:45:39.450[36m [info] [llm.go:107] [0m耗时统计: llm工具首句: 534 ms
2025-07-24 08:45:39.450[36m [info] [llm.go:109] [0m处理完整句子: 已将音量调整到80。
2025-07-24 08:45:39.470[37m [debug] [llm.go:178] [0mLLM 响应: {Text:已将音量调整到80。 IsStart:true IsEnd:false ToolCalls:[]}
2025-07-24 08:45:39.470[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:45:39.911[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:45:39.911[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:45:39.913[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 443 ms
2025-07-24 08:45:39.913[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 443 ms
2025-07-24 08:45:39.914[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1886 ms
2025-07-24 08:45:39.914[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:45:39.916[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 32
2025-07-24 08:45:39.917[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 58
2025-07-24 08:45:39.918[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 76
2025-07-24 08:45:39.933[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 143
2025-07-24 08:45:40.395[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共13个片段
2025-07-24 08:45:40.882[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: :  若要进行其他设置
finish_reason: 
2025-07-24 08:45:40.883[36m [info] [llm.go:96] [0m收到message: {"role":"","content":" 若要进行其他设置","response_meta":{}}
2025-07-24 08:45:40.948[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 或有更多问题
finish_reason: 
2025-07-24 08:45:40.948[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"或有更多问题","response_meta":{}}
2025-07-24 08:45:41.073[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，请告诉我！
finish_reason: stop
2025-07-24 08:45:41.074[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: 
usage: &{460 22 482}
2025-07-24 08:45:41.074[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:45:41.075[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:41.074[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"，请告诉我！","response_meta":{"finish_reason":"stop"}}
2025-07-24 08:45:41.076[36m [info] [llm.go:109] [0m处理完整句子: 若要进行其他设置或有更多问题，请告诉我！
2025-07-24 08:45:41.076[37m [debug] [llm.go:59] [0mfull Response with 0 tools, fullText: 已将音量调整到80。 若要进行其他设置或有更多问题，请告诉我！
2025-07-24 08:45:42.335[37m [debug] [llm.go:178] [0mLLM 响应: {Text:若要进行其他设置或有更多问题，请告诉我！ IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 08:45:42.336[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:45:42.752[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:45:42.752[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:45:42.752[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 416 ms
2025-07-24 08:45:42.753[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 417 ms
2025-07-24 08:45:42.753[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:45:42.755[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 38
2025-07-24 08:45:42.769[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 83
2025-07-24 08:45:42.772[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 87
2025-07-24 08:45:42.775[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 150
2025-07-24 08:45:43.293[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共17个片段
2025-07-24 08:45:46.317[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:45:46.317[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:45:46.317[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 08:45:46.317[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:45:46.317[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:46.317[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:45:46.317[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:46.508[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:45:46.508[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:45:46.508[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:45:46.508[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:45:46.508[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:45:46.508[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:45:46.508[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:45:47.123[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 08:45:47.186[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.246[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.307[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.381[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.441[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.502[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.561[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.605[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.665[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.726[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.787[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.856[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.921[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:47.985[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:48.201[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:45:48.290[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":805,"punc":"。","start":30,"text_seg":"讲 个 故 事 吧","ts_list":[[30,130],[130,210],[210,350],[350,450],[450,805]]}],"text":"讲个故事吧。","timestamp":"[[30,130],[130,210],[210,350],[350,450],[450,805]]","wav_name":"stream"}
2025-07-24 08:45:48.290[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:45:48.290[37m [debug] [asr.go:40] [0masr result: 讲个故事吧。, ok: true, isFinal: true
2025-07-24 08:45:48.290[37m [debug] [session.go:490] [0m处理asr结果: 讲个故事吧。, 耗时: 89 ms
2025-07-24 08:45:48.290[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 讲个故事吧。
2025-07-24 08:45:48.290[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 08:45:48.290[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 08:45:48.290[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [exit_chat self.screen.set_brightness self.screen.set_theme self.get_device_status self.audio_speaker.set_volume]
2025-07-24 08:45:48.290[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, requestEinoMessages: [user: 讲个故事吧。]
2025-07-24 08:45:48.290[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, Type: openai
2025-07-24 08:45:48.290[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:48.290[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, context状态: <nil>
2025-07-24 08:45:48.290[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:45:48.290[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:45:48.308[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, tools: [0xc00057f8c0 0xc00057f8f0 0xc00057f920 0xc00057f950 0xc00057f980]
2025-07-24 08:45:48.308[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:45:48.624[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 从前
finish_reason: 
2025-07-24 08:45:48.625[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"从前","response_meta":{}}
2025-07-24 08:45:48.645[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，在
finish_reason: 
2025-07-24 08:45:48.646[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"，在","response_meta":{}}
2025-07-24 08:45:48.666[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 一个
finish_reason: 
2025-07-24 08:45:48.667[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"一个","response_meta":{}}
2025-07-24 08:45:48.749[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 遥远的国度里
finish_reason: 
2025-07-24 08:45:48.750[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"遥远的国度里","response_meta":{}}
2025-07-24 08:45:48.854[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，有一片被
finish_reason: 
2025-07-24 08:45:48.854[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"，有一片被","response_meta":{}}
2025-07-24 08:45:48.896[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 茂密森林覆盖
finish_reason: 
2025-07-24 08:45:48.897[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"茂密森林覆盖","response_meta":{}}
2025-07-24 08:45:48.980[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 的神秘土地。
finish_reason: 
2025-07-24 08:45:48.981[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"的神秘土地。","response_meta":{}}
2025-07-24 08:45:48.981[36m [info] [llm.go:107] [0m耗时统计: llm工具首句: 691 ms
2025-07-24 08:45:48.981[36m [info] [llm.go:109] [0m处理完整句子: 在一个遥远的国度里，有一片被茂密森林覆盖的神秘土地。
2025-07-24 08:45:49.001[37m [debug] [llm.go:178] [0mLLM 响应: {Text:在一个遥远的国度里，有一片被茂密森林覆盖的神秘土地。 IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 08:45:49.002[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 08:45:49.085[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 在这片土地上
finish_reason: 
2025-07-24 08:45:49.085[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"在这片土地上","response_meta":{}}
2025-07-24 08:45:49.169[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，住着一位
finish_reason: 
2025-07-24 08:45:49.169[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"，住着一位","response_meta":{}}
2025-07-24 08:45:49.253[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 年轻的王子，名叫
finish_reason: 
2025-07-24 08:45:49.254[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"年轻的王子，名叫","response_meta":{}}
2025-07-24 08:45:49.299[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"mcp","payload":{"jsonrpc":"2.0","id":5,"error":{"message":"Method not implemented: ping"}}}
2025-07-24 08:45:49.299[37m [debug] [device_manager.go:241] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 ping失败: Method not implemented: ping
2025-07-24 08:45:49.363[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 艾登。艾
finish_reason: 
2025-07-24 08:45:49.363[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"艾登。艾","response_meta":{}}
2025-07-24 08:45:49.363[36m [info] [llm.go:109] [0m处理完整句子: 在这片土地上，住着一位年轻的王子，名叫艾登。
2025-07-24 08:45:49.409[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 登不仅英俊
finish_reason: 
2025-07-24 08:45:49.409[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"登不仅英俊","response_meta":{}}
2025-07-24 08:45:49.428[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 08:45:49.429[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 08:45:49.430[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 429 ms
2025-07-24 08:45:49.431[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 430 ms
2025-07-24 08:45:49.431[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 08:45:49.450[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 37
2025-07-24 08:45:49.487[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 潇洒，而且心
finish_reason: 
2025-07-24 08:45:49.488[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"潇洒，而且心","response_meta":{}}
2025-07-24 08:45:49.530[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 41
2025-07-24 08:45:49.552[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 90
2025-07-24 08:45:49.553[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 110
2025-07-24 08:45:49.582[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 地善良，深受
finish_reason: 
2025-07-24 08:45:49.583[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"地善良，深受","response_meta":{}}
2025-07-24 08:45:49.634[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 人民的爱戴
finish_reason: 
2025-07-24 08:45:49.635[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"人民的爱戴","response_meta":{}}
2025-07-24 08:45:49.720[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"mcp","payload":{"jsonrpc":"2.0","id":6,"error":{"message":"Method not implemented: ping"}}}
2025-07-24 08:45:49.720[37m [debug] [device_manager.go:241] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 ping失败: Method not implemented: ping
2025-07-24 08:45:50.076[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 。然而，他的
finish_reason: 
2025-07-24 08:45:50.076[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"。然而，他的","response_meta":{}}
2025-07-24 08:45:50.077[36m [info] [llm.go:109] [0m处理完整句子: 艾登不仅英俊潇洒，而且心地善良，深受人民的爱戴。
2025-07-24 08:45:50.192[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 国家正面临着一个
finish_reason: 
2025-07-24 08:45:50.193[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"国家正面临着一个","response_meta":{}}
2025-07-24 08:45:50.234[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 巨大的威胁——一条
finish_reason: 
2025-07-24 08:45:50.235[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"巨大的威胁——一条","response_meta":{}}
2025-07-24 08:45:50.339[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共24个片段
2025-07-24 08:45:50.371[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 凶猛的恶
finish_reason: 
2025-07-24 08:45:50.372[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"凶猛的恶","response_meta":{}}
2025-07-24 08:45:50.479[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 龙在森林深处
finish_reason: 
2025-07-24 08:45:50.479[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"龙在森林深处","response_meta":{}}
2025-07-24 08:45:50.584[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 出没，四处
finish_reason: 
2025-07-24 08:45:50.585[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"出没，四处","response_meta":{}}
2025-07-24 08:45:50.662[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 破坏，使得人们
finish_reason: 
2025-07-24 08:45:50.662[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"破坏，使得人们","response_meta":{}}
2025-07-24 08:45:50.902[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 无法安宁地生活
finish_reason: 
2025-07-24 08:45:50.903[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"无法安宁地生活","response_meta":{}}
2025-07-24 08:45:50.944[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 。

艾登王子
finish_reason: 
2025-07-24 08:45:50.945[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"。\n\n艾登王子","response_meta":{}}
2025-07-24 08:45:50.945[36m [info] [llm.go:109] [0m处理完整句子: 然而，他的国家正面临着一个巨大的威胁——一条凶猛的恶龙在森林深处出没，四处破坏，使得人们无法安宁地生活。
2025-07-24 08:45:51.017[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 决定挺身而出
finish_reason: 
2025-07-24 08:45:51.136[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，去森林里
finish_reason: 
2025-07-24 08:45:51.180[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 寻找并打败恶
finish_reason: 
2025-07-24 08:45:51.299[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 龙，保护自己的
finish_reason: 
2025-07-24 08:45:51.450[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 子民。他
finish_reason: 
2025-07-24 08:45:51.812[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"abort","reason":"wake_word_detected"}
2025-07-24 08:45:51.812[36m [info] [session.go:364] [0m设备  abort 会话
2025-07-24 08:45:51.812[36m [info] [tts.go:225] [0mSendTTSAudio context done, exit, totalFrames: 42
2025-07-24 08:45:51.813[37m [debug] [llm.go:189] [0mhandleLLMResponse end
2025-07-24 08:45:51.813[31m [error] [llm.go:338] [0m处理 LLM 响应失败, seesionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, error: TTS 处理上下文已取消
2025-07-24 08:45:51.813[31m [error] [session.go:657] [0m发送带工具的 LLM 请求失败, seesionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, error: TTS 处理上下文已取消
2025-07-24 08:45:51.813[31m [error] [session.go:572] [0m处理对话失败: 发送带工具的 LLM 请求失败: TTS 处理上下文已取消
2025-07-24 08:45:51.814[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:45:51.814[31m [error] [eino_llm.go:290] [0m接收流式响应失败: failed to receive stream chunk from OpenAI: context canceled
2025-07-24 08:45:51.814[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:51.845[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=","type":"listen","state":"start","mode":"auto"}
2025-07-24 08:45:51.846[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 08:45:51.846[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 08:45:51.846[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:45:51.846[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:45:51.846[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 08:45:51.846[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 08:45:51.995[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:52.018[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:52.080[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:52.329[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:45:52.332[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"text":"","wav_name":"stream"}
2025-07-24 08:45:52.332[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:45:52.332[37m [debug] [asr.go:40] [0masr result: , ok: true, isFinal: true
2025-07-24 08:45:52.332[37m [debug] [session.go:490] [0m处理asr结果: , 耗时: 3 ms
2025-07-24 08:45:52.332[37m [debug] [session.go:519] [0mready Restart Asr, s.clientState.Status: listenStop
2025-07-24 08:45:52.332[33m [warning] [session.go:524] [0mASR识别结果为空，尝试重启ASR识别, diff ts: %!s(int64=1)
2025-07-24 08:45:52.332[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 08:45:52.332[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 08:45:53.104[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 08:45:53.177[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:53.232[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:53.308[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:53.321[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:53.381[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:53.456[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:53.516[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:53.583[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:53.657[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:53.714[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:53.767[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:53.797[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 08:45:54.051[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 08:45:54.129[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":715,"punc":"。","start":30,"text_seg":"你 退 下 吧","ts_list":[[30,150],[150,230],[230,390],[390,715]]}],"text":"你退下吧。","timestamp":"[[30,150],[150,230],[230,390],[390,715]]","wav_name":"stream"}
2025-07-24 08:45:54.129[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 08:45:54.129[37m [debug] [asr.go:40] [0masr result: 你退下吧。, ok: true, isFinal: true
2025-07-24 08:45:54.129[37m [debug] [session.go:490] [0m处理asr结果: 你退下吧。, 耗时: 78 ms
2025-07-24 08:45:54.129[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 你退下吧。
2025-07-24 08:45:54.129[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 08:45:54.129[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 08:45:54.129[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [self.screen.set_brightness exit_chat self.screen.set_theme self.get_device_status self.audio_speaker.set_volume]
2025-07-24 08:45:54.129[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, requestEinoMessages: [user: 你退下吧。]
2025-07-24 08:45:54.129[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, Type: openai
2025-07-24 08:45:54.129[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:54.129[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, context状态: <nil>
2025-07-24 08:45:54.129[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 08:45:54.129[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 08:45:54.145[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=, tools: [0xc0005cb140 0xc0005cb170 0xc0005cb1a0 0xc0005cb1d0 0xc0005cb200]
2025-07-24 08:45:54.147[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 08:45:55.021[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc0006ba740 call_a0333184a3c14562b794cb function {exit_chat } map[]}]
finish_reason: 
2025-07-24 08:45:55.187[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc0006ba7d8  function { {}} map[]}]
finish_reason: 
2025-07-24 08:45:55.187[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{427 12 439}
2025-07-24 08:45:55.187[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 08:45:55.187[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:55.188[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_a0333184a3c14562b794cb","type":"function","function":{"name":"exit_chat","arguments":"{}"}}]}
2025-07-24 08:45:55.188[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc0006ba740 ID:call_a0333184a3c14562b794cb Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 08:45:55.188[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 
2025-07-24 08:45:55.188[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc0006ba740 ID:call_a0333184a3c14562b794cb Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]}
2025-07-24 08:45:55.188[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc0006ba740 ID:call_a0333184a3c14562b794cb Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 08:45:55.188[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 08:45:55.188[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 08:45:55.188[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 08:45:55.188[36m [info] [mcp_client.go:11] [0m查找工具: exit_chat (设备: 98:a3:16:d1:04:24)
2025-07-24 08:45:55.188[36m [info] [mcp_client.go:24] [0m找到本地工具: local_exit_chat
2025-07-24 08:45:55.188[36m [info] [llm.go:261] [0m进行工具调用请求: exit_chat, 参数: {}
2025-07-24 08:45:55.188[36m [info] [local_tools.go:82] [0m执行退出对话工具，参数: {}
2025-07-24 08:45:55.188[36m [info] [manager_registry.go:95] [0m通过注册表关闭设备 98:a3:16:d1:04:24 的ChatManager
2025-07-24 08:45:55.188[36m [info] [chat.go:145] [0m主动关闭断开连接, 设备 98:a3:16:d1:04:24
2025-07-24 08:45:55.189[31m [error] [websocket_conn.go:56] [0mread message error: read tcp 192.168.6.164:8989->192.168.7.45:62080: use of closed network connection
2025-07-24 08:45:55.189[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 08:45:55.190[36m [info] [manager_registry.go:51] [0m注销ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 08:45:55.190[36m [info] [device_manager.go:44] [0m设备 98:a3:16:d1:04:24 MCP客户端已移除并取消上下文
2025-07-24 08:45:55.190[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 08:45:55.190[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 08:45:55.190[36m [info] [local_tools.go:128] [0m设备 98:a3:16:d1:04:24 对话已退出，原因: 用户请求退出对话
2025-07-24 08:45:55.191[36m [info] [llm.go:274] [0m工具调用结果: {"device_id":"98:a3:16:d1:04:24","message":"对话已成功退出","reason":"用户请求退出对话","success":true}, 耗时: 3ms
2025-07-24 08:45:55.191[36m [info] [llm.go:279] [0m工具 exit_chat 标记为不回传结果给LLM，跳过回传
2025-07-24 08:45:55.191[36m [info] [llm.go:301] [0m所有工具都标记为不回传结果，跳过LLM处理
2025-07-24 08:45:55.191[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 08:45:55.191[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: I4yHFSuNUxkGstFopjwHj1Iv6KG0k4KrK_u05zsuXkE=
2025-07-24 08:45:55.191[37m [debug] [session.go:565] [0mprocessChatText end
2025-07-24 08:45:55.191[37m [debug] [session.go:147] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 08:45:55.191[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 08:45:55.191[36m [info] [session.go:134] [0m收到文本消息: 
2025-07-24 08:45:55.191[31m [error] [session.go:171] [0m解析消息失败: unexpected end of JSON input
2025-07-24 08:45:55.192[31m [error] [session.go:136] [0m处理文本消息失败: 解析消息失败: unexpected end of JSON input
2025-07-24 08:45:55.192[36m [info] [session.go:126] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 08:46:49.251[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 1
2025-07-24 08:46:49.252[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 0
[36mINFO[0m[0000] pprof服务已禁用                                    [36mcaller[0m="main.go:43"
[36mINFO[0m[0000] 已设置退出对话函数                                     [36mcaller[0m="local_tools.go:145"
[36mINFO[0m[0000] UDP服务器启动在 0.0.0.0:8990                        [36mcaller[0m="udp_server.go:61"
[36mINFO[0m[0000] MQTT 服务器启动，监听 0.0.0.0:2883 地址...              [36mcaller[0m="mqtt_server.go:80"
[36mINFO[0m[0000] === MCP配置检查 ===                               [36mcaller[0m="config_checker.go:14"
[36mINFO[0m[0000] 全局MCP启用状态: true                               [36mcaller[0m="config_checker.go:18"
[36mINFO[0m[0000] 重连配置: 间隔=5秒, 最大尝试次数=10                        [36mcaller[0m="config_checker.go:28"
[36mINFO[0m[0000] 共配置了 2 个MCP服务器:                               [36mcaller[0m="config_checker.go:42"
[36mINFO[0m[0000]   [1] ✅ filesystem (URL: http://localhost:3001/sse, 启用: false)  [36mcaller[0m="config_checker.go:82"
[36mINFO[0m[0000]   [2] ✅ memory (URL: http://localhost:3002/sse, 启用: false)  [36mcaller[0m="config_checker.go:82"
[36mINFO[0m[0000] 配置检查完成: 0个服务器已启用, 0个存在问题                      [36mcaller[0m="config_checker.go:87"
[36mINFO[0m[0000] --- 设备MCP配置检查 ---                             [36mcaller[0m="config_checker.go:101"
[36mINFO[0m[0000] 设备MCP启用状态: true                               [36mcaller[0m="config_checker.go:104"
[36mINFO[0m[0000] WebSocket路径: /xiaozhi/mcp/                    [36mcaller[0m="config_checker.go:114"
[36mINFO[0m[0000] 每设备最大连接数: 5                                   [36mcaller[0m="config_checker.go:115"
[36mINFO[0m[0000] === MCP配置检查完成 ===                             [36mcaller[0m="config_checker.go:96"
[36mINFO[0m[0000] 已注册本地工具: local_exit_chat                      [36mcaller[0m="manage.go:352"
[36mINFO[0m[0000] 已注册 1 个本地工具                                   [36mcaller[0m="manage.go:355"
[36mINFO[0m[0000] 从配置中读取到 2 个MCP服务器配置                           [36mcaller[0m="manage.go:103"
[36mINFO[0m[0000] MCP服务器[1]: Name=filesystem, SSEUrl=http://localhost:3001/sse, Enabled=false  [36mcaller[0m="manage.go:107"
[36mINFO[0m[0000] MCP服务器[2]: Name=memory, SSEUrl=http://localhost:3002/sse, Enabled=false  [36mcaller[0m="manage.go:107"
[36mINFO[0m[0000] MCP服务器 filesystem 已禁用，跳过连接                    [36mcaller[0m="manage.go:122"
[36mINFO[0m[0000] MCP服务器 memory 已禁用，跳过连接                        [36mcaller[0m="manage.go:122"
[36mINFO[0m[0000] 成功连接了 0 个MCP服务器                               [36mcaller[0m="manage.go:126"
[36mINFO[0m[0000] 全局MCP管理器已启动                                   [36mcaller[0m="manage.go:131"
[36mINFO[0m[0000] WebSocket 服务器启动在 ws://0.0.0.0:8989/xiaozhi/v1/  [36mcaller[0m="websocket_server.go:100"
[36mINFO[0m[0000] MCP WebSocket 端点: ws://0.0.0.0:8989/xiaozhi/mcp/{deviceId}  [36mcaller[0m="websocket_server.go:101"
[36mINFO[0m[0000] MCP API 端点: http://0.0.0.0:8989/xiaozhi/api/mcp/tools/{deviceId}  [36mcaller[0m="websocket_server.go:102"
[36mINFO[0m[0000] MQTT已连接                                       [36mcaller[0m="mqtt_udp_adapter.go:84"
[36mINFO[0m[0000] === 收到订阅包 ===                                 [36mcaller[0m="device_hook.go:106"
[36mINFO[0m[0000] 客户端ID: xiaozhi_server                         [36mcaller[0m="device_hook.go:107"
[36mINFO[0m[0000] 包类型: 8                                        [36mcaller[0m="device_hook.go:108"
[36mINFO[0m[0000] 包ID: 1                                        [36mcaller[0m="device_hook.go:109"
[36mINFO[0m[0000] 订阅信息:                                         [36mcaller[0m="device_hook.go:112"
[36mINFO[0m[0000]   1. 主题: /p2p/device_public/#, QoS: 0         [36mcaller[0m="device_hook.go:114"
[36mINFO[0m[0000] ==================                            [36mcaller[0m="device_hook.go:118"
2025-07-24 10:36:44.739[33m [warning] [userconfig.go:33] [0mRedis客户端未初始化
2025-07-24 10:36:44.739[36m [info] [base.go:36] [0mRedis用户配置提供者初始化成功
2025-07-24 10:36:44.739[36m [info] [chat.go:78] [0muserconfig: {SystemPrompt: Asr:{Provider:funasr Config:map[auto_end:true chunk_interval:10 chunk_size:[5 10 5] host:192.168.5.1 max_connections:5 mode:offline port:10095 sample_rate:16000 timeout:30]} Tts:{Provider:doubao_ws Config:map[access_token:pTt18L95cTdvgpBjnefFMEXsHaXgsU1k appid:9414688178 cluster:volcano_tts use_stream:true voice:zh_female_wanwanxiaohe_moon_bigtts ws_host:openspeech.bytedance.com]} Llm:{Provider:aliyun_qwen Config:map[api_key:sk-e740417c7bdb4deab05f17439e0c60c5 base_url:https://dashscope.aliyuncs.com/compatible-mode/v1 max_token:500 model_name:qwen2.5-72b-instruct type:openai]} Vad:{Provider:webrtc_vad Config:map[pool_max_idle:100 pool_max_size:1000 pool_min_size:5 vad_mode:2 vad_sample_rate:16000]}}
2025-07-24 10:36:44.739[33m [warning] [llm_memory.go:35] [0mRedis客户端未初始化
2025-07-24 10:36:44.739[33m [warning] [chat.go:96] [0mredis client is nil
2025-07-24 10:36:44.739[36m [info] [manager_registry.go:41] [0m注册ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 10:36:44.739[37m [debug] [eino_llm.go:163] [0mopenaiConfig: &{APIKey:sk-e740417c7bdb4deab05f17439e0c60c5 Timeout:0s HTTPClient:<nil> ByAzure:false BaseURL:https://dashscope.aliyuncs.com/compatible-mode/v1 APIVersion: Model:qwen2.5-72b-instruct MaxTokens:<nil> Temperature:<nil> TopP:<nil> Stop:[] PresencePenalty:<nil> ResponseFormat:<nil> Seed:<nil> FrequencyPenalty:<nil> LogitBias:map[] User:<nil>}
2025-07-24 10:36:44.739[36m [info] [eino_llm.go:171] [0m成功创建OpenAI ChatModel，模型: qwen2.5-72b-instruct
2025-07-24 10:36:44.739[37m [debug] [session.go:558] [0mprocessChatText start
2025-07-24 10:36:44.762[36m [info] [session.go:134] [0m收到文本消息: {"type":"hello","version":1,"features":{"mcp":true},"transport":"websocket","audio_params":{"format":"opus","sample_rate":16000,"channels":1,"frame_duration":60}}
2025-07-24 10:36:44.780[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:44.833[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:44.836[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:44.836[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:44.836[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:44.836[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:36:45.135[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"cXrsNWk1sWwMZKKI498tk4OiYqWtZQt-LihOi-c8LtA=","type":"listen","state":"detect","text":"你好小智"}
2025-07-24 10:36:45.135[37m [debug] [llm.go:76] [0mAddTextToTTSQueue text: 你好，我是小智，很高兴认识你。
2025-07-24 10:36:45.135[37m [debug] [llm.go:93] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 10:36:45.135[36m [info] [session.go:299] [0m设备  更新音频监听状态: detect
2025-07-24 10:36:45.135[37m [debug] [llm.go:60] [0mprocessLLMResponseQueue item: {ctx:0xc0000c1a90 requestEinoMessages:[] responseChan:0xc0002f7b20 onStartFunc:0x12cedc0 onEndFunc:0x12ced60}
2025-07-24 10:36:45.135[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 10:36:45.135[37m [debug] [llm.go:178] [0mLLM 响应: {Text:你好，我是小智，很高兴认识你。 IsStart:true IsEnd:true ToolCalls:[]}
2025-07-24 10:36:45.145[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"cXrsNWk1sWwMZKKI498tk4OiYqWtZQt-LihOi-c8LtA=","type":"listen","state":"start","mode":"auto"}
2025-07-24 10:36:45.145[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 10:36:45.145[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 10:36:45.145[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 10:36:45.155[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 1
2025-07-24 10:36:45.156[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 10:36:45.156[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 10:36:45.156[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 10:36:45.156[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"cXrsNWk1sWwMZKKI498tk4OiYqWtZQt-LihOi-c8LtA=","type":"mcp","payload":{"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"xiaoxin-esp32s3-154-4G","version":"1.7.6"}}}}
2025-07-24 10:36:45.156[36m [info] [device_manager.go:294] [0m收到MCP服务器通知: notifications/initialized
2025-07-24 10:36:45.176[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"cXrsNWk1sWwMZKKI498tk4OiYqWtZQt-LihOi-c8LtA=","type":"mcp","payload":{"jsonrpc":"2.0","id":2,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 10:36:45.177[36m [info] [device_manager.go:223] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 获取工具列表成功: map[self.audio_speaker.set_volume:0xc000106940 self.get_device_status:0xc000106900 self.screen.set_brightness:0xc000106980 self.screen.set_theme:0xc000106a00]
2025-07-24 10:36:45.382[37m [debug] [doubao_ws.go:324] [0m创建新的doubao WebSocket连接，使用全局Dialer配置(读取缓冲区: 16KB，最大消息: 1MB)
2025-07-24 10:36:45.773[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:36:45.773[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:36:45.774[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 639 ms
2025-07-24 10:36:45.775[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 640 ms
2025-07-24 10:36:45.775[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1753324605775 ms
2025-07-24 10:36:45.775[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:36:45.782[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 43
2025-07-24 10:36:45.889[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 49
2025-07-24 10:36:45.892[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 72
2025-07-24 10:36:45.895[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 150
2025-07-24 10:36:46.297[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共14个片段
2025-07-24 10:36:48.776[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 10:36:48.778[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 10:36:48.851[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"cXrsNWk1sWwMZKKI498tk4OiYqWtZQt-LihOi-c8LtA=","type":"listen","state":"start","mode":"auto"}
2025-07-24 10:36:48.851[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 10:36:48.851[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 10:36:48.851[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:36:48.851[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 10:36:48.855[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 2
2025-07-24 10:36:48.855[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 10:36:48.856[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 10:36:48.856[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 10:36:48.856[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"text":"","wav_name":"stream"}
2025-07-24 10:36:48.856[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 10:36:48.856[37m [debug] [asr.go:40] [0masr result: , ok: true, isFinal: true
2025-07-24 10:36:48.856[37m [debug] [session.go:490] [0m处理asr结果: , 耗时: 1753324608856 ms
2025-07-24 10:36:48.856[37m [debug] [session.go:519] [0mready Restart Asr, s.clientState.Status: init
2025-07-24 10:36:51.180[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 10:36:51.249[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:51.300[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:51.376[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:51.407[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:51.465[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:51.537[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:51.611[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:51.661[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:51.753[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:51.779[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:51.855[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:52.080[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:36:52.750[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":685,"punc":"。","start":30,"text_seg":"你 退 下 吧","ts_list":[[30,110],[110,230],[230,390],[390,685]]}],"text":"你退下吧。","timestamp":"[[30,110],[110,230],[230,390],[390,685]]","wav_name":"stream"}
2025-07-24 10:36:52.750[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 10:36:52.750[37m [debug] [asr.go:40] [0masr result: 你退下吧。, ok: true, isFinal: true
2025-07-24 10:36:52.750[37m [debug] [session.go:490] [0m处理asr结果: 你退下吧。, 耗时: 669 ms
2025-07-24 10:36:52.751[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 你退下吧。
2025-07-24 10:36:52.751[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 10:36:52.751[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 10:36:52.751[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [self.audio_speaker.set_volume self.screen.set_brightness self.screen.set_theme exit_chat self.get_device_status]
2025-07-24 10:36:52.751[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: cXrsNWk1sWwMZKKI498tk4OiYqWtZQt-LihOi-c8LtA=, requestEinoMessages: [user: 你退下吧。]
2025-07-24 10:36:52.751[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: cXrsNWk1sWwMZKKI498tk4OiYqWtZQt-LihOi-c8LtA=, Type: openai
2025-07-24 10:36:52.751[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: cXrsNWk1sWwMZKKI498tk4OiYqWtZQt-LihOi-c8LtA=
2025-07-24 10:36:52.751[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: cXrsNWk1sWwMZKKI498tk4OiYqWtZQt-LihOi-c8LtA=, context状态: <nil>
2025-07-24 10:36:52.751[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 10:36:52.751[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 10:36:52.772[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: cXrsNWk1sWwMZKKI498tk4OiYqWtZQt-LihOi-c8LtA=, tools: [0xc0000034d0 0xc000003500 0xc000003530 0xc000003560 0xc000003590]
2025-07-24 10:36:52.772[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 10:36:53.913[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc0003bff98 call_9002407d71ac415997b457 function {exit_chat } map[]}]
finish_reason: 
2025-07-24 10:36:54.079[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc0004ce258  function { {}} map[]}]
finish_reason: 
2025-07-24 10:36:54.079[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{427 12 439}
2025-07-24 10:36:54.080[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 10:36:54.080[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: cXrsNWk1sWwMZKKI498tk4OiYqWtZQt-LihOi-c8LtA=
2025-07-24 10:36:54.080[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_9002407d71ac415997b457","type":"function","function":{"name":"exit_chat","arguments":"{}"}}]}
2025-07-24 10:36:54.080[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc0003bff98 ID:call_9002407d71ac415997b457 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 10:36:54.080[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 
2025-07-24 10:36:54.080[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc0003bff98 ID:call_9002407d71ac415997b457 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]}
2025-07-24 10:36:54.080[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc0003bff98 ID:call_9002407d71ac415997b457 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 10:36:54.080[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 10:36:54.080[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 10:36:54.080[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 10:36:54.080[36m [info] [mcp_client.go:11] [0m查找工具: exit_chat (设备: 98:a3:16:d1:04:24)
2025-07-24 10:36:54.080[36m [info] [mcp_client.go:24] [0m找到本地工具: local_exit_chat
2025-07-24 10:36:54.080[36m [info] [llm.go:261] [0m进行工具调用请求: exit_chat, 参数: {}
2025-07-24 10:36:54.080[36m [info] [local_tools.go:80] [0m执行退出对话工具，参数: {}
2025-07-24 10:36:54.080[36m [info] [manager_registry.go:95] [0m通过注册表关闭设备 98:a3:16:d1:04:24 的ChatManager
2025-07-24 10:36:54.080[36m [info] [chat.go:145] [0m主动关闭断开连接, 设备 98:a3:16:d1:04:24
2025-07-24 10:36:54.081[31m [error] [websocket_conn.go:56] [0mread message error: read tcp 192.168.6.164:8989->192.168.7.45:51618: use of closed network connection
2025-07-24 10:36:54.081[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 10:36:54.081[36m [info] [manager_registry.go:51] [0m注销ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 10:36:54.081[36m [info] [device_manager.go:44] [0m设备 98:a3:16:d1:04:24 MCP客户端已移除并取消上下文
2025-07-24 10:36:54.081[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 10:36:54.081[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 10:36:54.081[36m [info] [local_tools.go:126] [0m设备 98:a3:16:d1:04:24 对话已退出，原因: 用户请求退出对话
2025-07-24 10:36:54.081[36m [info] [llm.go:274] [0m工具调用结果: {"device_id":"98:a3:16:d1:04:24","message":"对话已成功退出","reason":"用户请求退出对话","success":true}, 耗时: 1ms
2025-07-24 10:36:54.081[36m [info] [llm.go:279] [0m工具 exit_chat 标记为不回传结果给LLM，跳过回传
2025-07-24 10:36:54.081[36m [info] [llm.go:301] [0m所有工具都标记为不回传结果，跳过LLM处理
2025-07-24 10:36:54.082[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 10:36:54.082[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: cXrsNWk1sWwMZKKI498tk4OiYqWtZQt-LihOi-c8LtA=
2025-07-24 10:36:54.082[37m [debug] [session.go:565] [0mprocessChatText end
2025-07-24 10:36:54.082[37m [debug] [session.go:147] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 10:36:54.082[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 10:36:54.082[36m [info] [session.go:134] [0m收到文本消息: 
2025-07-24 10:36:54.082[31m [error] [session.go:171] [0m解析消息失败: unexpected end of JSON input
2025-07-24 10:36:54.082[31m [error] [session.go:136] [0m处理文本消息失败: 解析消息失败: unexpected end of JSON input
2025-07-24 10:36:54.082[36m [info] [session.go:126] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 10:36:59.618[33m [warning] [userconfig.go:33] [0mRedis客户端未初始化
2025-07-24 10:36:59.619[36m [info] [base.go:36] [0mRedis用户配置提供者初始化成功
2025-07-24 10:36:59.619[36m [info] [chat.go:78] [0muserconfig: {SystemPrompt: Asr:{Provider:funasr Config:map[auto_end:true chunk_interval:10 chunk_size:[5 10 5] host:192.168.5.1 max_connections:5 mode:offline port:10095 sample_rate:16000 timeout:30]} Tts:{Provider:doubao_ws Config:map[access_token:pTt18L95cTdvgpBjnefFMEXsHaXgsU1k appid:9414688178 cluster:volcano_tts use_stream:true voice:zh_female_wanwanxiaohe_moon_bigtts ws_host:openspeech.bytedance.com]} Llm:{Provider:aliyun_qwen Config:map[api_key:sk-e740417c7bdb4deab05f17439e0c60c5 base_url:https://dashscope.aliyuncs.com/compatible-mode/v1 max_token:500 model_name:qwen2.5-72b-instruct type:openai]} Vad:{Provider:webrtc_vad Config:map[pool_max_idle:100 pool_max_size:1000 pool_min_size:5 vad_mode:2 vad_sample_rate:16000]}}
2025-07-24 10:36:59.619[33m [warning] [chat.go:96] [0mredis client is nil
2025-07-24 10:36:59.619[36m [info] [manager_registry.go:41] [0m注册ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 10:36:59.619[37m [debug] [eino_llm.go:163] [0mopenaiConfig: &{APIKey:sk-e740417c7bdb4deab05f17439e0c60c5 Timeout:0s HTTPClient:<nil> ByAzure:false BaseURL:https://dashscope.aliyuncs.com/compatible-mode/v1 APIVersion: Model:qwen2.5-72b-instruct MaxTokens:<nil> Temperature:<nil> TopP:<nil> Stop:[] PresencePenalty:<nil> ResponseFormat:<nil> Seed:<nil> FrequencyPenalty:<nil> LogitBias:map[] User:<nil>}
2025-07-24 10:36:59.619[36m [info] [eino_llm.go:171] [0m成功创建OpenAI ChatModel，模型: qwen2.5-72b-instruct
2025-07-24 10:36:59.619[37m [debug] [session.go:558] [0mprocessChatText start
2025-07-24 10:36:59.638[36m [info] [session.go:134] [0m收到文本消息: {"type":"hello","version":1,"features":{"mcp":true},"transport":"websocket","audio_params":{"format":"opus","sample_rate":16000,"channels":1,"frame_duration":60}}
2025-07-24 10:36:59.822[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 10:36:59.843[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:59.853[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:59.873[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:59.883[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:59.905[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:59.913[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:59.925[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:59.941[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:59.958[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:59.969[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:36:59.981[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:00.016[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=","type":"listen","state":"detect","text":"你好小智"}
2025-07-24 10:37:00.016[37m [debug] [llm.go:76] [0mAddTextToTTSQueue text: 你好，我是小智，今天有啥好玩的。
2025-07-24 10:37:00.017[37m [debug] [llm.go:93] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 10:37:00.017[36m [info] [session.go:299] [0m设备  更新音频监听状态: detect
2025-07-24 10:37:00.017[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=","type":"listen","state":"start","mode":"auto"}
2025-07-24 10:37:00.017[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 10:37:00.017[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 10:37:00.017[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:37:00.017[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 10:37:00.017[37m [debug] [llm.go:60] [0mprocessLLMResponseQueue item: {ctx:0xc0000c0000 requestEinoMessages:[] responseChan:0xc0004349a0 onStartFunc:0x12cedc0 onEndFunc:0x12ced60}
2025-07-24 10:37:00.017[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 10:37:00.017[37m [debug] [llm.go:178] [0mLLM 响应: {Text:你好，我是小智，今天有啥好玩的。 IsStart:true IsEnd:true ToolCalls:[]}
2025-07-24 10:37:00.017[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 10:37:00.022[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 1
2025-07-24 10:37:00.023[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 10:37:00.023[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 10:37:00.023[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 10:37:00.024[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=","type":"mcp","payload":{"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"xiaoxin-esp32s3-154-4G","version":"1.7.6"}}}}
2025-07-24 10:37:00.024[36m [info] [device_manager.go:294] [0m收到MCP服务器通知: notifications/initialized
2025-07-24 10:37:00.059[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=","type":"mcp","payload":{"jsonrpc":"2.0","id":2,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 10:37:00.059[36m [info] [device_manager.go:223] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 获取工具列表成功: map[self.audio_speaker.set_volume:0xc0000c2240 self.get_device_status:0xc0000c2200 self.screen.set_brightness:0xc0000c2280 self.screen.set_theme:0xc0000c22c0]
2025-07-24 10:37:00.396[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:37:00.396[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:37:00.397[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 380 ms
2025-07-24 10:37:00.397[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 380 ms
2025-07-24 10:37:00.397[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1753324620397 ms
2025-07-24 10:37:00.397[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:37:00.398[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 37
2025-07-24 10:37:00.511[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 65
2025-07-24 10:37:00.513[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 80
2025-07-24 10:37:00.514[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 140
2025-07-24 10:37:01.030[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共16个片段
2025-07-24 10:37:03.875[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 10:37:03.875[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 10:37:03.959[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=","type":"listen","state":"start","mode":"auto"}
2025-07-24 10:37:03.960[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 10:37:03.960[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 10:37:03.960[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:37:03.960[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 10:37:03.965[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"text":"","wav_name":"stream"}
2025-07-24 10:37:03.965[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 10:37:03.965[37m [debug] [asr.go:40] [0masr result: , ok: true, isFinal: true
2025-07-24 10:37:03.965[37m [debug] [session.go:490] [0m处理asr结果: , 耗时: 1753324623965 ms
2025-07-24 10:37:03.965[37m [debug] [session.go:519] [0mready Restart Asr, s.clientState.Status: init
2025-07-24 10:37:03.966[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 2
2025-07-24 10:37:03.967[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 10:37:03.967[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 10:37:03.968[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 10:37:04.452[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 10:37:04.507[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:04.562[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:04.602[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:04.667[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:04.728[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:04.794[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:04.869[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:04.924[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:04.980[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:05.045[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:05.075[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:05.144[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:05.203[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:05.461[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:37:05.758[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":775,"punc":"。","start":30,"text_seg":"你 在 干 嘛 呢","ts_list":[[30,110],[110,190],[190,290],[290,450],[450,775]]}],"text":"你在干嘛呢。","timestamp":"[[30,110],[110,190],[190,290],[290,450],[450,775]]","wav_name":"stream"}
2025-07-24 10:37:05.758[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 10:37:05.758[37m [debug] [asr.go:40] [0masr result: 你在干嘛呢。, ok: true, isFinal: true
2025-07-24 10:37:05.758[37m [debug] [session.go:490] [0m处理asr结果: 你在干嘛呢。, 耗时: 297 ms
2025-07-24 10:37:05.759[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 你在干嘛呢。
2025-07-24 10:37:05.759[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 10:37:05.759[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 10:37:05.759[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [exit_chat self.screen.set_theme self.get_device_status self.audio_speaker.set_volume self.screen.set_brightness]
2025-07-24 10:37:05.759[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=, requestEinoMessages: [user: 你在干嘛呢。]
2025-07-24 10:37:05.759[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=, Type: openai
2025-07-24 10:37:05.759[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=
2025-07-24 10:37:05.759[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=, context状态: <nil>
2025-07-24 10:37:05.759[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 10:37:05.759[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 10:37:05.775[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=, tools: [0xc00033e720 0xc00033e750 0xc00033e780 0xc00033e7e0 0xc00033e810]
2025-07-24 10:37:05.775[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 10:37:06.112[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 我
finish_reason: 
2025-07-24 10:37:06.113[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"我","response_meta":{}}
2025-07-24 10:37:06.133[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 在这里
finish_reason: 
2025-07-24 10:37:06.134[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"在这里","response_meta":{}}
2025-07-24 10:37:06.154[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 是为了
finish_reason: 
2025-07-24 10:37:06.154[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"是为了","response_meta":{}}
2025-07-24 10:37:06.239[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 帮助你！请
finish_reason: 
2025-07-24 10:37:06.239[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"帮助你！请","response_meta":{}}
2025-07-24 10:37:06.239[36m [info] [llm.go:107] [0m耗时统计: llm工具首句: 480 ms
2025-07-24 10:37:06.239[36m [info] [llm.go:109] [0m处理完整句子: 我在这里是为了帮助你！
2025-07-24 10:37:06.261[37m [debug] [llm.go:178] [0mLLM 响应: {Text:我在这里是为了帮助你！ IsStart:true IsEnd:false ToolCalls:[]}
2025-07-24 10:37:06.262[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 10:37:06.429[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 告诉我你需要什么帮助
finish_reason: 
2025-07-24 10:37:06.429[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"告诉我你需要什么帮助","response_meta":{}}
2025-07-24 10:37:06.535[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 或者想要聊些什么
finish_reason: 
2025-07-24 10:37:06.536[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"或者想要聊些什么","response_meta":{}}
2025-07-24 10:37:06.661[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 。如果你对我的
finish_reason: 
2025-07-24 10:37:06.661[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"。如果你对我的","response_meta":{}}
2025-07-24 10:37:06.661[36m [info] [llm.go:109] [0m处理完整句子: 请告诉我你需要什么帮助或者想要聊些什么。
2025-07-24 10:37:06.682[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:37:06.682[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:37:06.682[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 420 ms
2025-07-24 10:37:06.683[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 421 ms
2025-07-24 10:37:06.683[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 925 ms
2025-07-24 10:37:06.684[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:37:06.704[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 40
2025-07-24 10:37:06.706[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 73
2025-07-24 10:37:06.708[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 86
2025-07-24 10:37:06.709[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 145
2025-07-24 10:37:06.724[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 功能感兴趣，也可以
finish_reason: 
2025-07-24 10:37:06.726[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"功能感兴趣，也可以","response_meta":{}}
2025-07-24 10:37:06.869[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 随时问我哦。
finish_reason: 
2025-07-24 10:37:06.870[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"随时问我哦。","response_meta":{}}
2025-07-24 10:37:06.870[36m [info] [llm.go:109] [0m处理完整句子: 如果你对我的功能感兴趣，也可以随时问我哦。
2025-07-24 10:37:06.916[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 😊
finish_reason: stop
2025-07-24 10:37:06.917[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: 
usage: &{426 28 454}
2025-07-24 10:37:06.918[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 10:37:06.918[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=
2025-07-24 10:37:06.917[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"😊","response_meta":{"finish_reason":"stop"}}
2025-07-24 10:37:06.918[36m [info] [llm.go:78] [0m处理剩余内容: 😊
2025-07-24 10:37:07.074[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共12个片段
2025-07-24 10:37:08.869[37m [debug] [llm.go:178] [0mLLM 响应: {Text:请告诉我你需要什么帮助或者想要聊些什么。 IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 10:37:08.871[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 10:37:08.873[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 我在这里是为了帮助你！请告诉我你需要什么帮助或者想要聊些什么。如果你对我的功能感兴趣，也可以随时问我哦。😊😊
2025-07-24 10:37:09.351[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:37:09.351[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:37:09.351[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 482 ms
2025-07-24 10:37:09.352[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 483 ms
2025-07-24 10:37:09.352[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:37:09.356[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 37
2025-07-24 10:37:09.465[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 76
2025-07-24 10:37:09.470[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 77
2025-07-24 10:37:09.471[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 131
2025-07-24 10:37:09.901[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共16个片段
2025-07-24 10:37:12.836[37m [debug] [llm.go:178] [0mLLM 响应: {Text:如果你对我的功能感兴趣，也可以随时问我哦。 IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 10:37:12.836[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 10:37:13.318[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:37:13.320[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:37:13.321[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 485 ms
2025-07-24 10:37:13.321[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 485 ms
2025-07-24 10:37:13.321[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:37:13.323[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 41
2025-07-24 10:37:13.332[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 45
2025-07-24 10:37:13.334[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 66
2025-07-24 10:37:13.335[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 133
2025-07-24 10:37:13.971[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共18个片段
2025-07-24 10:37:16.996[37m [debug] [llm.go:178] [0mLLM 响应: {Text:😊 IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 10:37:16.997[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 10:37:17.071[31m [error] [doubao_ws.go:458] [0m服务端错误 (代码: 3011): {"reqid":"2af22216-3b38-5a9e-23a1-72368036ef5a","error":"No readable text!","sequence":0}
2025-07-24 10:37:17.072[31m [error] [doubao_ws.go:236] [0m解析响应失败: 服务端错误 (代码: 3011): {"reqid":"2af22216-3b38-5a9e-23a1-72368036ef5a","error":"No readable text!","sequence":0}
2025-07-24 10:37:17.072[31m [error] [doubao_ws.go:207] [0mMP3解码器运行失败: 创建MP3解码器失败: mp3: io: read/write on closed pipe
2025-07-24 10:37:17.072[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 10:37:17.072[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 10:37:17.072[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 10:37:17.072[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=
2025-07-24 10:37:17.182[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=","type":"listen","state":"start","mode":"auto"}
2025-07-24 10:37:17.182[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 10:37:17.182[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 10:37:17.183[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 10:37:17.183[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 10:37:17.183[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 10:37:17.183[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 10:37:18.556[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 10:37:18.618[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:18.683[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:18.738[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:18.786[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:18.842[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:18.900[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:18.958[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:19.214[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:37:19.273[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":405,"punc":"。","start":50,"text_seg":"wifi","ts_list":[[50,405]]}],"text":"wifi。","timestamp":"[[50,405]]","wav_name":"stream"}
2025-07-24 10:37:19.274[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 10:37:19.276[37m [debug] [asr.go:40] [0masr result: wifi。, ok: true, isFinal: true
2025-07-24 10:37:19.276[37m [debug] [session.go:490] [0m处理asr结果: wifi。, 耗时: 62 ms
2025-07-24 10:37:19.277[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: wifi。
2025-07-24 10:37:19.277[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 10:37:19.277[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 10:37:19.277[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [self.screen.set_brightness self.screen.set_theme self.get_device_status exit_chat self.audio_speaker.set_volume]
2025-07-24 10:37:19.277[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=, requestEinoMessages: [user: wifi。]
2025-07-24 10:37:19.277[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=, Type: openai
2025-07-24 10:37:19.277[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=
2025-07-24 10:37:19.277[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=, context状态: <nil>
2025-07-24 10:37:19.277[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 10:37:19.277[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 10:37:19.294[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=, tools: [0xc0003b9e60 0xc0003b9e90 0xc0003b9ec0 0xc0003b9ef0 0xc0003b9f20]
2025-07-24 10:37:19.295[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 10:37:19.713[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 您
finish_reason: 
2025-07-24 10:37:19.714[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"您","response_meta":{}}
2025-07-24 10:37:19.734[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 想
finish_reason: 
2025-07-24 10:37:19.735[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"想","response_meta":{}}
2025-07-24 10:37:19.776[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 了解
finish_reason: 
2025-07-24 10:37:19.777[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"了解","response_meta":{}}
2025-07-24 10:37:19.943[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 有关 WiFi 的哪些
finish_reason: 
2025-07-24 10:37:19.944[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"有关 WiFi 的哪些","response_meta":{}}
2025-07-24 10:37:20.110[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 信息？例如，
finish_reason: 
2025-07-24 10:37:20.110[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"信息？例如，","response_meta":{}}
2025-07-24 10:37:20.111[36m [info] [llm.go:107] [0m耗时统计: llm工具首句: 834 ms
2025-07-24 10:37:20.111[36m [info] [llm.go:109] [0m处理完整句子: 您想了解有关 WiFi 的哪些信息？
2025-07-24 10:37:20.130[37m [debug] [llm.go:178] [0mLLM 响应: {Text:您想了解有关 WiFi 的哪些信息？ IsStart:true IsEnd:false ToolCalls:[]}
2025-07-24 10:37:20.236[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 您可以问我是否已
finish_reason: 
2025-07-24 10:37:20.238[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"您可以问我是否已","response_meta":{}}
2025-07-24 10:37:20.342[37m [debug] [doubao_ws.go:324] [0m创建新的doubao WebSocket连接，使用全局Dialer配置(读取缓冲区: 16KB，最大消息: 1MB)
2025-07-24 10:37:20.491[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 连接到 WiFi，
finish_reason: 
2025-07-24 10:37:20.492[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"连接到 WiFi，","response_meta":{}}
2025-07-24 10:37:20.620[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 或者要求我连接
finish_reason: 
2025-07-24 10:37:20.620[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"或者要求我连接","response_meta":{}}
2025-07-24 10:37:20.770[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:37:20.770[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:37:20.771[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 640 ms
2025-07-24 10:37:20.772[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 641 ms
2025-07-24 10:37:20.772[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1496 ms
2025-07-24 10:37:20.772[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:37:20.793[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 44
2025-07-24 10:37:20.812[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 到特定的 WiFi
finish_reason: 
2025-07-24 10:37:20.813[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"到特定的 WiFi","response_meta":{}}
2025-07-24 10:37:20.898[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 87
2025-07-24 10:37:20.919[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 92
2025-07-24 10:37:20.921[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 140
2025-07-24 10:37:21.279[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共13个片段
2025-07-24 10:37:24.412[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=","type":"abort","reason":"wake_word_detected"}
2025-07-24 10:37:24.413[36m [info] [session.go:364] [0m设备  abort 会话
2025-07-24 10:37:24.414[36m [info] [llm.go:70] [0m上下文已取消，停止LLM响应处理: context canceled, context done, exit
2025-07-24 10:37:24.414[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 您想了解有关 WiFi 的哪些信息？例如，您可以问我是否已连接到 WiFi，或者要求我连接到特定的 WiFi
2025-07-24 10:37:24.414[36m [info] [llm.go:233] [0m98:a3:16:d1:04:24 上下文已取消，停止处理LLM响应, context done, exit
2025-07-24 10:37:24.414[37m [debug] [llm.go:235] [0mhandleLLMResponse end
2025-07-24 10:37:24.415[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=
2025-07-24 10:37:24.416[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 10:37:24.416[31m [error] [eino_llm.go:290] [0m接收流式响应失败: failed to receive stream chunk from OpenAI: context canceled
2025-07-24 10:37:24.417[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=
2025-07-24 10:37:24.437[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=","type":"listen","state":"start","mode":"auto"}
2025-07-24 10:37:24.437[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 10:37:24.437[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 10:37:24.437[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 10:37:24.437[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 10:37:24.437[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 10:37:24.437[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 10:37:25.771[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 10:37:25.852[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:25.908[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:25.942[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:25.999[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:26.078[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:26.135[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:26.193[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:26.252[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:26.329[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:26.383[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:26.609[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:37:26.689[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":675,"punc":"。","start":150,"text_seg":"拜 拜","ts_list":[[150,350],[350,675]]}],"text":"拜拜。","timestamp":"[[150,350],[350,675]]","wav_name":"stream"}
2025-07-24 10:37:26.690[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 10:37:26.690[37m [debug] [asr.go:40] [0masr result: 拜拜。, ok: true, isFinal: true
2025-07-24 10:37:26.690[37m [debug] [session.go:490] [0m处理asr结果: 拜拜。, 耗时: 81 ms
2025-07-24 10:37:26.690[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 拜拜。
2025-07-24 10:37:26.690[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 10:37:26.690[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 10:37:26.690[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [self.audio_speaker.set_volume self.screen.set_brightness exit_chat self.screen.set_theme self.get_device_status]
2025-07-24 10:37:26.690[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=, requestEinoMessages: [user: 拜拜。]
2025-07-24 10:37:26.690[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=, Type: openai
2025-07-24 10:37:26.690[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=
2025-07-24 10:37:26.690[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=, context状态: <nil>
2025-07-24 10:37:26.690[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 10:37:26.690[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 10:37:26.710[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=, tools: [0xc00028f320 0xc00028f350 0xc00028f380 0xc00028f3b0 0xc00028f3e0]
2025-07-24 10:37:26.710[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 10:37:27.045[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 好的
finish_reason: 
2025-07-24 10:37:27.045[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"好的","response_meta":{}}
2025-07-24 10:37:27.087[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，
finish_reason: 
2025-07-24 10:37:27.088[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"，","response_meta":{}}
2025-07-24 10:37:27.127[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 如果您
finish_reason: 
2025-07-24 10:37:27.127[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"如果您","response_meta":{}}
2025-07-24 10:37:27.274[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 有需要随时欢迎
finish_reason: 
2025-07-24 10:37:27.275[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"有需要随时欢迎","response_meta":{}}
2025-07-24 10:37:27.442[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 回来。再见！
finish_reason: 
2025-07-24 10:37:27.443[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"回来。再见！","response_meta":{}}
2025-07-24 10:37:27.444[36m [info] [llm.go:107] [0m耗时统计: llm工具首句: 754 ms
2025-07-24 10:37:27.445[36m [info] [llm.go:109] [0m处理完整句子: 好的，如果您有需要随时欢迎回来。
2025-07-24 10:37:27.462[37m [debug] [llm.go:178] [0mLLM 响应: {Text:好的，如果您有需要随时欢迎回来。 IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 10:37:27.463[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 10:37:27.865[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:37:27.866[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:37:27.866[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 403 ms
2025-07-24 10:37:27.867[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 404 ms
2025-07-24 10:37:27.867[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:37:27.887[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 40
2025-07-24 10:37:27.909[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc00028c418 call_bacc4e6687bd4906a3f62c function {exit_chat } map[]}]
finish_reason: 
2025-07-24 10:37:27.995[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 79
2025-07-24 10:37:28.016[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 98
2025-07-24 10:37:28.019[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 137
2025-07-24 10:37:28.149[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc00039a070  function { {}} map[]}]
finish_reason: 
2025-07-24 10:37:28.149[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{425 24 449}
2025-07-24 10:37:28.150[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 10:37:28.151[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=
2025-07-24 10:37:28.169[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_bacc4e6687bd4906a3f62c","type":"function","function":{"name":"exit_chat","arguments":"{}"}}]}
2025-07-24 10:37:28.169[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc00028c418 ID:call_bacc4e6687bd4906a3f62c Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 10:37:28.169[36m [info] [llm.go:78] [0m处理剩余内容: 再见！
2025-07-24 10:37:28.169[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 好的，如果您有需要随时欢迎回来。再见！再见！
2025-07-24 10:37:28.372[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共15个片段
2025-07-24 10:37:29.654[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=","type":"mcp","payload":{"jsonrpc":"2.0","id":3,"error":{"message":"Method not implemented: ping"}}}
2025-07-24 10:37:29.654[37m [debug] [device_manager.go:241] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 ping失败: Method not implemented: ping
2025-07-24 10:37:30.050[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=","type":"mcp","payload":{"jsonrpc":"2.0","id":4,"error":{"message":"Method not implemented: ping"}}}
2025-07-24 10:37:30.051[37m [debug] [device_manager.go:241] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 ping失败: Method not implemented: ping
2025-07-24 10:37:31.259[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:false ToolCalls:[{Index:0xc00028c418 ID:call_bacc4e6687bd4906a3f62c Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]}
2025-07-24 10:37:31.260[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc00028c418 ID:call_bacc4e6687bd4906a3f62c Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 10:37:31.260[37m [debug] [llm.go:178] [0mLLM 响应: {Text:再见！ IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 10:37:31.260[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 10:37:31.677[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:37:31.677[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:37:31.677[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 417 ms
2025-07-24 10:37:31.677[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 417 ms
2025-07-24 10:37:31.677[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:37:31.684[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 40
2025-07-24 10:37:31.697[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 40
2025-07-24 10:37:31.699[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 79
2025-07-24 10:37:31.707[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 121
2025-07-24 10:37:31.910[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共9个片段
2025-07-24 10:37:33.149[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 10:37:33.149[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 10:37:33.149[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 10:37:33.149[36m [info] [mcp_client.go:11] [0m查找工具: exit_chat (设备: 98:a3:16:d1:04:24)
2025-07-24 10:37:33.149[36m [info] [mcp_client.go:24] [0m找到本地工具: local_exit_chat
2025-07-24 10:37:33.149[36m [info] [llm.go:261] [0m进行工具调用请求: exit_chat, 参数: {}
2025-07-24 10:37:33.149[36m [info] [local_tools.go:80] [0m执行退出对话工具，参数: {}
2025-07-24 10:37:33.150[36m [info] [manager_registry.go:95] [0m通过注册表关闭设备 98:a3:16:d1:04:24 的ChatManager
2025-07-24 10:37:33.150[36m [info] [chat.go:145] [0m主动关闭断开连接, 设备 98:a3:16:d1:04:24
2025-07-24 10:37:33.150[31m [error] [websocket_conn.go:56] [0mread message error: read tcp 192.168.6.164:8989->192.168.7.45:51619: use of closed network connection
2025-07-24 10:37:33.150[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 10:37:33.150[36m [info] [manager_registry.go:51] [0m注销ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 10:37:33.150[36m [info] [device_manager.go:44] [0m设备 98:a3:16:d1:04:24 MCP客户端已移除并取消上下文
2025-07-24 10:37:33.150[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 10:37:33.150[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 10:37:33.150[36m [info] [local_tools.go:126] [0m设备 98:a3:16:d1:04:24 对话已退出，原因: 用户请求退出对话
2025-07-24 10:37:33.150[36m [info] [llm.go:274] [0m工具调用结果: {"device_id":"98:a3:16:d1:04:24","message":"对话已成功退出","reason":"用户请求退出对话","success":true}, 耗时: 1ms
2025-07-24 10:37:33.150[36m [info] [llm.go:279] [0m工具 exit_chat 标记为不回传结果给LLM，跳过回传
2025-07-24 10:37:33.150[36m [info] [llm.go:301] [0m所有工具都标记为不回传结果，跳过LLM处理
2025-07-24 10:37:33.150[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 10:37:33.150[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: mORsxRlO-n4taDCCRsjnTVMxj4_w-OIEU7DtkAFVheU=
2025-07-24 10:37:33.150[37m [debug] [session.go:565] [0mprocessChatText end
2025-07-24 10:37:33.150[37m [debug] [session.go:147] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 10:37:33.150[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 10:37:33.150[36m [info] [session.go:134] [0m收到文本消息: 
2025-07-24 10:37:33.150[31m [error] [session.go:171] [0m解析消息失败: unexpected end of JSON input
2025-07-24 10:37:33.150[31m [error] [session.go:136] [0m处理文本消息失败: 解析消息失败: unexpected end of JSON input
2025-07-24 10:37:33.150[36m [info] [session.go:126] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 10:37:44.739[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 1
2025-07-24 10:37:44.740[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 0
2025-07-24 10:37:48.105[33m [warning] [userconfig.go:33] [0mRedis客户端未初始化
2025-07-24 10:37:48.105[36m [info] [base.go:36] [0mRedis用户配置提供者初始化成功
2025-07-24 10:37:48.105[36m [info] [chat.go:78] [0muserconfig: {SystemPrompt: Asr:{Provider:funasr Config:map[auto_end:true chunk_interval:10 chunk_size:[5 10 5] host:192.168.5.1 max_connections:5 mode:offline port:10095 sample_rate:16000 timeout:30]} Tts:{Provider:doubao_ws Config:map[access_token:pTt18L95cTdvgpBjnefFMEXsHaXgsU1k appid:9414688178 cluster:volcano_tts use_stream:true voice:zh_female_wanwanxiaohe_moon_bigtts ws_host:openspeech.bytedance.com]} Llm:{Provider:aliyun_qwen Config:map[api_key:sk-e740417c7bdb4deab05f17439e0c60c5 base_url:https://dashscope.aliyuncs.com/compatible-mode/v1 max_token:500 model_name:qwen2.5-72b-instruct type:openai]} Vad:{Provider:webrtc_vad Config:map[pool_max_idle:100 pool_max_size:1000 pool_min_size:5 vad_mode:2 vad_sample_rate:16000]}}
2025-07-24 10:37:48.105[33m [warning] [chat.go:96] [0mredis client is nil
2025-07-24 10:37:48.105[36m [info] [manager_registry.go:41] [0m注册ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 10:37:48.105[37m [debug] [eino_llm.go:163] [0mopenaiConfig: &{APIKey:sk-e740417c7bdb4deab05f17439e0c60c5 Timeout:0s HTTPClient:<nil> ByAzure:false BaseURL:https://dashscope.aliyuncs.com/compatible-mode/v1 APIVersion: Model:qwen2.5-72b-instruct MaxTokens:<nil> Temperature:<nil> TopP:<nil> Stop:[] PresencePenalty:<nil> ResponseFormat:<nil> Seed:<nil> FrequencyPenalty:<nil> LogitBias:map[] User:<nil>}
2025-07-24 10:37:48.105[36m [info] [eino_llm.go:171] [0m成功创建OpenAI ChatModel，模型: qwen2.5-72b-instruct
2025-07-24 10:37:48.106[37m [debug] [session.go:558] [0mprocessChatText start
2025-07-24 10:37:48.120[36m [info] [session.go:134] [0m收到文本消息: {"type":"hello","version":1,"features":{"mcp":true},"transport":"websocket","audio_params":{"format":"opus","sample_rate":16000,"channels":1,"frame_duration":60}}
2025-07-24 10:37:48.308[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 10:37:48.324[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:48.338[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:48.354[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:48.369[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:48.389[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:48.403[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:48.427[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:48.435[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:48.485[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:48.485[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:48.485[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:48.501[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"Qlh7uVeusLkTf0MwL-FXfAviZb4f0TnAy0-S3aC7Plw=","type":"listen","state":"detect","text":"你好小智"}
2025-07-24 10:37:48.501[37m [debug] [llm.go:76] [0mAddTextToTTSQueue text: 你好，我是小智，今天有啥好玩的。
2025-07-24 10:37:48.501[37m [debug] [llm.go:93] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 10:37:48.501[36m [info] [session.go:299] [0m设备  更新音频监听状态: detect
2025-07-24 10:37:48.501[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"Qlh7uVeusLkTf0MwL-FXfAviZb4f0TnAy0-S3aC7Plw=","type":"listen","state":"start","mode":"auto"}
2025-07-24 10:37:48.502[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 10:37:48.502[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 10:37:48.502[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:37:48.502[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 10:37:48.502[37m [debug] [llm.go:60] [0mprocessLLMResponseQueue item: {ctx:0xc00042a6e0 requestEinoMessages:[] responseChan:0xc000434b60 onStartFunc:0x12cedc0 onEndFunc:0x12ced60}
2025-07-24 10:37:48.502[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 10:37:48.502[37m [debug] [llm.go:178] [0mLLM 响应: {Text:你好，我是小智，今天有啥好玩的。 IsStart:true IsEnd:true ToolCalls:[]}
2025-07-24 10:37:48.502[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 10:37:48.510[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 1
2025-07-24 10:37:48.510[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 10:37:48.510[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 10:37:48.510[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 10:37:48.510[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"Qlh7uVeusLkTf0MwL-FXfAviZb4f0TnAy0-S3aC7Plw=","type":"mcp","payload":{"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"xiaoxin-esp32s3-154-4G","version":"1.7.6"}}}}
2025-07-24 10:37:48.511[36m [info] [device_manager.go:294] [0m收到MCP服务器通知: notifications/initialized
2025-07-24 10:37:48.589[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"Qlh7uVeusLkTf0MwL-FXfAviZb4f0TnAy0-S3aC7Plw=","type":"mcp","payload":{"jsonrpc":"2.0","id":2,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 10:37:48.589[36m [info] [device_manager.go:223] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 获取工具列表成功: map[self.audio_speaker.set_volume:0xc00028a400 self.get_device_status:0xc00028a3c0 self.screen.set_brightness:0xc00028a440 self.screen.set_theme:0xc00028a480]
2025-07-24 10:37:48.891[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:37:48.891[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:37:48.892[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 390 ms
2025-07-24 10:37:48.892[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 390 ms
2025-07-24 10:37:48.892[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1753324668892 ms
2025-07-24 10:37:48.892[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:37:48.893[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 38
2025-07-24 10:37:49.007[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 63
2025-07-24 10:37:49.009[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 83
2025-07-24 10:37:49.009[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 142
2025-07-24 10:37:49.526[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共15个片段
2025-07-24 10:37:52.190[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 10:37:52.190[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 10:37:52.272[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"Qlh7uVeusLkTf0MwL-FXfAviZb4f0TnAy0-S3aC7Plw=","type":"listen","state":"start","mode":"auto"}
2025-07-24 10:37:52.272[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 10:37:52.272[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 10:37:52.273[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:37:52.273[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 10:37:52.281[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"text":"","wav_name":"stream"}
2025-07-24 10:37:52.281[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 10:37:52.281[37m [debug] [asr.go:40] [0masr result: , ok: true, isFinal: true
2025-07-24 10:37:52.281[37m [debug] [session.go:490] [0m处理asr结果: , 耗时: 1753324672281 ms
2025-07-24 10:37:52.281[37m [debug] [session.go:519] [0mready Restart Asr, s.clientState.Status: init
2025-07-24 10:37:52.283[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 2
2025-07-24 10:37:52.283[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 10:37:52.283[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 10:37:52.283[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 10:37:55.981[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 10:37:56.050[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:56.117[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:56.177[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:56.239[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:56.266[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:56.331[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:56.406[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:56.470[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:56.523[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:56.613[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:56.654[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:56.714[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:37:56.952[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:37:57.033[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":715,"punc":"。","start":30,"text_seg":"你 退 下 吧","ts_list":[[30,150],[150,230],[230,390],[390,715]]}],"text":"你退下吧。","timestamp":"[[30,150],[150,230],[230,390],[390,715]]","wav_name":"stream"}
2025-07-24 10:37:57.033[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 10:37:57.033[37m [debug] [asr.go:40] [0masr result: 你退下吧。, ok: true, isFinal: true
2025-07-24 10:37:57.033[37m [debug] [session.go:490] [0m处理asr结果: 你退下吧。, 耗时: 80 ms
2025-07-24 10:37:57.033[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 你退下吧。
2025-07-24 10:37:57.033[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 10:37:57.033[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 10:37:57.033[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [exit_chat self.audio_speaker.set_volume self.screen.set_brightness self.screen.set_theme self.get_device_status]
2025-07-24 10:37:57.033[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: Qlh7uVeusLkTf0MwL-FXfAviZb4f0TnAy0-S3aC7Plw=, requestEinoMessages: [user: 你退下吧。]
2025-07-24 10:37:57.033[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: Qlh7uVeusLkTf0MwL-FXfAviZb4f0TnAy0-S3aC7Plw=, Type: openai
2025-07-24 10:37:57.033[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: Qlh7uVeusLkTf0MwL-FXfAviZb4f0TnAy0-S3aC7Plw=
2025-07-24 10:37:57.033[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: Qlh7uVeusLkTf0MwL-FXfAviZb4f0TnAy0-S3aC7Plw=, context状态: <nil>
2025-07-24 10:37:57.033[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 10:37:57.033[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 10:37:57.049[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: Qlh7uVeusLkTf0MwL-FXfAviZb4f0TnAy0-S3aC7Plw=, tools: [0xc0005b3320 0xc0005b3350 0xc0005b3380 0xc0005b33b0 0xc0005b33e0]
2025-07-24 10:37:57.049[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 10:37:57.960[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc00028c460 call_7063dca6991f466b9a2a69 function {exit_chat } map[]}]
finish_reason: 
2025-07-24 10:37:58.129[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc00028c508  function { {}} map[]}]
finish_reason: 
2025-07-24 10:37:58.130[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{427 12 439}
2025-07-24 10:37:58.130[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 10:37:58.131[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: Qlh7uVeusLkTf0MwL-FXfAviZb4f0TnAy0-S3aC7Plw=
2025-07-24 10:37:58.131[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_7063dca6991f466b9a2a69","type":"function","function":{"name":"exit_chat","arguments":"{}"}}]}
2025-07-24 10:37:58.132[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc00028c460 ID:call_7063dca6991f466b9a2a69 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 10:37:58.132[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 
2025-07-24 10:37:58.133[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc00028c460 ID:call_7063dca6991f466b9a2a69 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]}
2025-07-24 10:37:58.133[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc00028c460 ID:call_7063dca6991f466b9a2a69 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 10:37:58.133[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 10:37:58.133[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 10:37:58.133[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 10:37:58.133[36m [info] [mcp_client.go:11] [0m查找工具: exit_chat (设备: 98:a3:16:d1:04:24)
2025-07-24 10:37:58.133[36m [info] [mcp_client.go:24] [0m找到本地工具: local_exit_chat
2025-07-24 10:37:58.133[36m [info] [llm.go:261] [0m进行工具调用请求: exit_chat, 参数: {}
2025-07-24 10:37:58.133[36m [info] [local_tools.go:80] [0m执行退出对话工具，参数: {}
2025-07-24 10:37:58.134[36m [info] [manager_registry.go:95] [0m通过注册表关闭设备 98:a3:16:d1:04:24 的ChatManager
2025-07-24 10:37:58.134[36m [info] [chat.go:145] [0m主动关闭断开连接, 设备 98:a3:16:d1:04:24
2025-07-24 10:37:58.134[31m [error] [websocket_conn.go:56] [0mread message error: read tcp 192.168.6.164:8989->192.168.7.45:51620: use of closed network connection
2025-07-24 10:37:58.135[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 10:37:58.135[36m [info] [manager_registry.go:51] [0m注销ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 10:37:58.135[36m [info] [device_manager.go:44] [0m设备 98:a3:16:d1:04:24 MCP客户端已移除并取消上下文
2025-07-24 10:37:58.135[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 10:37:58.136[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 10:37:58.136[36m [info] [local_tools.go:126] [0m设备 98:a3:16:d1:04:24 对话已退出，原因: 用户请求退出对话
2025-07-24 10:37:58.136[36m [info] [llm.go:274] [0m工具调用结果: {"device_id":"98:a3:16:d1:04:24","message":"对话已成功退出","reason":"用户请求退出对话","success":true}, 耗时: 3ms
2025-07-24 10:37:58.136[36m [info] [llm.go:279] [0m工具 exit_chat 标记为不回传结果给LLM，跳过回传
2025-07-24 10:37:58.136[36m [info] [llm.go:301] [0m所有工具都标记为不回传结果，跳过LLM处理
2025-07-24 10:37:58.136[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 10:37:58.136[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: Qlh7uVeusLkTf0MwL-FXfAviZb4f0TnAy0-S3aC7Plw=
2025-07-24 10:37:58.136[37m [debug] [session.go:565] [0mprocessChatText end
2025-07-24 10:37:58.136[37m [debug] [session.go:147] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 10:37:58.136[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 10:37:58.136[36m [info] [session.go:134] [0m收到文本消息: 
2025-07-24 10:37:58.136[31m [error] [session.go:171] [0m解析消息失败: unexpected end of JSON input
2025-07-24 10:37:58.136[31m [error] [session.go:136] [0m处理文本消息失败: 解析消息失败: unexpected end of JSON input
2025-07-24 10:37:58.136[36m [info] [session.go:126] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 10:37:59.619[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 1
2025-07-24 10:37:59.620[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 0
2025-07-24 10:38:43.240[33m [warning] [userconfig.go:33] [0mRedis客户端未初始化
2025-07-24 10:38:43.240[36m [info] [base.go:36] [0mRedis用户配置提供者初始化成功
2025-07-24 10:38:43.240[36m [info] [chat.go:78] [0muserconfig: {SystemPrompt: Asr:{Provider:funasr Config:map[auto_end:true chunk_interval:10 chunk_size:[5 10 5] host:192.168.5.1 max_connections:5 mode:offline port:10095 sample_rate:16000 timeout:30]} Tts:{Provider:doubao_ws Config:map[access_token:pTt18L95cTdvgpBjnefFMEXsHaXgsU1k appid:9414688178 cluster:volcano_tts use_stream:true voice:zh_female_wanwanxiaohe_moon_bigtts ws_host:openspeech.bytedance.com]} Llm:{Provider:aliyun_qwen Config:map[api_key:sk-e740417c7bdb4deab05f17439e0c60c5 base_url:https://dashscope.aliyuncs.com/compatible-mode/v1 max_token:500 model_name:qwen2.5-72b-instruct type:openai]} Vad:{Provider:webrtc_vad Config:map[pool_max_idle:100 pool_max_size:1000 pool_min_size:5 vad_mode:2 vad_sample_rate:16000]}}
2025-07-24 10:38:43.240[33m [warning] [chat.go:96] [0mredis client is nil
2025-07-24 10:38:43.240[36m [info] [manager_registry.go:41] [0m注册ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 10:38:43.240[37m [debug] [eino_llm.go:163] [0mopenaiConfig: &{APIKey:sk-e740417c7bdb4deab05f17439e0c60c5 Timeout:0s HTTPClient:<nil> ByAzure:false BaseURL:https://dashscope.aliyuncs.com/compatible-mode/v1 APIVersion: Model:qwen2.5-72b-instruct MaxTokens:<nil> Temperature:<nil> TopP:<nil> Stop:[] PresencePenalty:<nil> ResponseFormat:<nil> Seed:<nil> FrequencyPenalty:<nil> LogitBias:map[] User:<nil>}
2025-07-24 10:38:43.240[36m [info] [eino_llm.go:171] [0m成功创建OpenAI ChatModel，模型: qwen2.5-72b-instruct
2025-07-24 10:38:43.240[37m [debug] [session.go:558] [0mprocessChatText start
2025-07-24 10:38:43.257[36m [info] [session.go:134] [0m收到文本消息: {"type":"hello","version":1,"features":{"mcp":true},"transport":"websocket","audio_params":{"format":"opus","sample_rate":16000,"channels":1,"frame_duration":60}}
2025-07-24 10:38:43.472[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 10:38:43.484[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:43.493[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:43.514[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:43.521[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:43.537[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:43.553[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:43.564[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:43.582[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:43.591[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:43.617[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:43.619[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:43.624[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=","type":"listen","state":"detect","text":"你好小智"}
2025-07-24 10:38:43.625[37m [debug] [llm.go:76] [0mAddTextToTTSQueue text: 你好，我是小智，今天有啥好玩的。
2025-07-24 10:38:43.625[37m [debug] [llm.go:93] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 10:38:43.625[36m [info] [session.go:299] [0m设备  更新音频监听状态: detect
2025-07-24 10:38:43.625[37m [debug] [llm.go:60] [0mprocessLLMResponseQueue item: {ctx:0xc0000c0320 requestEinoMessages:[] responseChan:0xc000173810 onStartFunc:0x12cedc0 onEndFunc:0x12ced60}
2025-07-24 10:38:43.625[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 10:38:43.625[37m [debug] [llm.go:178] [0mLLM 响应: {Text:你好，我是小智，今天有啥好玩的。 IsStart:true IsEnd:true ToolCalls:[]}
2025-07-24 10:38:43.634[33m [warning] [doubao_ws.go:299] [0mWebSocket连接已超时(30秒)，正在关闭并创建新连接
2025-07-24 10:38:43.635[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=","type":"listen","state":"start","mode":"auto"}
2025-07-24 10:38:43.635[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 10:38:43.635[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 10:38:43.635[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:38:43.635[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 10:38:43.638[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 1
2025-07-24 10:38:43.638[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 10:38:43.638[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 10:38:43.638[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 10:38:43.691[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=","type":"mcp","payload":{"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"xiaoxin-esp32s3-154-4G","version":"1.7.6"}}}}
2025-07-24 10:38:43.691[36m [info] [device_manager.go:294] [0m收到MCP服务器通知: notifications/initialized
2025-07-24 10:38:43.789[37m [debug] [doubao_ws.go:324] [0m创建新的doubao WebSocket连接，使用全局Dialer配置(读取缓冲区: 16KB，最大消息: 1MB)
2025-07-24 10:38:43.821[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=","type":"mcp","payload":{"jsonrpc":"2.0","id":2,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 10:38:43.822[36m [info] [device_manager.go:223] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 获取工具列表成功: map[self.audio_speaker.set_volume:0xc00028a4c0 self.get_device_status:0xc00028a480 self.screen.set_brightness:0xc00028a500 self.screen.set_theme:0xc00028a540]
2025-07-24 10:38:44.199[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:38:44.200[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:38:44.201[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 567 ms
2025-07-24 10:38:44.201[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 567 ms
2025-07-24 10:38:44.202[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1753324724202 ms
2025-07-24 10:38:44.202[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:38:44.203[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 36
2025-07-24 10:38:44.209[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 64
2025-07-24 10:38:44.211[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 76
2025-07-24 10:38:44.213[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 142
2025-07-24 10:38:44.692[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共18个片段
2025-07-24 10:38:47.454[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 10:38:47.454[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 10:38:47.652[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=","type":"listen","state":"start","mode":"auto"}
2025-07-24 10:38:47.652[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 10:38:47.652[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 10:38:47.652[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:38:47.652[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 10:38:47.654[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"text":"","wav_name":"stream"}
2025-07-24 10:38:47.655[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 10:38:47.655[37m [debug] [asr.go:40] [0masr result: , ok: true, isFinal: true
2025-07-24 10:38:47.655[37m [debug] [session.go:490] [0m处理asr结果: , 耗时: 1753324727655 ms
2025-07-24 10:38:47.655[37m [debug] [session.go:519] [0mready Restart Asr, s.clientState.Status: init
2025-07-24 10:38:47.655[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 2
2025-07-24 10:38:47.655[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 10:38:47.655[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 10:38:47.655[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 10:38:48.106[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 1
2025-07-24 10:38:48.107[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 0
2025-07-24 10:38:49.501[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 10:38:49.563[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:49.624[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:49.682[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:49.728[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:49.787[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:49.850[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:49.910[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:49.983[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:50.043[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:50.103[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:50.163[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:50.209[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:50.293[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:50.331[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:50.384[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:38:50.638[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:38:50.790[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":865,"punc":"。","start":30,"text_seg":"你 在 干 嘛 呢","ts_list":[[30,130],[130,250],[250,350],[350,510],[510,865]]}],"text":"你在干嘛呢。","timestamp":"[[30,130],[130,250],[250,350],[350,510],[510,865]]","wav_name":"stream"}
2025-07-24 10:38:50.791[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 10:38:50.791[37m [debug] [asr.go:40] [0masr result: 你在干嘛呢。, ok: true, isFinal: true
2025-07-24 10:38:50.791[37m [debug] [session.go:490] [0m处理asr结果: 你在干嘛呢。, 耗时: 153 ms
2025-07-24 10:38:50.791[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 你在干嘛呢。
2025-07-24 10:38:50.791[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 10:38:50.791[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 10:38:50.791[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [self.screen.set_brightness self.screen.set_theme self.get_device_status exit_chat self.audio_speaker.set_volume]
2025-07-24 10:38:50.791[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=, requestEinoMessages: [user: 你在干嘛呢。]
2025-07-24 10:38:50.791[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=, Type: openai
2025-07-24 10:38:50.791[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=
2025-07-24 10:38:50.791[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=, context状态: <nil>
2025-07-24 10:38:50.791[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 10:38:50.791[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 10:38:50.806[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=, tools: [0xc0002dc2a0 0xc0002dc330 0xc0002dc360 0xc0002dc390 0xc0002dc3c0]
2025-07-24 10:38:50.806[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 10:38:51.175[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 您好
finish_reason: 
2025-07-24 10:38:51.175[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"您好","response_meta":{}}
2025-07-24 10:38:51.204[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ！
finish_reason: 
2025-07-24 10:38:51.205[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"！","response_meta":{}}
2025-07-24 10:38:51.224[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 我
finish_reason: 
2025-07-24 10:38:51.227[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"我","response_meta":{}}
2025-07-24 10:38:51.339[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 在这里是为了帮助您
finish_reason: 
2025-07-24 10:38:51.340[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"在这里是为了帮助您","response_meta":{}}
2025-07-24 10:38:51.482[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 。请告诉我您
finish_reason: 
2025-07-24 10:38:51.483[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"。请告诉我您","response_meta":{}}
2025-07-24 10:38:51.483[36m [info] [llm.go:107] [0m耗时统计: llm工具首句: 692 ms
2025-07-24 10:38:51.483[36m [info] [llm.go:109] [0m处理完整句子: 我在这里是为了帮助您。
2025-07-24 10:38:51.503[37m [debug] [llm.go:178] [0mLLM 响应: {Text:我在这里是为了帮助您。 IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 10:38:51.504[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 10:38:51.566[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 需要什么样的帮助或
finish_reason: 
2025-07-24 10:38:51.567[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"需要什么样的帮助或","response_meta":{}}
2025-07-24 10:38:51.691[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 您想了解什么
finish_reason: 
2025-07-24 10:38:51.692[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"您想了解什么","response_meta":{}}
2025-07-24 10:38:51.771[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 信息。如果您只是
finish_reason: 
2025-07-24 10:38:51.771[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"信息。如果您只是","response_meta":{}}
2025-07-24 10:38:51.771[36m [info] [llm.go:109] [0m处理完整句子: 请告诉我您需要什么样的帮助或您想了解什么信息。
2025-07-24 10:38:51.894[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:38:51.894[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:38:51.913[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 410 ms
2025-07-24 10:38:51.914[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 想知道我能够做
finish_reason: 
2025-07-24 10:38:51.914[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"想知道我能够做","response_meta":{}}
2025-07-24 10:38:51.915[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 411 ms
2025-07-24 10:38:51.915[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:38:51.916[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 33
2025-07-24 10:38:51.974[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 些什么，我可以向
finish_reason: 
2025-07-24 10:38:51.974[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"些什么，我可以向","response_meta":{}}
2025-07-24 10:38:52.017[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 66
2025-07-24 10:38:52.037[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 81
2025-07-24 10:38:52.042[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 139
2025-07-24 10:38:52.148[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 您展示我的一些
finish_reason: 
2025-07-24 10:38:52.149[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"您展示我的一些","response_meta":{}}
2025-07-24 10:38:52.231[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 功能。请随时
finish_reason: 
2025-07-24 10:38:52.233[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"功能。请随时","response_meta":{}}
2025-07-24 10:38:52.233[36m [info] [llm.go:109] [0m处理完整句子: 如果您只是想知道我能够做些什么，我可以向您展示我的一些功能。
2025-07-24 10:38:52.335[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 提出您的需求或
finish_reason: 
2025-07-24 10:38:52.335[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"提出您的需求或","response_meta":{}}
2025-07-24 10:38:52.460[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 问题。
finish_reason: stop
2025-07-24 10:38:52.461[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: 
usage: &{426 45 471}
2025-07-24 10:38:52.465[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 10:38:52.465[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=
2025-07-24 10:38:52.469[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"问题。","response_meta":{"finish_reason":"stop"}}
2025-07-24 10:38:52.469[36m [info] [llm.go:109] [0m处理完整句子: 请随时提出您的需求或问题。
2025-07-24 10:38:52.480[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共12个片段
2025-07-24 10:38:54.325[37m [debug] [llm.go:178] [0mLLM 响应: {Text:请告诉我您需要什么样的帮助或您想了解什么信息。 IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 10:38:54.325[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 10:38:54.735[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:38:54.736[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:38:54.736[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 411 ms
2025-07-24 10:38:54.738[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 413 ms
2025-07-24 10:38:54.739[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:38:54.741[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 38
2025-07-24 10:38:54.856[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 47
2025-07-24 10:38:54.860[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 92
2025-07-24 10:38:54.862[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 129
2025-07-24 10:38:55.625[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共20个片段
2025-07-24 10:38:58.883[37m [debug] [llm.go:178] [0mLLM 响应: {Text:如果您只是想知道我能够做些什么，我可以向您展示我的一些功能。 IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 10:38:58.885[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 10:38:58.886[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 您好！我在这里是为了帮助您。请告诉我您需要什么样的帮助或您想了解什么信息。如果您只是想知道我能够做些什么，我可以向您展示我的一些功能。请随时提出您的需求或问题。
2025-07-24 10:38:59.404[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:38:59.404[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:38:59.404[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 520 ms
2025-07-24 10:38:59.404[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 520 ms
2025-07-24 10:38:59.405[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:38:59.406[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 40
2025-07-24 10:38:59.416[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 81
2025-07-24 10:38:59.418[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 84
2025-07-24 10:38:59.419[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 137
2025-07-24 10:39:00.399[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共22个片段
2025-07-24 10:39:04.221[37m [debug] [llm.go:178] [0mLLM 响应: {Text:请随时提出您的需求或问题。 IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 10:39:04.221[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 10:39:04.645[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 10:39:04.646[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 10:39:04.647[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 426 ms
2025-07-24 10:39:04.649[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 428 ms
2025-07-24 10:39:04.649[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 10:39:04.651[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 41
2025-07-24 10:39:04.665[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 97
2025-07-24 10:39:04.674[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 80
2025-07-24 10:39:04.674[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 124
2025-07-24 10:39:05.263[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共16个片段
2025-07-24 10:39:07.437[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 10:39:07.437[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 10:39:07.437[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 10:39:07.437[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 10:39:07.437[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=
2025-07-24 10:39:07.586[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=","type":"listen","state":"start","mode":"auto"}
2025-07-24 10:39:07.586[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 10:39:07.587[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 10:39:07.587[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 10:39:07.587[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 10:39:07.587[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 10:39:07.587[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 10:39:09.434[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 10:39:09.499[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:09.559[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:09.615[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:09.661[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:09.723[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:09.790[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:09.842[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:09.920[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:09.981[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:10.039[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:10.102[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:10.140[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:10.198[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 10:39:10.453[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 10:39:10.547[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":775,"punc":"。","start":30,"text_seg":"你 退 下 吧","ts_list":[[30,150],[150,290],[290,450],[450,775]]}],"text":"你退下吧。","timestamp":"[[30,150],[150,290],[290,450],[450,775]]","wav_name":"stream"}
2025-07-24 10:39:10.547[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 10:39:10.547[37m [debug] [asr.go:40] [0masr result: 你退下吧。, ok: true, isFinal: true
2025-07-24 10:39:10.547[37m [debug] [session.go:490] [0m处理asr结果: 你退下吧。, 耗时: 94 ms
2025-07-24 10:39:10.547[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 你退下吧。
2025-07-24 10:39:10.547[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 10:39:10.547[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 10:39:10.547[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [self.audio_speaker.set_volume self.screen.set_brightness self.screen.set_theme exit_chat self.get_device_status]
2025-07-24 10:39:10.547[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=, requestEinoMessages: [user: 你退下吧。]
2025-07-24 10:39:10.547[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=, Type: openai
2025-07-24 10:39:10.547[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=
2025-07-24 10:39:10.547[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=, context状态: <nil>
2025-07-24 10:39:10.547[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 10:39:10.547[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 10:39:10.562[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=, tools: [0xc00051c7e0 0xc00051c810 0xc00051c870 0xc00051c8a0 0xc00051c8d0]
2025-07-24 10:39:10.562[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 10:39:11.180[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 
tool_calls: [{0xc0000151e0 call_03109a2ca00c4833b0a212 function {exit_chat } map[]}]
finish_reason: 
2025-07-24 10:39:11.285[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc0003bf388  function { {}} map[]}]
finish_reason: 
2025-07-24 10:39:11.285[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{427 12 439}
2025-07-24 10:39:11.286[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 10:39:11.287[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=
2025-07-24 10:39:11.288[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_03109a2ca00c4833b0a212","type":"function","function":{"name":"exit_chat","arguments":"{}"}}]}
2025-07-24 10:39:11.288[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc0000151e0 ID:call_03109a2ca00c4833b0a212 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 10:39:11.288[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 
2025-07-24 10:39:11.288[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:true IsEnd:false ToolCalls:[{Index:0xc0000151e0 ID:call_03109a2ca00c4833b0a212 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]}
2025-07-24 10:39:11.289[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc0000151e0 ID:call_03109a2ca00c4833b0a212 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 10:39:11.289[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 10:39:11.289[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 10:39:11.289[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 10:39:11.289[36m [info] [mcp_client.go:11] [0m查找工具: exit_chat (设备: 98:a3:16:d1:04:24)
2025-07-24 10:39:11.289[36m [info] [mcp_client.go:24] [0m找到本地工具: local_exit_chat
2025-07-24 10:39:11.289[36m [info] [llm.go:261] [0m进行工具调用请求: exit_chat, 参数: {}
2025-07-24 10:39:11.289[36m [info] [local_tools.go:80] [0m执行退出对话工具，参数: {}
2025-07-24 10:39:11.289[36m [info] [manager_registry.go:95] [0m通过注册表关闭设备 98:a3:16:d1:04:24 的ChatManager
2025-07-24 10:39:11.290[36m [info] [chat.go:145] [0m主动关闭断开连接, 设备 98:a3:16:d1:04:24
2025-07-24 10:39:11.290[31m [error] [websocket_conn.go:56] [0mread message error: read tcp 192.168.6.164:8989->192.168.7.45:51621: use of closed network connection
2025-07-24 10:39:11.290[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 10:39:11.290[36m [info] [manager_registry.go:51] [0m注销ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 10:39:11.290[36m [info] [device_manager.go:44] [0m设备 98:a3:16:d1:04:24 MCP客户端已移除并取消上下文
2025-07-24 10:39:11.290[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 10:39:11.290[36m [info] [chat.go:152] [0m设备 98:a3:16:d1:04:24 断开连接
2025-07-24 10:39:11.290[36m [info] [local_tools.go:126] [0m设备 98:a3:16:d1:04:24 对话已退出，原因: 用户请求退出对话
2025-07-24 10:39:11.290[36m [info] [llm.go:274] [0m工具调用结果: {"device_id":"98:a3:16:d1:04:24","message":"对话已成功退出","reason":"用户请求退出对话","success":true}, 耗时: 1ms
2025-07-24 10:39:11.290[36m [info] [llm.go:279] [0m工具 exit_chat 标记为不回传结果给LLM，跳过回传
2025-07-24 10:39:11.290[36m [info] [llm.go:301] [0m所有工具都标记为不回传结果，跳过LLM处理
2025-07-24 10:39:11.290[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 10:39:11.290[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: Nu2bLme40LNg-yYzMsRtdaMM2KpG58XnlDzlf78J5BM=
2025-07-24 10:39:11.290[37m [debug] [session.go:565] [0mprocessChatText end
2025-07-24 10:39:11.290[37m [debug] [session.go:147] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 10:39:11.290[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 10:39:11.290[36m [info] [session.go:134] [0m收到文本消息: 
2025-07-24 10:39:11.290[31m [error] [session.go:171] [0m解析消息失败: unexpected end of JSON input
2025-07-24 10:39:11.290[31m [error] [session.go:136] [0m处理文本消息失败: 解析消息失败: unexpected end of JSON input
2025-07-24 10:39:11.290[36m [info] [session.go:126] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 10:39:43.242[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 1
2025-07-24 10:39:43.243[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 0
[36mINFO[0m[0000] pprof服务已禁用                                    [36mcaller[0m="main.go:43"
[36mINFO[0m[0000] 已设置退出对话函数                                     [36mcaller[0m="local_tools.go:145"
[36mINFO[0m[0000] UDP服务器启动在 0.0.0.0:8990                        [36mcaller[0m="udp_server.go:61"
[36mINFO[0m[0000] MQTT 服务器启动，监听 0.0.0.0:2883 地址...              [36mcaller[0m="mqtt_server.go:80"
[36mINFO[0m[0000] === MCP配置检查 ===                               [36mcaller[0m="config_checker.go:14"
[36mINFO[0m[0000] 全局MCP启用状态: true                               [36mcaller[0m="config_checker.go:18"
[36mINFO[0m[0000] 重连配置: 间隔=5秒, 最大尝试次数=10                        [36mcaller[0m="config_checker.go:28"
[36mINFO[0m[0000] 共配置了 2 个MCP服务器:                               [36mcaller[0m="config_checker.go:42"
[36mINFO[0m[0000]   [1] ✅ filesystem (URL: http://localhost:3001/sse, 启用: false)  [36mcaller[0m="config_checker.go:82"
[36mINFO[0m[0000]   [2] ✅ memory (URL: http://localhost:3002/sse, 启用: false)  [36mcaller[0m="config_checker.go:82"
[36mINFO[0m[0000] 配置检查完成: 0个服务器已启用, 0个存在问题                      [36mcaller[0m="config_checker.go:87"
[36mINFO[0m[0000] --- 设备MCP配置检查 ---                             [36mcaller[0m="config_checker.go:101"
[36mINFO[0m[0000] 设备MCP启用状态: true                               [36mcaller[0m="config_checker.go:104"
[36mINFO[0m[0000] WebSocket路径: /xiaozhi/mcp/                    [36mcaller[0m="config_checker.go:114"
[36mINFO[0m[0000] 每设备最大连接数: 5                                   [36mcaller[0m="config_checker.go:115"
[36mINFO[0m[0000] === MCP配置检查完成 ===                             [36mcaller[0m="config_checker.go:96"
[36mINFO[0m[0000] 已注册本地工具: local_exit_chat                      [36mcaller[0m="manage.go:352"
[36mINFO[0m[0000] 已注册 1 个本地工具                                   [36mcaller[0m="manage.go:355"
[36mINFO[0m[0000] 从配置中读取到 2 个MCP服务器配置                           [36mcaller[0m="manage.go:103"
[36mINFO[0m[0000] MCP服务器[1]: Name=filesystem, SSEUrl=http://localhost:3001/sse, Enabled=false  [36mcaller[0m="manage.go:107"
[36mINFO[0m[0000] MCP服务器[2]: Name=memory, SSEUrl=http://localhost:3002/sse, Enabled=false  [36mcaller[0m="manage.go:107"
[36mINFO[0m[0000] MCP服务器 filesystem 已禁用，跳过连接                    [36mcaller[0m="manage.go:122"
[36mINFO[0m[0000] MCP服务器 memory 已禁用，跳过连接                        [36mcaller[0m="manage.go:122"
[36mINFO[0m[0000] 成功连接了 0 个MCP服务器                               [36mcaller[0m="manage.go:126"
[36mINFO[0m[0000] 全局MCP管理器已启动                                   [36mcaller[0m="manage.go:131"
[36mINFO[0m[0000] WebSocket 服务器启动在 ws://0.0.0.0:8989/xiaozhi/v1/  [36mcaller[0m="websocket_server.go:100"
[36mINFO[0m[0000] MCP WebSocket 端点: ws://0.0.0.0:8989/xiaozhi/mcp/{deviceId}  [36mcaller[0m="websocket_server.go:101"
[36mINFO[0m[0000] MCP API 端点: http://0.0.0.0:8989/xiaozhi/api/mcp/tools/{deviceId}  [36mcaller[0m="websocket_server.go:102"
[36mINFO[0m[0000] MQTT已连接                                       [36mcaller[0m="mqtt_udp_adapter.go:84"
[36mINFO[0m[0000] === 收到订阅包 ===                                 [36mcaller[0m="device_hook.go:106"
[36mINFO[0m[0000] 客户端ID: xiaozhi_server                         [36mcaller[0m="device_hook.go:107"
[36mINFO[0m[0000] 包类型: 8                                        [36mcaller[0m="device_hook.go:108"
[36mINFO[0m[0000] 包ID: 1                                        [36mcaller[0m="device_hook.go:109"
[36mINFO[0m[0000] 订阅信息:                                         [36mcaller[0m="device_hook.go:112"
[36mINFO[0m[0000]   1. 主题: /p2p/device_public/#, QoS: 0         [36mcaller[0m="device_hook.go:114"
[36mINFO[0m[0000] ==================                            [36mcaller[0m="device_hook.go:118"
[36mINFO[0m[1917] 订阅客户端 GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df 到主题 /p2p/device_sub/98_a3_16_d1_04_24, exists: true  [36mcaller[0m="device_hook.go:100"
[36mINFO[0m[0000] pprof服务已禁用                                    [36mcaller[0m="main.go:43"
[36mINFO[0m[0000] 已设置退出对话函数                                     [36mcaller[0m="local_tools.go:145"
[36mINFO[0m[0000] UDP服务器启动在 0.0.0.0:8990                        [36mcaller[0m="udp_server.go:61"
[36mINFO[0m[0000] === MCP配置检查 ===                               [36mcaller[0m="config_checker.go:14"
[36mINFO[0m[0000] 全局MCP启用状态: true                               [36mcaller[0m="config_checker.go:18"
[36mINFO[0m[0000] 重连配置: 间隔=5秒, 最大尝试次数=10                        [36mcaller[0m="config_checker.go:28"
[36mINFO[0m[0000] 共配置了 2 个MCP服务器:                               [36mcaller[0m="config_checker.go:42"
[36mINFO[0m[0000]   [1] ✅ filesystem (URL: http://localhost:3001/sse, 启用: false)  [36mcaller[0m="config_checker.go:82"
[36mINFO[0m[0000]   [2] ✅ memory (URL: http://localhost:3002/sse, 启用: false)  [36mcaller[0m="config_checker.go:82"
[36mINFO[0m[0000] 配置检查完成: 0个服务器已启用, 0个存在问题                      [36mcaller[0m="config_checker.go:87"
[36mINFO[0m[0000] --- 设备MCP配置检查 ---                             [36mcaller[0m="config_checker.go:101"
[36mINFO[0m[0000] 设备MCP启用状态: true                               [36mcaller[0m="config_checker.go:104"
[36mINFO[0m[0000] WebSocket路径: /xiaozhi/mcp/                    [36mcaller[0m="config_checker.go:114"
[36mINFO[0m[0000] 每设备最大连接数: 5                                   [36mcaller[0m="config_checker.go:115"
[36mINFO[0m[0000] === MCP配置检查完成 ===                             [36mcaller[0m="config_checker.go:96"
[36mINFO[0m[0000] 已注册本地工具: local_exit_chat                      [36mcaller[0m="manage.go:352"
[36mINFO[0m[0000] 已注册 1 个本地工具                                   [36mcaller[0m="manage.go:355"
[36mINFO[0m[0000] 从配置中读取到 2 个MCP服务器配置                           [36mcaller[0m="manage.go:103"
[36mINFO[0m[0000] MCP服务器[1]: Name=filesystem, SSEUrl=http://localhost:3001/sse, Enabled=false  [36mcaller[0m="manage.go:107"
[36mINFO[0m[0000] MCP服务器[2]: Name=memory, SSEUrl=http://localhost:3002/sse, Enabled=false  [36mcaller[0m="manage.go:107"
[36mINFO[0m[0000] MCP服务器 filesystem 已禁用，跳过连接                    [36mcaller[0m="manage.go:122"
[36mINFO[0m[0000] MCP服务器 memory 已禁用，跳过连接                        [36mcaller[0m="manage.go:122"
[36mINFO[0m[0000] 成功连接了 0 个MCP服务器                               [36mcaller[0m="manage.go:126"
[36mINFO[0m[0000] 全局MCP管理器已启动                                   [36mcaller[0m="manage.go:131"
[36mINFO[0m[0000] WebSocket 服务器启动在 ws://0.0.0.0:8989/xiaozhi/v1/  [36mcaller[0m="websocket_server.go:100"
[36mINFO[0m[0000] MCP WebSocket 端点: ws://0.0.0.0:8989/xiaozhi/mcp/{deviceId}  [36mcaller[0m="websocket_server.go:101"
[36mINFO[0m[0000] MCP API 端点: http://0.0.0.0:8989/xiaozhi/api/mcp/tools/{deviceId}  [36mcaller[0m="websocket_server.go:102"
[36mINFO[0m[0000] MQTT 服务器启动，监听 0.0.0.0:2883 地址...              [36mcaller[0m="mqtt_server.go:80"
[36mINFO[0m[0000] MQTT已连接                                       [36mcaller[0m="mqtt_udp_adapter.go:84"
[36mINFO[0m[0000] === 收到订阅包 ===                                 [36mcaller[0m="device_hook.go:106"
[36mINFO[0m[0000] 客户端ID: xiaozhi_server                         [36mcaller[0m="device_hook.go:107"
[36mINFO[0m[0000] 包类型: 8                                        [36mcaller[0m="device_hook.go:108"
[36mINFO[0m[0000] 包ID: 1                                        [36mcaller[0m="device_hook.go:109"
[36mINFO[0m[0000] 订阅信息:                                         [36mcaller[0m="device_hook.go:112"
[36mINFO[0m[0000]   1. 主题: /p2p/device_public/#, QoS: 0         [36mcaller[0m="device_hook.go:114"
[36mINFO[0m[0000] ==================                            [36mcaller[0m="device_hook.go:118"
[36mINFO[0m[0004] 订阅客户端 GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df 到主题 /p2p/device_sub/98_a3_16_d1_04_24, exists: true  [36mcaller[0m="device_hook.go:100"
[36mINFO[0m[0007] === 收到发布包 ===                                 [36mcaller[0m="device_hook.go:124"
[36mINFO[0m[0007] 客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df  [36mcaller[0m="device_hook.go:125"
[36mINFO[0m[0007] 包类型: 3                                        [36mcaller[0m="device_hook.go:126"
[36mINFO[0m[0007] 包ID: 0                                        [36mcaller[0m="device_hook.go:127"
[36mINFO[0m[0007] 主题: device-server                             [36mcaller[0m="device_hook.go:128"
[36mINFO[0m[0007] 消息内容(前100字节): {"type":"hello","version":3,"transport":"udp","features":{"mcp":true},"audio_params":{"format":"opus...  [36mcaller[0m="device_hook.go:137"
[36mINFO[0m[0007] ==================                            [36mcaller[0m="device_hook.go:155"
[37mDEBU[0m[0007] mqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"type":"hello","version":3,"transport":"udp","features":{"mcp":true},"audio_params":{"format":"opus","sample_rate":16000,"channels":1,"frame_duration":60}}  [37mcaller[0m="mqtt_udp_adapter.go:182"
[37mDEBU[0m[0007] getDeviceSession, deviceId: 98:a3:16:d1:04:24  [37mcaller[0m="mqtt_udp_adapter.go:147"
[37mDEBU[0m[0007] SetNonce2Session, connID: df26892f, session: &{ID:f76e7eb1a5afc2e8 Conn:<nil> ConnId:df26892f ClientId: DeviceId:98:a3:16:d1:04:24 AesKey:[38 213 173 82 12 81 226 153 29 38 25 71 80 201 167 122] Nonce:[223 38 137 47 104 129 175 16] CreatedAt:2025-07-24 11:57:04.799739276 +0800 CST m=+7.192613023 LastActive:2025-07-24 11:57:04.799739314 +0800 CST m=+7.192613056 RemoteAddr:<nil> LocalSeq:0 Block:0xc0004dea00 RemoteSeq:0 RecvChannel:0xc00027c1c0 SendChannel:0xc00027c230}  [37mcaller[0m="udp_server.go:250"
[37mDEBU[0m[0007] SetDeviceSession, deviceId: 98:a3:16:d1:04:24  [37mcaller[0m="mqtt_udp_adapter.go:142"
2025-07-24 11:57:04.799[33m [warning] [userconfig.go:33] [0mRedis客户端未初始化
2025-07-24 11:57:04.799[36m [info] [base.go:36] [0mRedis用户配置提供者初始化成功
2025-07-24 11:57:04.799[36m [info] [chat.go:78] [0muserconfig: {SystemPrompt: Asr:{Provider:funasr Config:map[auto_end:true chunk_interval:10 chunk_size:[5 10 5] host:192.168.5.1 max_connections:5 mode:offline port:10095 sample_rate:16000 timeout:30]} Tts:{Provider:doubao_ws Config:map[access_token:pTt18L95cTdvgpBjnefFMEXsHaXgsU1k appid:9414688178 cluster:volcano_tts use_stream:true voice:zh_female_wanwanxiaohe_moon_bigtts ws_host:openspeech.bytedance.com]} Llm:{Provider:aliyun_qwen Config:map[api_key:sk-e740417c7bdb4deab05f17439e0c60c5 base_url:https://dashscope.aliyuncs.com/compatible-mode/v1 max_token:500 model_name:qwen2.5-72b-instruct type:openai]} Vad:{Provider:webrtc_vad Config:map[pool_max_idle:100 pool_max_size:1000 pool_min_size:5 vad_mode:2 vad_sample_rate:16000]}}
2025-07-24 11:57:04.800[33m [warning] [llm_memory.go:35] [0mRedis客户端未初始化
2025-07-24 11:57:04.800[33m [warning] [chat.go:96] [0mredis client is nil
2025-07-24 11:57:04.800[36m [info] [manager_registry.go:41] [0m注册ChatManager，设备ID: 98:a3:16:d1:04:24
2025-07-24 11:57:04.800[37m [debug] [eino_llm.go:163] [0mopenaiConfig: &{APIKey:sk-e740417c7bdb4deab05f17439e0c60c5 Timeout:0s HTTPClient:<nil> ByAzure:false BaseURL:https://dashscope.aliyuncs.com/compatible-mode/v1 APIVersion: Model:qwen2.5-72b-instruct MaxTokens:<nil> Temperature:<nil> TopP:<nil> Stop:[] PresencePenalty:<nil> ResponseFormat:<nil> Seed:<nil> FrequencyPenalty:<nil> LogitBias:map[] User:<nil>}
2025-07-24 11:57:04.800[36m [info] [eino_llm.go:171] [0m成功创建OpenAI ChatModel，模型: qwen2.5-72b-instruct
2025-07-24 11:57:04.800[36m [info] [session.go:134] [0m收到文本消息: {"type":"hello","version":3,"transport":"udp","features":{"mcp":true},"audio_params":{"format":"opus","sample_rate":16000,"channels":1,"frame_duration":60}}
2025-07-24 11:57:04.800[37m [debug] [session.go:558] [0mprocessChatText start
2025-07-24 11:57:04.802[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:04.802[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:04.802[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:04.802[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:04.802[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:04.802[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:04.802[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:04.803[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:04.803[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:04.803[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:05.206[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:05.241[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:05.269[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 11:57:05.517[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:05.517[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:57:05.517[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:05.517[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:05.517[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:57:05.517[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"listen","state":"detect","text"...
2025-07-24 11:57:05.517[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:57:05.517[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:05.517[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:57:05.517[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:05.517[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:05.517[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:57:05.517[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"listen","state":"start","mode":...
2025-07-24 11:57:05.517[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:57:05.518[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"listen","state":"detect","text":"你好小智"}
2025-07-24 11:57:05.518[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:57:05.518[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"listen","state":"start","mode":"auto"}
2025-07-24 11:57:05.518[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:57:05.518[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"listen","state":"detect","text":"你好小智"}
2025-07-24 11:57:05.518[37m [debug] [llm.go:76] [0mAddTextToTTSQueue text: 你好，我是小智，很高兴认识你。
2025-07-24 11:57:05.519[37m [debug] [llm.go:93] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 11:57:05.519[36m [info] [session.go:299] [0m设备  更新音频监听状态: detect
2025-07-24 11:57:05.519[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"listen","state":"start","mode":"auto"}
2025-07-24 11:57:05.519[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 11:57:05.519[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 11:57:05.519[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 11:57:05.520[37m [debug] [llm.go:60] [0mprocessLLMResponseQueue item: {ctx:0xc0003f1e50 requestEinoMessages:[] responseChan:0xc00033fc70 onStartFunc:0x12cedc0 onEndFunc:0x12ced60}
2025-07-24 11:57:05.520[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 11:57:05.520[37m [debug] [llm.go:178] [0mLLM 响应: {Text:你好，我是小智，很高兴认识你。 IsStart:true IsEnd:true ToolCalls:[]}
2025-07-24 11:57:05.523[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:05.523[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:05.523[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:05.523[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:05.523[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:05.529[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 1
2025-07-24 11:57:05.530[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 11:57:05.530[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 11:57:05.530[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 11:57:05.559[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:05.559[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:57:05.559[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:05.559[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:05.559[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:57:05.559[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:57:05.559[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:57:05.559[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"xiaoxin-esp32s3-154-4G","version":"1.7.6"}}}}
2025-07-24 11:57:05.559[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:57:05.559[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":1,"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{}},"serverInfo":{"name":"xiaoxin-esp32s3-154-4G","version":"1.7.6"}}}}
2025-07-24 11:57:05.560[36m [info] [device_manager.go:294] [0m收到MCP服务器通知: notifications/initialized
2025-07-24 11:57:05.561[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:05.561[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:05.561[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:05.561[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:05.561[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:05.648[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:05.648[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:57:05.648[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:05.648[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:05.648[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:57:05.648[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:57:05.648[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:57:05.653[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":2,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 11:57:05.653[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:57:05.654[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":2,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 11:57:05.654[36m [info] [device_manager.go:223] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 获取工具列表成功: map[self.audio_speaker.set_volume:0xc0005393c0 self.get_device_status:0xc000539380 self.screen.set_brightness:0xc000539400 self.screen.set_theme:0xc000539440]
2025-07-24 11:57:05.746[37m [debug] [doubao_ws.go:324] [0m创建新的doubao WebSocket连接，使用全局Dialer配置(读取缓冲区: 16KB，最大消息: 1MB)
2025-07-24 11:57:05.748[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:05.748[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:05.748[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:05.748[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:05.748[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:06.158[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 11:57:06.159[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 11:57:06.159[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 639 ms
2025-07-24 11:57:06.159[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 639 ms
2025-07-24 11:57:06.159[37m [debug] [tts.go:161] [0m从接收音频结束 asr->llm->tts首帧 整体 耗时: 1753329426159 ms
2025-07-24 11:57:06.159[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 11:57:06.164[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 44
2025-07-24 11:57:06.180[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 63
2025-07-24 11:57:06.185[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 81
2025-07-24 11:57:06.186[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 147
2025-07-24 11:57:06.606[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共14个片段
2025-07-24 11:57:09.127[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 11:57:09.127[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 11:57:09.127[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:09.127[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:09.127[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:09.127[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:09.127[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:09.127[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:09.127[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:09.127[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:09.127[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:09.127[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:09.310[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:09.310[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:57:09.310[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:09.310[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:09.310[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:57:09.310[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"listen","state":"start","mode":...
2025-07-24 11:57:09.310[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:57:09.310[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"listen","state":"start","mode":"auto"}
2025-07-24 11:57:09.310[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:57:09.311[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"listen","state":"start","mode":"auto"}
2025-07-24 11:57:09.311[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 11:57:09.311[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 11:57:09.311[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 11:57:09.311[37m [debug] [asr.go:163] [0m重启ASR识别开始
2025-07-24 11:57:09.316[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"text":"","wav_name":"stream"}
2025-07-24 11:57:09.317[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 11:57:09.317[37m [debug] [asr.go:40] [0masr result: , ok: true, isFinal: true
2025-07-24 11:57:09.317[37m [debug] [session.go:490] [0m处理asr结果: , 耗时: 1753329429317 ms
2025-07-24 11:57:09.317[37m [debug] [session.go:519] [0mready Restart Asr, s.clientState.Status: init
2025-07-24 11:57:09.317[37m [debug] [funasr.go:151] [0m创建新的FunASR连接，当前连接数: 2
2025-07-24 11:57:09.317[37m [debug] [asr.go:192] [0m重启ASR识别成功
2025-07-24 11:57:09.318[37m [debug] [session.go:540] [0mOnListenStart end
2025-07-24 11:57:09.318[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 11:57:10.516[36m [info] [asr.go:112] [0m检测到语音, len: 3840
2025-07-24 11:57:10.603[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:10.658[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:10.713[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:10.779[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:10.849[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:10.885[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:10.945[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:11.006[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:11.082[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:11.141[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:11.192[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:11.251[36m [info] [asr.go:112] [0m检测到语音, len: 960
2025-07-24 11:57:11.486[37m [debug] [asr.go:58] [0m停止asr
2025-07-24 11:57:12.102[37m [debug] [funasr.go:310] [0mfunasr recvResult 读取识别结果: {"is_final":true,"mode":"2pass-offline","stamp_sents":[{"end":715,"punc":"。","start":30,"text_seg":"你 睡 觉 吧","ts_list":[[30,150],[150,290],[290,390],[390,715]]}],"text":"你睡觉吧。","timestamp":"[[30,150],[150,290],[290,390],[390,715]]","wav_name":"stream"}
2025-07-24 11:57:12.102[37m [debug] [funasr.go:342] [0mfunasr recvResult isfinal
2025-07-24 11:57:12.102[37m [debug] [asr.go:40] [0masr result: 你睡觉吧。, ok: true, isFinal: true
2025-07-24 11:57:12.102[37m [debug] [session.go:490] [0m处理asr结果: 你睡觉吧。, 耗时: 616 ms
2025-07-24 11:57:12.102[37m [debug] [session.go:545] [0mAddAsrResultToQueue text: 你睡觉吧。
2025-07-24 11:57:12.102[33m [warning] [session.go:606] [0mredis client is nil
2025-07-24 11:57:12.102[36m [info] [llm.go:216] [0m成功转换了 5 个MCP工具为Eino工具
2025-07-24 11:57:12.102[36m [info] [session.go:653] [0m使用 5 个MCP工具发送LLM请求, tools: [self.audio_speaker.set_volume exit_chat self.screen.set_brightness self.screen.set_theme self.get_device_status]
2025-07-24 11:57:12.102[37m [debug] [llm.go:317] [0m发送带工具的 LLM 请求, seesionID: mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=, requestEinoMessages: [user: 你睡觉吧。]
2025-07-24 11:57:12.102[36m [info] [eino_llm.go:220] [0m[Eino-LLM] 开始处理带工具的请求 - SessionID: mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=, Type: openai
2025-07-24 11:57:12.102[36m [info] [eino_llm.go:225] [0m[Eino-LLM] 工具调用请求处理完成 - SessionID: mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=
2025-07-24 11:57:12.102[37m [debug] [llm.go:333] [0mDoLLmRequest goroutine开始 - SessionID: mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=, context状态: <nil>
2025-07-24 11:57:12.102[37m [debug] [llm.go:130] [0mAddLLMResponseChannel nest: <nil>
2025-07-24 11:57:12.102[37m [debug] [llm.go:146] [0mhandleLLMResponse start
2025-07-24 11:57:12.102[36m [info] [eino_llm.go:238] [0m[Eino-LLM] 开始处理Eino工具请求 - SessionID: mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=, tools: [0xc000141d10 0xc000141d40 0xc000141d70 0xc000141da0 0xc000141dd0]
2025-07-24 11:57:12.102[37m [debug] [eino_llm.go:250] [0mEinoLLMProvider.EinoResponseWithTools() streamable: true
2025-07-24 11:57:12.119[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:12.119[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:12.119[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:12.119[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:12.119[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:12.119[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:12.119[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:12.119[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:12.119[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:12.119[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:12.734[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: assistant: 好的
finish_reason: 
2025-07-24 11:57:12.735[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"好的","response_meta":{}}
2025-07-24 11:57:12.775[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : ，
finish_reason: 
2025-07-24 11:57:12.779[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"，","response_meta":{}}
2025-07-24 11:57:12.796[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 如果您
finish_reason: 
2025-07-24 11:57:12.796[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"如果您","response_meta":{}}
2025-07-24 11:57:12.964[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 有需要时可以
finish_reason: 
2025-07-24 11:57:12.965[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"有需要时可以","response_meta":{}}
2025-07-24 11:57:13.133[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 随时唤醒我，
finish_reason: 
2025-07-24 11:57:13.133[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"随时唤醒我，","response_meta":{}}
2025-07-24 11:57:13.259[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 晚安！
finish_reason: 
2025-07-24 11:57:13.261[36m [info] [llm.go:96] [0m收到message: {"role":"","content":"晚安！","response_meta":{}}
2025-07-24 11:57:13.262[36m [info] [llm.go:107] [0m耗时统计: llm工具首句: 1160 ms
2025-07-24 11:57:13.262[36m [info] [llm.go:109] [0m处理完整句子: 好的，如果您有需要时可以随时唤醒我，晚安！
2025-07-24 11:57:13.281[37m [debug] [llm.go:178] [0mLLM 响应: {Text:好的，如果您有需要时可以随时唤醒我，晚安！ IsStart:false IsEnd:false ToolCalls:[]}
2025-07-24 11:57:13.281[37m [debug] [doubao_ws.go:290] [0mdoubao websocket复用现有连接
2025-07-24 11:57:13.300[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:13.300[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:13.301[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:13.301[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:13.301[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:13.700[37m [debug] [audio_utils.go:288] [0mMP3格式: 16000 Hz, 2 通道
2025-07-24 11:57:13.701[37m [debug] [audio_utils.go:304] [0m将双声道音频转换为单声道输出
2025-07-24 11:57:13.703[36m [info] [audio_utils.go:336] [0mtts云端首帧耗时: 422 ms
2025-07-24 11:57:13.705[36m [info] [audio_utils.go:406] [0mtts云端->首帧解码完成耗时: 424 ms
2025-07-24 11:57:13.706[37m [debug] [tts.go:181] [0m发送 TTS 音频: 0 帧, len: 20
2025-07-24 11:57:13.736[37m [debug] [tts.go:181] [0m发送 TTS 音频: 1 帧, len: 32
2025-07-24 11:57:13.737[37m [debug] [tts.go:181] [0m发送 TTS 音频: 2 帧, len: 63
2025-07-24 11:57:13.737[37m [debug] [tts.go:181] [0m发送 TTS 音频: 3 帧, len: 102
2025-07-24 11:57:13.737[37m [debug] [tts.go:181] [0m发送 TTS 音频: 4 帧, len: 131
2025-07-24 11:57:13.738[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc0002344a0 call_288a4f6958db4289ab5562 function {exit_chat {}} map[]}]
finish_reason: 
2025-07-24 11:57:13.847[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
tool_calls: [{0xc0003ec108  function { } map[]}]
finish_reason: 
2025-07-24 11:57:13.847[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: : 
finish_reason: tool_calls
usage: &{426 27 453}
2025-07-24 11:57:13.848[37m [debug] [eino_llm.go:277] [0mstreamReader.Recv() message: <nil>
2025-07-24 11:57:13.848[36m [info] [eino_llm.go:349] [0m[Eino-LLM] Eino工具请求处理完成 - SessionID: mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=
2025-07-24 11:57:13.853[36m [info] [llm.go:96] [0m收到message: {"role":"assistant","content":"","tool_calls":[{"index":0,"id":"call_288a4f6958db4289ab5562","type":"function","function":{"name":"exit_chat","arguments":"{}"}}]}
2025-07-24 11:57:13.853[36m [info] [llm.go:130] [0m处理工具调用: [{Index:0xc0002344a0 ID:call_288a4f6958db4289ab5562 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 11:57:13.853[37m [debug] [llm.go:59] [0mfull Response with 5 tools, fullText: 好的，如果您有需要时可以随时唤醒我，晚安！
2025-07-24 11:57:14.361[37m [debug] [doubao_ws.go:248] [0m收到最后一个音频片段，共19个片段
2025-07-24 11:57:18.118[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:false ToolCalls:[{Index:0xc0002344a0 ID:call_288a4f6958db4289ab5562 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]}
2025-07-24 11:57:18.118[37m [debug] [llm.go:181] [0m获取到工具: [{Index:0xc0002344a0 ID:call_288a4f6958db4289ab5562 Type:function Function:{Name:exit_chat Arguments:{}} Extra:map[]}]
2025-07-24 11:57:18.118[37m [debug] [llm.go:178] [0mLLM 响应: {Text: IsStart:false IsEnd:true ToolCalls:[]}
2025-07-24 11:57:18.118[33m [warning] [llm.go:197] [0mredis client is nil
2025-07-24 11:57:18.118[33m [warning] [llm.go:201] [0mredis client is nil
2025-07-24 11:57:18.118[36m [info] [llm.go:249] [0m处理 1 个工具调用
2025-07-24 11:57:18.118[36m [info] [mcp_client.go:11] [0m查找工具: exit_chat (设备: 98:a3:16:d1:04:24)
2025-07-24 11:57:18.118[36m [info] [mcp_client.go:24] [0m找到本地工具: local_exit_chat
2025-07-24 11:57:18.118[36m [info] [llm.go:261] [0m进行工具调用请求: exit_chat, 参数: {}
2025-07-24 11:57:18.118[36m [info] [local_tools.go:80] [0m执行退出对话工具，参数: {}
2025-07-24 11:57:18.118[36m [info] [manager_registry.go:95] [0m通过注册表关闭设备 98:a3:16:d1:04:24 的ChatManager
2025-07-24 11:57:18.118[36m [info] [chat.go:145] [0m主动关闭断开连接, 设备 98:a3:16:d1:04:24
2025-07-24 11:57:18.118[36m [info] [local_tools.go:126] [0m设备 98:a3:16:d1:04:24 对话已退出，原因: 用户请求退出对话
2025-07-24 11:57:18.118[36m [info] [llm.go:274] [0m工具调用结果: {"device_id":"98:a3:16:d1:04:24","message":"对话已成功退出","reason":"用户请求退出对话","success":true}, 耗时: 0ms
2025-07-24 11:57:18.118[36m [info] [llm.go:279] [0m工具 exit_chat 标记为不回传结果给LLM，跳过回传
2025-07-24 11:57:18.118[36m [info] [llm.go:301] [0m所有工具都标记为不回传结果，跳过LLM处理
2025-07-24 11:57:18.118[37m [debug] [llm.go:229] [0mhandleLLMResponse end
2025-07-24 11:57:18.118[37m [debug] [llm.go:348] [0mDoLLmRequest 结束 - SessionID: mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=
2025-07-24 11:57:18.118[37m [debug] [session.go:565] [0mprocessChatText end
2025-07-24 11:57:18.118[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:18.118[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:18.118[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:18.118[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:18.118[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:18.118[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:18.118[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:18.118[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:18.118[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:18.118[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:18.281[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:18.281[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:57:18.281[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:18.281[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:18.281[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:57:18.281[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"listen","state":"start","mode":...
2025-07-24 11:57:18.281[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:57:18.282[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"listen","state":"start","mode":"auto"}
2025-07-24 11:57:18.283[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:57:18.283[36m [info] [session.go:134] [0m收到文本消息: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"listen","state":"start","mode":"auto"}
2025-07-24 11:57:18.283[36m [info] [session.go:412] [0m设备  拾音模式: auto
2025-07-24 11:57:18.283[37m [debug] [session.go:434] [0mOnListenStart start
2025-07-24 11:57:18.283[37m [debug] [session.go:439] [0mOnListenStart Ctx done, return
2025-07-24 11:57:18.283[37m [debug] [session.go:440] [0mOnListenStart end
2025-07-24 11:57:18.283[36m [info] [session.go:299] [0m设备  更新音频监听状态: start
2025-07-24 11:57:18.283[36m [info] [session.go:126] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 11:57:18.490[37m [debug] [session.go:147] [0m设备 98:a3:16:d1:04:24 recvCmd context cancel
2025-07-24 11:57:24.571[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:24.633[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:24.666[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:24.722[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:24.806[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:24.857[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:24.916[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.005[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.051[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.121[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.149[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.206[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.276[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.337[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.412[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.481[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.554[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.591[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.628[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.688[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.767[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.832[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.876[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:25.951[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.019[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.072[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.105[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.174[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.238[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.301[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.358[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.447[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.491[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.554[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.584[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.641[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.716[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.777[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.848[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.921[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:26.995[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.042[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.068[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.121[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.201[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.302[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.321[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.403[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.460[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.511[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.564[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.608[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.681[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.736[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.798[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.872[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.941[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:27.995[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.027[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.088[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.158[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.222[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.279[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.353[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.417[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.486[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.501[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.561[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.637[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.705[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.761[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.843[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.898[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.952[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:28.995[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.041[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.163[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.211[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.245[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.319[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.376[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.432[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.461[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.523[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.603[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.662[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.738[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.790[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.863[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.927[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:29.943[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.001[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.076[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.137[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.196[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.271[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.330[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.393[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.430[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.488[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.560[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.622[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.680[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.750[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.811[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.886[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.908[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:30.966[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.054[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.100[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.158[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.250[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.303[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.365[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.398[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.456[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.518[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.585[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.647[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.714[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.771[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.832[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.894[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:31.932[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:32.001[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:32.069[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:32.116[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:32.194[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:32.272[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:32.312[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:32.347[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:32.400[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:32.482[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:32.537[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:32.902[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:32.902[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:33.058[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:33.058[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:33.733[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:33.733[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:33.882[33m [warning] [udp_server.go:142] [0mudpSession.RecvChannel is full, addr: 192.168.7.45:61246
2025-07-24 11:57:34.803[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:34.804[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:34.804[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:34.804[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:34.804[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:35.455[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:35.455[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:57:35.456[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:35.458[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:35.458[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:57:35.458[36m [info] [device_hook.go:139] [0m消息内容: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"goodbye"}
2025-07-24 11:57:35.458[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:57:35.458[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"goodbye"}
2025-07-24 11:57:35.459[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:57:35.560[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:35.560[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:57:35.560[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:35.560[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:35.560[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:57:35.707[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:35.707[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:57:35.708[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:35.708[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:35.710[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:57:35.710[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:57:35.710[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:57:35.710[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":3,"error":{"message":"Method not implemented: ping"}}}
2025-07-24 11:57:35.710[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:57:35.784[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:57:35.784[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:57:35.784[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:57:35.784[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:57:35.784[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:57:35.784[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:57:35.784[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:57:35.785[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":4,"error":{"message":"Method not implemented: ping"}}}
2025-07-24 11:57:35.785[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:57:49.804[37m [debug] [device_manager.go:241] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 ping失败: transport error: mcp 接收消息超时
2025-07-24 11:57:50.561[37m [debug] [device_manager.go:241] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 ping失败: transport error: mcp 接收消息超时
2025-07-24 11:58:04.802[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 1
2025-07-24 11:58:04.803[37m [debug] [funasr.go:183] [0m关闭空闲连接，当前连接数: 0
2025-07-24 11:58:04.803[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:58:04.804[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:58:04.804[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:58:04.804[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:58:04.804[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:58:04.942[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:58:04.942[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:58:04.943[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:58:04.943[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:58:04.943[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:58:04.943[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:58:04.943[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:58:04.943[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":5,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 11:58:04.943[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:58:05.561[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:58:05.562[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:58:05.562[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:58:05.562[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:58:05.562[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:58:06.637[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:58:06.637[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:58:06.637[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:58:06.637[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:58:06.637[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:58:06.637[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:58:06.637[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:58:06.637[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":6,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 11:58:06.637[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:58:19.805[31m [error] [device_manager.go:219] [0m获取工具列表失败: transport error: mcp 接收消息超时
2025-07-24 11:58:19.805[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:58:19.805[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:58:19.805[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:58:19.806[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:58:19.806[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:58:19.926[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:58:19.926[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:58:19.926[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:58:19.926[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:58:19.926[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:58:19.926[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:58:19.926[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:58:19.928[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":7,"error":{"message":"Method not implemented: ping"}}}
2025-07-24 11:58:19.928[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:58:20.562[31m [error] [device_manager.go:219] [0m获取工具列表失败: transport error: mcp 接收消息超时
2025-07-24 11:58:20.563[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:58:20.564[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:58:20.564[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:58:20.564[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:58:20.564[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:58:20.647[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:58:20.647[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:58:20.647[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:58:20.647[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:58:20.647[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:58:20.647[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:58:20.647[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:58:20.649[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":8,"error":{"message":"Method not implemented: ping"}}}
2025-07-24 11:58:20.650[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:58:34.808[37m [debug] [device_manager.go:241] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 ping失败: transport error: mcp 接收消息超时
2025-07-24 11:58:34.808[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:58:34.808[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:58:34.808[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:58:34.808[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:58:34.808[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:58:34.883[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:58:34.884[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:58:34.884[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:58:34.884[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:58:34.884[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:58:34.884[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:58:34.884[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:58:34.884[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":9,"error":{"message":"Method not implemented: ping"}}}
2025-07-24 11:58:34.884[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:58:35.564[37m [debug] [device_manager.go:241] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 ping失败: transport error: mcp 接收消息超时
2025-07-24 11:58:35.566[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:58:35.566[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:58:35.566[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:58:35.566[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:58:35.566[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:58:35.596[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:58:35.597[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:58:35.597[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:58:35.597[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:58:35.597[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:58:35.597[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:58:35.597[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:58:35.597[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":10,"error":{"message":"Method not implemented: ping"}}}
2025-07-24 11:58:35.597[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:58:49.808[37m [debug] [device_manager.go:241] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 ping失败: transport error: mcp 接收消息超时
2025-07-24 11:58:50.567[37m [debug] [device_manager.go:241] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 ping失败: transport error: mcp 接收消息超时
2025-07-24 11:59:04.804[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:59:04.804[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:59:04.804[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:59:04.804[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:59:04.804[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:59:04.950[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:59:04.955[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:59:04.955[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:59:04.955[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:59:04.955[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:59:04.955[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:59:04.955[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:59:04.956[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":11,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 11:59:04.956[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:59:05.561[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:59:05.562[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:59:05.562[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:59:05.562[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:59:05.562[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:59:05.607[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:59:05.607[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:59:05.607[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:59:05.607[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:59:05.607[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:59:05.607[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:59:05.607[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:59:05.610[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":12,"result":{"tools":[{"name":"self.get_device_status","description":"Provides the real-time information of the device, including the current status of the audio speaker, screen, battery, network, etc.\nUse this tool for: \n1. Answering questions about current condition (e.g. what is the current volume of the audio speaker?)\n2. As the first step to control the device (e.g. turn up / down the volume of the audio speaker, etc.)","inputSchema":{"type":"object","properties":{}}},{"name":"self.audio_speaker.set_volume","description":"Set the volume of the audio speaker. If the current volume is unknown, you must call `self.get_device_status` tool first and then call this tool.","inputSchema":{"type":"object","properties":{"volume":{"type":"integer","minimum":0,"maximum":100}},"required":["volume"]}},{"name":"self.screen.set_brightness","description":"Set the brightness of the screen.","inputSchema":{"type":"object","properties":{"brightness":{"type":"integer","minimum":0,"maximum":100}},"required":["brightness"]}},{"name":"self.screen.set_theme","description":"Set the theme of the screen. The theme can be `light` or `dark`.","inputSchema":{"type":"object","properties":{"theme":{"type":"string"}},"required":["theme"]}}]}}}
2025-07-24 11:59:05.610[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:59:19.805[31m [error] [device_manager.go:219] [0m获取工具列表失败: transport error: mcp 接收消息超时
2025-07-24 11:59:19.806[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:59:19.806[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:59:19.806[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:59:19.806[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:59:19.806[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:59:19.935[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:59:19.936[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:59:19.936[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:59:19.936[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:59:19.936[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:59:19.936[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:59:19.936[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:59:19.936[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":13,"error":{"message":"Method not implemented: ping"}}}
2025-07-24 11:59:19.937[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:59:20.565[31m [error] [device_manager.go:219] [0m获取工具列表失败: transport error: mcp 接收消息超时
2025-07-24 11:59:20.572[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:59:20.573[36m [info] [device_hook.go:125] [0m客户端ID: xiaozhi_server
2025-07-24 11:59:20.574[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:59:20.574[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:59:20.574[36m [info] [device_hook.go:128] [0m主题: /p2p/device_sub/98_a3_16_d1_04_24
2025-07-24 11:59:20.748[36m [info] [device_hook.go:124] [0m=== 收到发布包 ===
2025-07-24 11:59:20.749[36m [info] [device_hook.go:125] [0m客户端ID: GID_test@@@98_a3_16_d1_04_24@@@68a8f59a-c535-44f5-9168-9689ad0e45df
2025-07-24 11:59:20.749[36m [info] [device_hook.go:126] [0m包类型: 3
2025-07-24 11:59:20.749[36m [info] [device_hook.go:127] [0m包ID: 0
2025-07-24 11:59:20.749[36m [info] [device_hook.go:128] [0m主题: device-server
2025-07-24 11:59:20.749[36m [info] [device_hook.go:137] [0m消息内容(前100字节): {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0"...
2025-07-24 11:59:20.750[36m [info] [device_hook.go:155] [0m==================
2025-07-24 11:59:20.751[37m [debug] [mqtt_udp_adapter.go:182] [0mmqtt handleMessage, topic: /p2p/device_public/98_a3_16_d1_04_24, payload: {"session_id":"mHEODHIYxqthLeq--T72yF8M0CG7m6aDyrt8kuhh3F0=","type":"mcp","payload":{"jsonrpc":"2.0","id":14,"error":{"message":"Method not implemented: ping"}}}
2025-07-24 11:59:20.751[37m [debug] [mqtt_udp_adapter.go:147] [0mgetDeviceSession, deviceId: 98:a3:16:d1:04:24
2025-07-24 11:59:27.633[36m [info] [device_manager.go:92] [0m设备 98:a3:16:d1:04:24 所有MCP连接都已断开，从池中移除
2025-07-24 11:59:27.634[36m [info] [device_manager.go:44] [0m设备 98:a3:16:d1:04:24 MCP客户端已移除并取消上下文
2025-07-24 11:59:34.807[37m [debug] [device_manager.go:241] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 ping失败: transport error: mcp 接收消息超时
2025-07-24 11:59:34.807[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
2025-07-24 11:59:35.571[37m [debug] [device_manager.go:241] [0m设备 iot_over_mcp_98:a3:16:d1:04:24 ping失败: transport error: mcp 接收消息超时
2025-07-24 11:59:35.571[36m [info] [device_manager.go:250] [0m设备 98:a3:16:d1:04:24 MCP会话上下文已取消，退出刷新和ping循环
